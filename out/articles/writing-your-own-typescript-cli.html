<!DOCTYPE html><html lang="en"><head><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/svg" sizes="32x32" href="/favicon.svg"/><link rel="icon" type="image/svg" sizes="16x16" href="/favicon.svg"/><link rel="mask-icon" href="/favicon.svg" color="#ffffff"/><link rel="manifest" href="/site.webmanifest"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="msapplication-TileColor" content="#007cf0"/><meta name="theme-color" content="#ffff"/><title>Writing Your Own TypeScript CLI</title><meta name="description" content="Writing CLIs feels like a super power💯 You can write one too! I&#x27;ll show you how to develop a CLI with TypeScript step by step and demonstrate how you can apply your CLI in CD/CI pipelines. We&#x27;re going to uncover the power of Google Lighthouse and many more amazing npm packages!"/><meta property="og:title" content="Writing Your Own TypeScript CLI"/><meta property="og:type" content="website"/><meta property="og:url" content="/articles/writing-your-own-typescript-cli"/><meta property="og:description" content="Writing CLIs feels like a super power💯 You can write one too! I&#x27;ll show you how to develop a CLI with TypeScript step by step and demonstrate how you can apply your CLI in CD/CI pipelines. We&#x27;re going to uncover the power of Google Lighthouse and many more amazing npm packages!"/><meta property="og:image" content="https://dawchihliou.github.io/optimized/writing-your-own-cli.png"/><meta property="og:image:type" content="image/png"/><meta property="og:image:width" content="1411"/><meta property="og:image:height" content="682"/><meta property="og:image:alt" content="Writing CLIs feels like a super power💯 You can write one too! I&#x27;ll show you how to develop a CLI with TypeScript step by step and demonstrate how you can apply your CLI in CD/CI pipelines. We&#x27;re going to uncover the power of Google Lighthouse and many more amazing npm packages!"/><meta name="next-head-count" content="20"/><link rel="preload" href="/_next/static/css/97c099ac227522ff.css" as="style"/><link rel="stylesheet" href="/_next/static/css/97c099ac227522ff.css" data-n-g=""/><link rel="preload" href="/_next/static/css/7787e07ad0df5e53.css" as="style"/><link rel="stylesheet" href="/_next/static/css/7787e07ad0df5e53.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-8f04beb4f49c15cb.js" defer=""></script><script src="/_next/static/chunks/framework-beb51d85c0b60541.js" defer=""></script><script src="/_next/static/chunks/main-7d0804cea530096c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-317be4c860b01243.js" defer=""></script><script src="/_next/static/chunks/pages/articles/writing-your-own-typescript-cli-1df63f71241570b0.js" defer=""></script><script src="/_next/static/ZF71WB00_tQIZCjxxwkYk/_buildManifest.js" defer=""></script><script src="/_next/static/ZF71WB00_tQIZCjxxwkYk/_ssgManifest.js" defer=""></script><script src="/_next/static/ZF71WB00_tQIZCjxxwkYk/_middlewareManifest.js" defer=""></script></head><body><div id="__next" data-reactroot=""><div id="outer-container"><header><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><button class="Nav_link__ZgDoZ" tabindex="-1">Home</button><button class="Nav_link__ZgDoZ" tabindex="-1">Now</button><button class="Nav_link__ZgDoZ" tabindex="-1">Articles</button><span class="bm-item Nav_pusher__93Gc6" style="display:block" tabindex="-1"></span><span class="bm-item Nav_divider__QD8Pt" style="display:block" tabindex="-1"></span><div class="bm-item Nav_profile__Kf2nU" style="display:block" tabindex="-1"><a href="https://www.linkedin.com/in/dawchihliou/" target="_blank" rel="noreferrer" aria-label="Link to Daw-Chih&#x27;s Linkedin profile" class="Nav_iconLink__z5y5Q"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M20.45175,20.45025 L16.89225,20.45025 L16.89225,14.88075 C16.89225,13.5525 16.86975,11.844 15.04275,11.844 C13.191,11.844 12.90825,13.2915 12.90825,14.7855 L12.90825,20.45025 L9.3525,20.45025 L9.3525,8.997 L12.765,8.997 L12.765,10.563 L12.81375,10.563 C13.2885,9.66225 14.4495,8.71275 16.18125,8.71275 C19.78575,8.71275 20.45175,11.08425 20.45175,14.169 L20.45175,20.45025 Z M5.33925,7.4325 C4.1955,7.4325 3.27375,6.50775 3.27375,5.36775 C3.27375,4.2285 4.1955,3.30375 5.33925,3.30375 C6.47775,3.30375 7.4025,4.2285 7.4025,5.36775 C7.4025,6.50775 6.47775,7.4325 5.33925,7.4325 L5.33925,7.4325 Z M7.11975,20.45025 L3.5565,20.45025 L3.5565,8.997 L7.11975,8.997 L7.11975,20.45025 Z M23.00025,0 L1.0005,0 C0.44775,0 0,0.44775 0,0.99975 L0,22.9995 C0,23.55225 0.44775,24 1.0005,24 L23.00025,24 C23.55225,24 24,23.55225 24,22.9995 L24,0.99975 C24,0.44775 23.55225,0 23.00025,0 L23.00025,0 Z"></path></svg></a><a href="https://github.com/DawChihLiou" target="_blank" rel="noreferrer" aria-label="Link to Daw-Chih&#x27;s GitHub profile" class="Nav_iconLink__z5y5Q"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a><a href="https://medium.com/@dawchihliou" target="_blank" rel="noreferrer" aria-label="Link to Daw-Chih&#x27;s Medium profile" class="Nav_iconLink__z5y5Q"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.84593838,5.88685595 C2.87575654,5.59224254 2.76340763,5.30104995 2.54341737,5.10276397 L0.302521008,2.4032473 L0.302521008,2 L7.2605042,2 L12.6386555,13.7949836 L17.3669469,2 L24,2 L24,2.4032473 L22.0840336,4.2402628 C21.9188563,4.36617057 21.8369199,4.57310892 21.8711485,4.77792587 L21.8711485,18.2755093 C21.8369199,18.4803262 21.9188563,18.6872645 22.0840336,18.8131723 L23.9551821,20.6501878 L23.9551821,21.0534351 L14.5434174,21.0534351 L14.5434174,20.6501878 L16.4817928,18.7683671 C16.6722689,18.5779447 16.6722689,18.5219382 16.6722689,18.2307041 L16.6722689,7.32062416 L11.2829132,21.0086299 L10.5546219,21.0086299 L4.28011204,7.32062416 L4.28011204,16.4945003 C4.22779746,16.8801958 4.35589372,17.2685069 4.62745097,17.5474239 L7.14845938,20.6053826 L7.14845938,21.0086299 L0,21.0086299 L0,20.6053826 L2.5210084,17.5474239 C2.79058848,17.2680445 2.91121535,16.8771576 2.84593838,16.4945003 L2.84593838,5.88685595 Z"></path></svg></a><a href="https://twitter.com/dawchihliou" target="_blank" rel="noreferrer" aria-label="Link to Daw-Chih&#x27;s Twitter" class="Nav_iconLink__z5y5Q"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M24,4.3086 C23.117,4.7006 22.168,4.9646 21.172,5.0836 C22.188,4.4746 22.969,3.5096 23.337,2.3596 C22.386,2.9246 21.332,3.3336 20.21,3.5556 C19.312,2.5976 18.032,1.9996 16.616,1.9996 C13.897,1.9996 11.692,4.2046 11.692,6.9236 C11.692,7.3096 11.736,7.6856 11.82,8.0456 C7.728,7.8406 4.099,5.8806 1.671,2.9006 C1.247,3.6286 1.004,4.4736 1.004,5.3766 C1.004,7.0846 1.873,8.5926 3.195,9.4756 C2.388,9.4486 1.628,9.2276 0.964,8.8596 L0.964,8.9206 C0.964,11.3066 2.661,13.2966 4.914,13.7486 C4.501,13.8626 4.065,13.9216 3.617,13.9216 C3.299,13.9216 2.991,13.8906 2.69,13.8336 C3.317,15.7896 5.135,17.2136 7.29,17.2536 C5.604,18.5736 3.481,19.3606 1.175,19.3606 C0.777,19.3606 0.385,19.3376 0,19.2926 C2.179,20.6886 4.767,21.5046 7.548,21.5046 C16.605,21.5046 21.557,14.0016 21.557,7.4946 C21.557,7.2816 21.552,7.0696 21.543,6.8586 C22.505,6.1636 23.34,5.2966 24,4.3086"></path></svg></a></div><div class="DarkmodeSwitch_container__uFGHQ" tabindex="0"><div class="DarkmodeSwitch_wrap__e71_4"></div></div></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-cross" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button></div></div></div><div><div class="bm-burger-button" style="z-index:1000"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-icon" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg><button style="position:absolute;left:0;top:0;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button></div></div></div></header><div class="Menubar_menubar__gvU4b"><div class="DarkmodeSwitch_container__uFGHQ" tabindex="0"><div class="DarkmodeSwitch_wrap__e71_4"></div></div><a href="https://github.com/DawChihLiou" target="_blank" rel="noreferrer"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a></div><div id="page-wrap"><article><div class="Article_container__q__L3"><div class="Article_wrap__LZypL"><h1 id="writing-your-own-typescript-cli">Writing Your Own TypeScript CLI</h1><img src="/optimized/writing-your-own-cli.webp" alt="Portfolio snapshot" width="100%" loading="lazy"/><h2 id="tldr">TL;DR</h2><ul><li>🍳 You can write a CLI with ease. It&#x27;s simpler than you might think:)</li><li>🗼 We&#x27;ll write a CLI together to generate a Lighthouse performance report.</li><li>🔦 You&#x27;ll see how to configure TypeScript, ESLint, and Prettier.</li><li>📚 You&#x27;ll see how to use some awesome libraries like <a href="https://github.com/chalk/chalk"><code>chalk</code></a> and <a href="https://github.com/tj/commander.js"><code>commander</code></a>.</li><li>🧑‍🔬 You&#x27;ll see how to spawn multiple processes.</li><li>🚀 You&#x27;ll see how to use your CLI in GitHub Actions.</li></ul><hr/><p>Writing CLIs feels like a super power, and you can write one too💯</p><p>I&#x27;ll show you how to develop a CLI with TypeScript step by step and demonstrate how you can apply your CLI in CD/CI pipelines.</p><p>This article covers three major topics:</p><ul><li><a href="#configuring-tooling">Setting up A TypeScript Project with ESLint and Prettier</a></li><li><a href="#writing-a-cli-to-run-lighthouse">Writing a CLI to Run Lighthouse in Multiple Process</a></li><li><a href="#using-the-cli-in-github-actions">Using the CLI in Action with GitHub Actions</a></li></ul><p>Feel free to jump to the parts that you&#x27;re interested in.</p><h2 id="real-world-use-case">Real-world Use Case</h2><p><a href="https://developers.google.com/web/tools/lighthouse/">Lighthouse</a> is one of the most popular dev tools to gain insight to webpage performances.
It offers a CLI and node module so we can run it programmatically.
However, you&#x27;ll notice the Lighthouse scores vary if you run it multiple times on the same webpage.
That&#x27;s because there&#x27;s a known <a href="https://developers.google.com/web/tools/lighthouse/variability">variability</a>.
There&#x27;re many factors that plays into the Lighthouse variability.
One of the recommended strategies to deal with variance is to run Lighthouse multiple times.</p><p>We&#x27;ll be working on a CLI to implement this strategy in this article. The implementation will cover:</p><ul><li>Running multiple Lighthouse analyses</li><li>Aggregating data and calculating the median scores</li></ul><p>I hope you&#x27;re excited!</p><hr/><p>This article will discuss one of the scripts in 🌈🌈🌈 <strong><a href="https://github.com/DawChihLiou/dx-scripts"><code>dx-scripts</code></a></strong>🌈🌈🌈</p><p>It&#x27;s available on <a href="https://www.npmjs.com/package/dx-scripts">npm</a>.
I recently wrote the first script in the library and there are more to come!
Feel free to install it and try it in your development workflow. Please give it a ⭐️ on <a href="https://github.com/DawChihLiou/dx-scripts">GitHub</a> if the scripts are useful:)</p><hr/><h2 id="peaking-the-projects-file-structure">Peaking The Project&#x27;s File Structure</h2><p>This is how the file structure will look like after configuring the tooling.</p><pre class="language-bash"><code class="language-bash">my-script
├── .eslintrc.js
├── .prettierrc.json
├── package.json
├── tsconfig.json
├── bin
└── src
    ├── utils.ts
    └── index.ts
</code></pre><p>The source files are located in the <code>/src</code> directory.
We&#x27;ll compile them and output <code>.js</code> files in <code>/bin</code> directory.</p><p>The <code>/bin</code> directory will be the entry point of the command when your users are using the CLI.
You&#x27;ll learn how to configure it in a bit.</p><h2 id="configuring-tooling">Configuring Tooling</h2><p>We&#x27;ll be using <a href="https://yarnpkg.com/">Yarn</a> as our package manager for this project.
Feel free to use <a href="https://www.npmjs.com/">npm</a> if you prefer.</p><p>Let&#x27;s initiate the project. We&#x27;ll create a directory called <code>my-script</code>:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">mkdir</span> my-script <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> my-script
</code></pre><p>At the project root, let&#x27;s create a <code>package.json</code> with Yarn:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> init
</code></pre><h3 id="configuring-typescript">Configuring TypeScript</h3><p>To install <a href="https://www.typescriptlang.org/">TypeScript</a> and the types for <a href="https://nodejs.org/en/">NodeJS</a>, run:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> --dev typescript @types/node
</code></pre><p>Now we are ready to configure TypeScript in the project.
We can initiate a <code>tsconfig.json</code> with <code>tsc</code>:</p><pre class="language-bash"><code class="language-bash">$ npx tsc --init
</code></pre><p>In order to compile the TypeScript code and output the result to the <code>/bin</code> directory, we need to specify it in the <code>compilerOptions</code> in <code>tsconfig.json</code>.</p><pre class="language-diff"><code class="language-diff">// tsconfig.json

{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &quot;compilerOptions&quot;: {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    &quot;outDir&quot;: &quot;./bin&quot;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">   /* rest of the default options */
</span><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><p>That&#x27;s it! Let&#x27;s test it.</p><p>At the project root, run the following command to create an <code>index.ts</code> file in <code>/src</code>.</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">mkdir</span> src <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> src/index.ts
</code></pre><p>In <code>index.ts</code>, we&#x27;ll put a simple <code>console.log</code> and run the TypeScript compiler to see if the compiled files are in the <code>/bin</code> directory.</p><pre class="language-ts"><code class="language-ts"><span class="token comment">// src/index.ts</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Hello from my-script👋&#x27;</span><span class="token punctuation">)</span>
</code></pre><p>Add a script to compile TypeScript with <code>tsc</code>.</p><pre class="language-diff"><code class="language-diff">// package.json

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> &quot;scripts&quot;: {
</span><span class="token prefix inserted">+</span><span class="token line">   &quot;tsc&quot;: &quot;tsc&quot;
</span><span class="token prefix inserted">+</span><span class="token line"> }
</span></span>
</code></pre><p>Then run:</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># compile `/src`</span>
$ <span class="token function">yarn</span> tsc
</code></pre><p>You should see an <code>index.js</code> file in the <code>/bin</code> directory.</p><p>Let&#x27;s execute the <code>/bin</code> directory from the project root,</p><pre class="language-bash"><code class="language-bash">$ node bin

<span class="token comment"># Hello from my-script 👋</span>
</code></pre><h3 id="configuring-eslint">Configuring ESLint</h3><p>Now we ready for <a href="https://eslint.org/">ESLint</a>. We can go ahead and install it:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> --dev eslint
</code></pre><p>ESLint is a very powerful linter.
It doesn&#x27;t come with TypeScript support so we&#x27;ll install a <a href="https://github.com/typescript-eslint/typescript-eslint/tree/6e159ee7cf8ef2028792cb8ee636cf6143fa967f/packages/parser">TypeScript parser</a>:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> --dev @typescript-eslint/parser @typescript-eslint/eslint-plugin
</code></pre><p>We also installed the <a href="https://github.com/typescript-eslint/typescript-eslint/tree/6e159ee7cf8ef2028792cb8ee636cf6143fa967f/packages/eslint-plugin"><code>@typescript-eslint/eslint-plugin</code></a>.
This is because we&#x27;ll need it to extend the ESLint rules for TypeScript-specific features.</p><p>Let&#x27;s configure eslint in the project. We&#x27;ll create a <code>.eslintrc.js</code> at the project root:</p><pre class="language-bash"><code class="language-bash"><span class="token function">touch</span> .eslintrc.js
</code></pre><p>Inside <code>.eslintrc.js</code>, we can configure eslint as following:</p><pre class="language-js"><code class="language-js"><span class="token comment">// .eslintrc.js</span>

module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  parser<span class="token operator">:</span> <span class="token string">&#x27;@typescript-eslint/parser&#x27;</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#x27;@typescript-eslint&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token keyword">extends</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#x27;plugin:@typescript-eslint/recommended&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><p>To understand the configuration a little more, we first used <code>@typescript-eslint/parser</code> to enable ESLint&#x27;s ability to understand TypeScript syntax.
Then we applied <code>@typescript-eslint/eslint-plugin</code> plugin to extend the rules.
Finally we enabled all the recommended rules form <code>@typescript-eslint/eslint-plugin</code>.</p><p>If you&#x27;re interested in learning more about the configuration, you can checkout the <a href="https://github.com/typescript-eslint/typescript-eslint/tree/main/packages/eslint-plugin#usage">official doc</a> for more details.</p><p>We can now add a linting script to <code>package.json</code>:</p><pre class="language-diff"><code class="language-diff">// package.json

{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &quot;scripts&quot;: {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    &quot;lint&quot;: &quot;eslint &#x27;**/*.{js,ts}&#x27; --fix&quot;,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><p>To run the script:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> lint
</code></pre><h3 id="configuring-prettier">Configuring Prettier</h3><p><a href="https://prettier.io/">Prettier</a> is a very powerful formatter.
It comes with a set of rules to format our code.
Sometimes the rules can conflict with ESLint rules so I&#x27;ll show you how to configure them.</p><p>First install Prettier and create a <code>.prettierrc.json</code> file at the project root to hold the configuration,</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> --dev --exact prettier <span class="token operator">&amp;&amp;</span> <span class="token function">touch</span> .prettierrc.json
</code></pre><p>You can edit <code>.prettierrc.json</code> and add your custom rules.
You can find <a href="https://prettier.io/docs/en/options.html">the options in the official doc</a>.</p><p>Here&#x27;s an example:</p><pre class="language-json"><code class="language-json"><span class="token comment">// .prettierrc.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;trailingComma&quot;</span><span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;singleQuote&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre><p>Prettier provides handy integration with ESLint.
We&#x27;ll follow the <a href="https://github.com/prettier/eslint-plugin-prettier#recommended-configuration">recommended configuration</a> from the official doc.</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> --dev eslint-config-prettier eslint-plugin-prettier
</code></pre><p>We&#x27;ll add the plugin at the last position in the <code>extensions</code> array.</p><pre class="language-diff"><code class="language-diff">// .eslintrc.js

module.exports = {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> extends: [
</span><span class="token prefix unchanged"> </span><span class="token line">   &#x27;plugin:@typescript-eslint/recommended&#x27;,
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    &#x27;plugin:prettier/recommended&#x27;,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> ],
</span></span>}
</code></pre><p>It&#x27;s very important that Prettier is the last extension.
By applying last, it disables all formatting-related ESLint rules so the conflicts will fall back to Prettier.</p><p>We can now add a <code>prettier</code> script to <code>package.json</code>:</p><pre class="language-diff"><code class="language-diff">// package.json

{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &quot;scripts&quot;: {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    &quot;prettier&quot;: &quot;prettier --write .&quot;
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><p>To run the script:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> prettier
</code></pre><h3 id="configuring-packagejson">Configuring <code>package.json</code></h3><p>We are almost ready with our configuration.
The only thing missing is a way to execute the project the way you would execute a command.
Instead of executing the <code>/bin</code> with <code>node</code>, we want to be able to call the command directly:</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># instead of &quot;node bin&quot;, we want to call the command by its name like this:</span>
$ my-script
</code></pre><p>How do we do that? First we need to add a <a href="https://en.wikipedia.org/wiki/Shebang_(Unix)">Shebang</a> on the top of our <code>src/index.ts</code>.</p><pre class="language-diff"><code class="language-diff"><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> #!/usr/bin/env node
</span></span>
console.log(&#x27;Hello from my-script👋&#x27;)
</code></pre><p>The Shebang is to inform Unix-like operating systems that this is NodeJS executable.
So we can call the script directly without specifying <code>node</code>.</p><p>Let&#x27;s compile again,</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> tsc
</code></pre><p>There&#x27;s another thing we need before it all works. We need to assign the executable right to the <code>bin/index.js</code>:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">chmod</span> u+x ./bin/index.js
</code></pre><p>Let&#x27;s give it a go:</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># execute directly</span>
$ ./bin/index.js

<span class="token comment"># Hello from my-script👋</span>
</code></pre><p>Nice, we are almost there.
The last thing is to create a symlink between the command and the executable.
First, we need to specify the <code>bin</code> property in <code>package.json</code> and point the command to the <code>bin/index.js</code>.</p><pre class="language-diff"><code class="language-diff">// package.json

{
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  &quot;bin&quot;: {
</span><span class="token prefix inserted">+</span><span class="token line">    &quot;my-script&quot;: &quot;./bin/index.js&quot;
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span></span>}
</code></pre><p>Second, create a symlink with Yarn at the project root:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">link</span>

<span class="token comment"># You can always unlink: &quot;yarn unlink my-script&quot;</span>
</code></pre><p>Let&#x27;s see if it works🤩</p><pre class="language-bash"><code class="language-bash">$ my-script

<span class="token comment"># Hello from my-script👋</span>
</code></pre><p>It works🎉🎉🎉</p><p>Just to make the development easier, we&#x27;ll add a couple of scripts in <code>package.json</code>:</p><pre class="language-diff"><code class="language-diff">// package.json

{
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> &quot;scripts&quot;: {
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    &quot;build&quot;: &quot;yarn tsc &amp;&amp; yarn chmod&quot;,
</span><span class="token prefix inserted">+</span><span class="token line">    &quot;chmod&quot;: &quot;chmod u+x ./bin/index.js&quot;,
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> }
</span></span>}
</code></pre><p>Now we can run <code>yarn build</code> to compile and automatically assign the executable right to the entry file.</p><h2 id="writing-a-cli-to-run-lighthouse">Writing a CLI to Run Lighthouse</h2><p>It&#x27;s time to implement our core logic.
We&#x27;ll explore a few handy npm packages to help us write the CLI and we&#x27;ll dive into the magic of Lighthouse.</p><h3 id="coloring-consolelog-with-chalk">Coloring <code>console.log</code> with <code>chalk</code></h3><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> chalk@4.1.2
</code></pre><p>Make sure you are installing <code>chalk 4</code>. <a href="https://github.com/chalk/chalk/releases/tag/v5.0.0"><code>chalk 5</code> is pure ESM</a> and we won&#x27;t be able to use it with TypeScript <a href="https://github.com/microsoft/TypeScript/issues/46452">until TypeScript 4.6 is released</a>.</p><p><a href="https://github.com/chalk/chalk"><code>chalk</code></a> gives colors to your <code>console.log</code>. For example:</p><pre class="language-ts"><code class="language-ts"><span class="token comment">// src/index.ts</span>

<span class="token keyword">import</span> chalk <span class="token keyword">from</span> <span class="token string">&#x27;chalk&#x27;</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>chalk<span class="token punctuation">.</span><span class="token method function property-access">green</span><span class="token punctuation">(</span><span class="token string">&#x27;Hello from my-script👋&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>Now run <code>yarn build &amp;&amp; my-script</code> at your project root and see the log.</p><p>Let&#x27;s use <code>chalk</code> in a more meaningful way.
<a href="https://web.dev/performance-scoring/#color-coding">Lighthouse performane scores are color coded</a>.
We can write a utility function that shows the display value with a color based on the performance score.</p><pre class="language-ts"><code class="language-ts"><span class="token comment">// src/utils.ts</span>

<span class="token keyword">import</span> chalk <span class="token keyword">from</span> <span class="token string">&#x27;chalk&#x27;</span>

<span class="token doc-comment comment">/**
 * Coloring display value based on Lighthouse score.
 *
 * - 0 to 0.49 (red): Poor
 * - 0.5 to 0.89 (orange): Needs Improvement
 * - 0.9 to 1 (green): Good
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">draw</span><span class="token punctuation">(</span>score<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&gt;=</span> <span class="token number">0.9</span> <span class="token operator">&amp;&amp;</span> score <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> chalk<span class="token punctuation">.</span><span class="token method function property-access">green</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (Good)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&gt;=</span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> score <span class="token operator">&lt;</span> <span class="token number">0.9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> chalk<span class="token punctuation">.</span><span class="token method function property-access">yellow</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (Needs Improvement)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> chalk<span class="token punctuation">.</span><span class="token method function property-access">red</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>value<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> (Poor)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Use it in <code>src/index.ts</code> and try log something with <code>draw()</code> to see the result.</p><pre class="language-ts"><code class="language-ts"><span class="token comment">// src/index.ts</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span> draw <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;./utils&#x27;</span>

<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Perf score is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">draw</span><span class="token punctuation">(</span><span class="token number">0.64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</code></pre><h3 id="designing-a-command-with-commander">Designing A Command with <code>commander</code></h3><p>To make our CLI interactive, we need to be able to read user inputs and parse them.
<a href="https://github.com/tj/commander.js"><code>commander</code></a> is a descriptive way of defining a interface.
We can implement our interface in a very clean and documentary fashion.</p><p>How do we want the users to interact with the CLI is to simply pass a URL for Lighthouse to run.
We also want to pass in an option to specify how many times Lighthouse should run on the URL.
Like this:</p><pre class="language-bash"><code class="language-bash"><span class="token comment"># without an option</span>
$ my-script https://dawchihliou.github.io/

<span class="token comment"># with an option</span>
$ my-script https://dawchihliou.github.io/ --iteration<span class="token operator">=</span><span class="token number">3</span>
</code></pre><p>Let&#x27;s see how quickly we can implement our design with <code>commander</code>.</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> commander
</code></pre><p>Let&#x27;s clear the <code>src/index.ts</code> and start fresh:</p><p><code>src/index.ts</code></p><pre class="language-ts"><code class="language-ts">#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>bin<span class="token operator">/</span>env node

<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token maybe-class-name">Command</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#x27;commander&#x27;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> program <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token maybe-class-name">Command</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  program
    <span class="token punctuation">.</span><span class="token method function property-access">argument</span><span class="token punctuation">(</span><span class="token string">&#x27;&lt;url&gt;&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;Lighthouse will run the analysis on the URL.&#x27;</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">option</span><span class="token punctuation">(</span>
      <span class="token string">&#x27;-i, --iteration &lt;type&gt;&#x27;</span><span class="token punctuation">,</span>
      <span class="token string">&#x27;How many times Lighthouse should run the analysis per URL&#x27;</span><span class="token punctuation">,</span>
      <span class="token string">&#x27;5&#x27;</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token method function property-access">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> <span class="token punctuation">[</span>url<span class="token punctuation">]</span> <span class="token operator">=</span> program<span class="token punctuation">.</span><span class="token property-access">args</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> program<span class="token punctuation">.</span><span class="token method function property-access">opts</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">url: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, iteration: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>options<span class="token punctuation">.</span><span class="token property-access">iteration</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p>We first instantiated a <code>Command</code> and we used the instance <code>program</code> to define:</p><ul><li>an <a href="https://github.com/tj/commander.js#command-arguments"><code>required argument</code></a>: we gave it a name <code>url</code> and a description</li><li>an <a href="https://github.com/tj/commander.js#options"><code>option</code></a>: we gave it a short flag and a long flag, a description, and a default value</li></ul><p>To consume the argument and option, we first parse the command and log the variables.</p><p>Now we can run the command and observe the log.</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> build

<span class="token comment"># without an option</span>
$ my-script https://dawchihliou.github.io/

<span class="token comment"># url: https://dawchihliou.github.io/, iteration: 5</span>

<span class="token comment"># with an option</span>
$ my-script https://dawchihliou.github.io/ --iteration<span class="token operator">=</span><span class="token number">3</span>
<span class="token comment"># or</span>
$ my-script https://dawchihliou.github.io/ -i <span class="token number">3</span>

<span class="token comment"># url: https://dawchihliou.github.io/, iteration: 3</span>
</code></pre><p>Very cool right?!
Another cool feature is that <code>commander</code> automatically generates a <a href="https://github.com/tj/commander.js#automated-help"><code>help</code></a> to print the help information.</p><pre class="language-bash"><code class="language-bash">$ my-script --help
</code></pre><h3 id="running-multiple-lighthouse-analyses-in-separate-os-processes">Running Multiple Lighthouse Analyses in Separate OS Processes</h3><p>We learned how to parse user inputs in the previous section. It&#x27;s time to dive into the core of the CLI.</p><p>The recommendation for running multiple Lighthouse is to run them in <a href="https://github.com/GoogleChrome/lighthouse/issues/7187">separate processes</a> to remove the risk of interference.
<a href="https://github.com/moxystudio/node-cross-spawn"><code>cross-spawn</code></a> is a cross platform solution for spawning processes.
We will use it to synchronously spawn new processes to run Lighthouse.</p><p>To install <code>cross-spawn</code>:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> cross-spawn
$ <span class="token function">yarn</span> <span class="token function">add</span> --dev @types/cross-spawn

<span class="token comment"># Let&#x27;s install lighthouse too✨</span>
<span class="token function">yarn</span> <span class="token function">add</span> lighthouse
</code></pre><p>Let&#x27;s edit <code>src/index.ts</code>:</p><pre class="language-diff"><code class="language-diff">import { Command } from &#x27;commander&#x27;
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> import spawn from &#x27;cross-spawn&#x27;
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const lighthouse = require.resolve(&#x27;lighthouse/lighthouse-cli&#x27;)
</span></span>
async function run() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // ...
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">  console.log(`url: ${url}, iteration: ${options.iteration}`)
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  console.log(
</span><span class="token prefix inserted">+</span><span class="token line">    `🗼 Running Lighthouse for ${url}. It will take a while, please wait...`
</span><span class="token prefix inserted">+</span><span class="token line">  )
</span><span class="token prefix inserted">+</span><span class="token line">  const results = []
</span><span class="token prefix inserted">+</span><span class="token line">
</span><span class="token prefix inserted">+</span><span class="token line">  for (let i = 0; i &lt; options.iteration; i++) {
</span><span class="token prefix inserted">+</span><span class="token line">    const { status, stdout } = spawn.sync(
</span><span class="token prefix inserted">+</span><span class="token line">      process.execPath, [
</span><span class="token prefix inserted">+</span><span class="token line">      lighthouse,
</span><span class="token prefix inserted">+</span><span class="token line">      url,
</span><span class="token prefix inserted">+</span><span class="token line">      &#x27;--output=json&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">      &#x27;--chromeFlags=--headless&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">      &#x27;--only-categories=performance&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">    ])
</span><span class="token prefix inserted">+</span><span class="token line">
</span><span class="token prefix inserted">+</span><span class="token line">    if (status !== 0) {
</span><span class="token prefix inserted">+</span><span class="token line">      continue
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span><span class="token prefix inserted">+</span><span class="token line">
</span><span class="token prefix inserted">+</span><span class="token line">    results.push(JSON.parse(stdout.toString()))
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span></span>}
</code></pre><p>In the code, we spawn new processes multiple times based on user input.
In each process, we ran Lighthouse performance analysis with headless Chrome and collect the the JSON data.
The <code>result</code> variable will hold an array of independent performance data in string.
The next step is to aggregate the data and calculate the most reliable performance scores.</p><p>If you implement the code above, you&#x27;ll see a linting error about <code>require</code>.
<code>require.resolve</code> resolves the path to a module instead of the module itself.
In this article, we&#x27;ll allow the <code>@typescript-eslint/no-var-requires</code> rule in <code>.eslintrc.js</code> to compile.</p><pre class="language-diff"><code class="language-diff">// .eslintrc.js

module.exports = {
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  rules: {
</span><span class="token prefix inserted">+</span><span class="token line">    // allow require
</span><span class="token prefix inserted">+</span><span class="token line">    &#x27;@typescript-eslint/no-var-requires&#x27;: 0,
</span><span class="token prefix inserted">+</span><span class="token line">  },
</span></span>}
</code></pre><h3 id="calculating-reliable-lighthouse-scores">Calculating Reliable Lighthouse Scores</h3><p>One strategy is to aggregate the reports by calculating the median.
Lighthouse provide a internal functionality <a href="https://github.com/GoogleChrome/lighthouse/blob/master/lighthouse-core/lib/median-run.js"><code>computeMedianRun</code></a>.
Let&#x27;s use it</p><pre class="language-diff"><code class="language-diff">// src/index.ts

<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> // For simplicity, we use require here because lighthouse doesn&#x27;t provide type declaration.
</span><span class="token prefix inserted">+</span><span class="token line"> const {
</span><span class="token prefix inserted">+</span><span class="token line">   computeMedianRun,
</span><span class="token prefix inserted">+</span><span class="token line"> } = require(&#x27;lighthouse/lighthouse-core/lib/median-run.js&#x27;)
</span></span>
async function run() {
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line"> // ...
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   const median = computeMedianRun(results)
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   console.log(`\n${chalk.green(&#x27;✔&#x27;)} Report is ready for ${median.finalUrl}`)
</span><span class="token prefix inserted">+</span><span class="token line">   console.log(
</span><span class="token prefix inserted">+</span><span class="token line">     `🗼 Median performance score: ${draw(
</span><span class="token prefix inserted">+</span><span class="token line">       median.categories.performance.score,
</span><span class="token prefix inserted">+</span><span class="token line">       median.categories.performance.score * 100
</span><span class="token prefix inserted">+</span><span class="token line">     )}`
</span><span class="token prefix inserted">+</span><span class="token line">   )
</span></span>
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">   const primaryMatrices = [
</span><span class="token prefix inserted">+</span><span class="token line">     &#x27;first-contentful-paint&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">     &#x27;interactive&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">     &#x27;speed-index&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">     &#x27;total-blocking-time&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">     &#x27;largest-contentful-paint&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">     &#x27;cumulative-layout-shift&#x27;,
</span><span class="token prefix inserted">+</span><span class="token line">   ]
</span><span class="token prefix inserted">+</span><span class="token line">
</span><span class="token prefix inserted">+</span><span class="token line">   primaryMatrices.map((matrix) =&gt; {
</span><span class="token prefix inserted">+</span><span class="token line">     const { title, displayValue, score } = median.audits[matrix]
</span><span class="token prefix inserted">+</span><span class="token line">     console.log(`🗼 Median ${title}: ${draw(score, displayValue)}`)
</span><span class="token prefix inserted">+</span><span class="token line">   })
</span></span>}
</code></pre><p>Under the hood, <code>computeMedianRun</code> returns the score that&#x27;s closest to the median of the First Contentful Paint and the median of the Time to Interactive.
It&#x27;s because they represent the earliest and the latest moments in the page initialization lifecycle.
It&#x27;s a more reliable way to determine the median than the naive approach by finding the median from a single measurement.</p><p>Now try the command again and see the result!</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> build <span class="token operator">&amp;&amp;</span> my-script https://dawchihliou.github.io --iteration<span class="token operator">=</span><span class="token number">3</span>
</code></pre><img src="/optimized/command-line.webp" alt="Screenshot of my-script final output" width="100%" loading="lazy"/><p>Walla🎉</p><h2 id="using-the-cli-in-github-actions">Using the CLI in GitHub Actions</h2><p>Our implementation is done.
Let&#x27;s use the CLI in an automated workflow so we can benchmark the performance in a CD/CI pipeline.</p><p>First, let&#x27;s publish the package on npm (hypothetically).</p><p>I published a npm package <strong><a href="https://github.com/DawChihLiou/dx-scripts/"><code>dx-scripts</code></a></strong> that includes the production-ready version of <code>my-script</code>.
We will write the GitHub Actions workflow with <code>dx-scripts</code> to illustrate.</p><h3 id="publishing-on-npm-an-example">Publishing on npm (an example)</h3><p>We&#x27;ll add a <code>files</code> property in <code>package.json</code> to publish the <code>/bin</code> directory.</p><pre class="language-diff"><code class="language-diff">// package.json

{
<span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">  &quot;files&quot;: [&quot;bin&quot;],
</span></span>}
</code></pre><p>Then simply run:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> publish
</code></pre><p>Now the package is on npm (hypothetically)!</p><h3 id="writing-a-workflow">Writing A Workflow</h3><p>Let&#x27;s discuss the workflow. We want the workflow to:</p><ul><li>run on a pull request when there&#x27;s an update</li><li>run the Lighthouse performance analysis against a feature branch preview URL</li><li>notify the pull request with the analysis report</li></ul><p>So after the workflow is successfully completed, you&#x27;ll see a comment from GitHub Action Bot with your Lighthouse scores.</p><p>To focus on the application of our CLI, I&#x27;ll hard-code the feature branch preview URL in the workflow.</p><p>In your application repository, install <code>dx-scripts</code>:</p><pre class="language-bash"><code class="language-bash">$ <span class="token function">yarn</span> <span class="token function">add</span> --dev dx-scripts
</code></pre><p>Add a <code>lighthouse-dev-ci.yaml</code> to your GitHub workflows directory:</p><pre class="language-yaml"><code class="language-yaml"><span class="token comment"># .github/workflows/lighthouse-dev-ci.yaml</span>

<span class="token key atrule">name</span><span class="token punctuation">:</span> Lighthouse CI

<span class="token key atrule">on</span><span class="token punctuation">:</span> pull_request

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">lighthouse</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
      <span class="token comment"># You can substitute the hardcoded preview url with your preview url</span>
      <span class="token key atrule">preview_url</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//dawchihliou.github.io/
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v2

      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">&#x27;16.x&#x27;</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies
        <span class="token key atrule">run</span><span class="token punctuation">:</span> yarn

      <span class="token comment"># You can add your steps here to create a preview</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run Lighthouse
        <span class="token key atrule">id</span><span class="token punctuation">:</span> lighthouse
        <span class="token key atrule">shell</span><span class="token punctuation">:</span> bash
        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
          lighthouse=$(npx dx-scripts lighthouse $preview_url)
          lighthouse=&quot;${lighthouse//&#x27;%&#x27;/&#x27;%25&#x27;}&quot;
          lighthouse=&quot;${lighthouse//$&#x27;\n&#x27;/&#x27;%0A&#x27;}&quot;
          lighthouse=&quot;${lighthouse//$&#x27;\r&#x27;/&#x27;%0D&#x27;}&quot;
          echo &quot;::set-output name=lighthouse_report::$lighthouse&quot;</span>

      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Notify PR
        <span class="token key atrule">uses</span><span class="token punctuation">:</span> wow<span class="token punctuation">-</span>actions/auto<span class="token punctuation">-</span>comment@v1
        <span class="token key atrule">with</span><span class="token punctuation">:</span>
          <span class="token key atrule">GITHUB_TOKEN</span><span class="token punctuation">:</span> $<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.GITHUB_TOKEN <span class="token punctuation">}</span><span class="token punctuation">}</span>
          <span class="token key atrule">pullRequestSynchronize</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
            👋 @{{ author }},</span>

            Here is your Lighthouse performance overview🎉

            ```
            $<span class="token punctuation">{</span><span class="token punctuation">{</span> steps.lighthouse.outputs.lighthouse_report <span class="token punctuation">}</span><span class="token punctuation">}</span>
            ```
</code></pre><p>In the &quot;Run Lighthouse&quot; step, we ran the <code>dx-script lighthouse</code> CLI, substitute the special characters in order to print multi-line output, and we set the output in a variable <code>lighthouse_report</code>.
In the &quot;Notify PR&quot; step, we wrote a comment with the output from the &quot;Run Lighthouse&quot; step and use the <a href="https://github.com/marketplace/actions/auto-comment"><code>wow-actions/auto-comment</code> </a> action to post the comment.</p><img src="/optimized/pr-comment.webp" alt="Screenshot of a PR comment posted from the Lighthouse CI" width="100%" loading="lazy"/><p>That&#x27;s it! What a journey‍.
It&#x27;s amazing that you followed all the way through.</p><h2 id="to-sum-up">To Sum up</h2><p>Writing a CLI is not too hard, right?😎
Let&#x27;s have a look at all the things we&#x27;ve covered:</p><ul><li>configuring TypeScript</li><li>configuring ESLint</li><li>configuring Prettier</li><li>executing your command locally</li><li>coloring logs with <code>chalk</code></li><li>defining your command with <code>commander</code></li><li>spawning processes</li><li>executing Lighthouse CLI</li><li>using Lighthouse&#x27;s internal library to calculate median performance scores</li><li>publish your command as a npm package</li><li>applying your command to a GitHub Action workflow</li></ul><p>Now the super power is yours too🚀</p><hr/><p>Here you have it! I hope you find it useful. Thanks for reading through🙌</p><p>Please share this article so that more people who&#x27;re looking for inspirations can see it.</p><p>Feel free to connect with me on <a href="https://twitter.com/dawchihliou">twitter</a>!</p><p>If you&#x27;re interested in reading more about image optimization to boost your performance score, take a look at my previous article <a href="/articles/use-webp-for-better-ux">&quot;Using WebP for Better User Experience&quot;</a>.
There we discussed one of the modern image formats that greatly reduces the size of your images without sacrificing quality.</p><p>If you&#x27;re wondering how to test Redux Observable, I wrote an article <a href="https://itnext.io/better-marble-test-70c7676a1e2">&quot;Writing Better Marble Tests for Redux Observable and TypeScript&quot;</a> just for you.
It&#x27;s a comprehensive guide to walk you through the thought process.</p><p>If you’re a fan of functional programming, check out <a href="https://medium.com/@dawchihliou/intuitive-transducer-in-javascript-f358d3fe53d">this article that I wrote about Transducers</a>.
It’s a step by step reasoning on writing a transducer and it touches on key ideas about functional programming.</p><p>Happy coding!</p><article class="Author_wrap__s8DeE"><img src="/optimized/portrait-sm.png" alt="Daw-Chih Liou" class="Author_avatar__j6KIn" loading="lazy"/><div><a href="https://dawchihliou.github.io/"><span>Daw-Chih Liou</span></a><p>Daw-Chih is a software engineer, UX advocate, and mentor who is dedicated to Web engineering. His background in Human Centered Computing has led him to work with startups and public companies across North America, Asia, and Europe. He is passionate about meeting business trajectory with user journey and utilizing engineering architecture and performance monitoring to provide optimal user experience.</p></div></article></div></div></article><footer class="Footer_footer__1IwEk"><div class="Footer_wrap__FVCTX"><div class="Footer_resources__fG_vu"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">💚</span>This site is built with</p><p><a href="https://nextjs.org/" target="_blank" rel="noreferrer">Next.js</a></p><p><a href="https://github.com/css-modules/css-modules" target="_blank" rel="noreferrer">CSS Modules</a></p><p><a href="https://react-icons.github.io/react-icons/" target="_blank" rel="noreferrer">React Icons</a></p><p><a href="https://mdxjs.com/" target="_blank" rel="noreferrer">MDX</a></p></div><div class="Footer_contact__9GJn6"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">🦄</span>Where to find me</p><p><a href="https://www.linkedin.com/in/dawchihliou/" target="_blank" rel="noreferrer">Linkedin</a></p><p><a href="https://github.com/DawChihLiou" target="_blank" rel="noreferrer">GitHub</a></p><p><a href="https://medium.com/@dawchihliou" target="_blank" rel="noreferrer">Medium</a></p><p><a href="https://twitter.com/dawchihliou" target="_blank" rel="noreferrer">Twitter</a></p></div><div class="Footer_sitemap__92ono"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">🗺</span>Sitemap</p><a href="/">Home</a><a href="/now">Now</a><a href="/articles">Articles</a><a href="/#">RSS Feed to The Articles <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div><div class="Footer_copyright__vZZRL">© <!-- -->2022<!-- --> <a href="https://github.com/DawChihLiou" target="_blank" rel="noreferrer">Daw-Chih Liou</a></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/articles/writing-your-own-typescript-cli","query":{},"buildId":"ZF71WB00_tQIZCjxxwkYk","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>