<!DOCTYPE html><html lang="en"><head><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/svg" sizes="32x32" href="/favicon.svg"/><link rel="icon" type="image/svg" sizes="16x16" href="/favicon.svg"/><link rel="mask-icon" href="/favicon.svg" color="#ffffff"/><link rel="manifest" href="/site.webmanifest"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="msapplication-TileColor" content="#007cf0"/><meta name="theme-color" content="#ffff"/><title>Optimize Google Cloud BigQuery and Control Cost</title><meta name="description" content="I unknowingly blew $3,000 in 6 hours on one query in Google Cloud BigQuery. Here&#x27;s why and 3 easy steps to optimize the cost."/><meta name="robots" content="follow, index"/><link rel="canonical" href="https://dawchihliou.github.io/articles/optimize-google-cloud-bigquery-and-control-cost"/><meta itemProp="name" content="Optimize Google Cloud BigQuery and Control Cost"/><meta itemProp="description" content="I unknowingly blew $3,000 in 6 hours on one query in Google Cloud BigQuery. Here&#x27;s why and 3 easy steps to optimize the cost."/><meta itemProp="image" content="https://dawchihliou.github.io/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/hero.png"/><meta property="og:title" content="Optimize Google Cloud BigQuery and Control Cost"/><meta property="og:type" content="website"/><meta property="og:url" content="https://dawchihliou.github.io/articles/optimize-google-cloud-bigquery-and-control-cost"/><meta property="og:description" content="I unknowingly blew $3,000 in 6 hours on one query in Google Cloud BigQuery. Here&#x27;s why and 3 easy steps to optimize the cost."/><meta property="og:image" content="https://dawchihliou.github.io/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/hero.png"/><meta property="og:image:type" content="image/png"/><meta property="og:image:width" content="1400"/><meta property="og:image:height" content="700"/><meta property="og:image:alt" content="I unknowingly blew $3,000 in 6 hours on one query in Google Cloud BigQuery. Here&#x27;s why and 3 easy steps to optimize the cost."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@dawchihliou"/><meta name="twitter:creator" content="@dawchihliou"/><meta name="twitter:title" content="Optimize Google Cloud BigQuery and Control Cost"/><meta name="twitter:description" content="I unknowingly blew $3,000 in 6 hours on one query in Google Cloud BigQuery. Here&#x27;s why and 3 easy steps to optimize the cost."/><meta name="twitter:image" content="https://dawchihliou.github.io/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/hero.webp"/><meta property="article:published_time" content="2023-04-14T00:00:00.000Z"/><meta property="article:section" content="Article Section"/><meta property="article:tag" content="Article Tag"/><meta name="next-head-count" content="34"/><link rel="preload" href="/_next/static/css/f4214c3b71874d65.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f4214c3b71874d65.css" data-n-g=""/><link rel="preload" href="/_next/static/css/54ba867c7255694d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/54ba867c7255694d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-010ff0b6bbe5ac8f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5784eb5f9f6cd23e.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bslug%5D-9a8f919cad4c24e6.js" defer=""></script><script src="/_next/static/GGkAJYd5lItu4-AZArGVU/_buildManifest.js" defer=""></script><script src="/_next/static/GGkAJYd5lItu4-AZArGVU/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div id="outer-container"><header><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div><div class="bm-burger-button" style="z-index:1000"><button id="react-burger-menu-btn" style="position:absolute;left:0;top:0;z-index:1;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-icon" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s" aria-hidden="true"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/"><button class="Nav_button__YJwKE" tabindex="-1">Home</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/articles"><button class="Nav_button__YJwKE" tabindex="-1">Articles</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/work"><button class="Nav_button__YJwKE" tabindex="-1">Work</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/now"><button class="Nav_button__YJwKE" tabindex="-1">Now</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/expertise"><button class="Nav_button__YJwKE" tabindex="-1">Expertise</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/contact"><button class="Nav_button__YJwKE" tabindex="-1">Contact</button></a><span class="bm-item Nav_pusher__93Gc6" style="display:block" tabindex="-1"></span><span class="bm-item Nav_divider__QD8Pt" style="display:block" tabindex="-1"></span><div class="bm-item Nav_profile__Kf2nU" style="display:block" tabindex="-1"><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Linkedin profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M20.45175,20.45025 L16.89225,20.45025 L16.89225,14.88075 C16.89225,13.5525 16.86975,11.844 15.04275,11.844 C13.191,11.844 12.90825,13.2915 12.90825,14.7855 L12.90825,20.45025 L9.3525,20.45025 L9.3525,8.997 L12.765,8.997 L12.765,10.563 L12.81375,10.563 C13.2885,9.66225 14.4495,8.71275 16.18125,8.71275 C19.78575,8.71275 20.45175,11.08425 20.45175,14.169 L20.45175,20.45025 Z M5.33925,7.4325 C4.1955,7.4325 3.27375,6.50775 3.27375,5.36775 C3.27375,4.2285 4.1955,3.30375 5.33925,3.30375 C6.47775,3.30375 7.4025,4.2285 7.4025,5.36775 C7.4025,6.50775 6.47775,7.4325 5.33925,7.4325 L5.33925,7.4325 Z M7.11975,20.45025 L3.5565,20.45025 L3.5565,8.997 L7.11975,8.997 L7.11975,20.45025 Z M23.00025,0 L1.0005,0 C0.44775,0 0,0.44775 0,0.99975 L0,22.9995 C0,23.55225 0.44775,24 1.0005,24 L23.00025,24 C23.55225,24 24,23.55225 24,22.9995 L24,0.99975 C24,0.44775 23.55225,0 23.00025,0 L23.00025,0 Z"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou" aria-label="Link to Daw-Chih&#x27;s GitHub profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://medium.com/@dawchihliou" aria-label="Link to Daw-Chih&#x27;s Medium profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.84593838,5.88685595 C2.87575654,5.59224254 2.76340763,5.30104995 2.54341737,5.10276397 L0.302521008,2.4032473 L0.302521008,2 L7.2605042,2 L12.6386555,13.7949836 L17.3669469,2 L24,2 L24,2.4032473 L22.0840336,4.2402628 C21.9188563,4.36617057 21.8369199,4.57310892 21.8711485,4.77792587 L21.8711485,18.2755093 C21.8369199,18.4803262 21.9188563,18.6872645 22.0840336,18.8131723 L23.9551821,20.6501878 L23.9551821,21.0534351 L14.5434174,21.0534351 L14.5434174,20.6501878 L16.4817928,18.7683671 C16.6722689,18.5779447 16.6722689,18.5219382 16.6722689,18.2307041 L16.6722689,7.32062416 L11.2829132,21.0086299 L10.5546219,21.0086299 L4.28011204,7.32062416 L4.28011204,16.4945003 C4.22779746,16.8801958 4.35589372,17.2685069 4.62745097,17.5474239 L7.14845938,20.6053826 L7.14845938,21.0086299 L0,21.0086299 L0,20.6053826 L2.5210084,17.5474239 C2.79058848,17.2680445 2.91121535,16.8771576 2.84593838,16.4945003 L2.84593838,5.88685595 Z"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/u/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Hackernoon profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M5.701 0v6.223H8.85V4.654h1.576v7.842H12V4.654h1.574v1.569h3.15V0zm11.024 6.223v3.136h1.574V6.223zm1.574 3.136v4.705h1.576v-1.568h1.574v-1.568h-1.574V9.359zm0 4.705h-1.574v3.137h1.574zm-1.574 3.137h-3.15v1.569H8.85V17.2H5.7V24h11.024zm-11.024 0v-3.137H4.125v3.137zm-1.576-3.137V9.36H2.551v4.705zm0-4.705h1.576V6.223H4.125Z"></path></svg><span hidden="">Link to Daw-Chih&#x27;s Hacker Noon profile</span></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Twitter profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M24,4.3086 C23.117,4.7006 22.168,4.9646 21.172,5.0836 C22.188,4.4746 22.969,3.5096 23.337,2.3596 C22.386,2.9246 21.332,3.3336 20.21,3.5556 C19.312,2.5976 18.032,1.9996 16.616,1.9996 C13.897,1.9996 11.692,4.2046 11.692,6.9236 C11.692,7.3096 11.736,7.6856 11.82,8.0456 C7.728,7.8406 4.099,5.8806 1.671,2.9006 C1.247,3.6286 1.004,4.4736 1.004,5.3766 C1.004,7.0846 1.873,8.5926 3.195,9.4756 C2.388,9.4486 1.628,9.2276 0.964,8.8596 L0.964,8.9206 C0.964,11.3066 2.661,13.2966 4.914,13.7486 C4.501,13.8626 4.065,13.9216 3.617,13.9216 C3.299,13.9216 2.991,13.8906 2.69,13.8336 C3.317,15.7896 5.135,17.2136 7.29,17.2536 C5.604,18.5736 3.481,19.3606 1.175,19.3606 C0.777,19.3606 0.385,19.3376 0,19.2926 C2.179,20.6886 4.767,21.5046 7.548,21.5046 C16.605,21.5046 21.557,14.0016 21.557,7.4946 C21.557,7.2816 21.552,7.0696 21.543,6.8586 C22.505,6.1636 23.34,5.2966 24,4.3086"></path></svg></a></div><div class="DarkmodeSwitch_container__uFGHQ" tabindex="-1"><div class="DarkmodeSwitch_wrap__e71_4"></div></div></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><button id="react-burger-cross-btn" style="position:absolute;left:0;top:0;z-index:1;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-cross" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div></div></div></header><div class="Menubar_menubar__gvU4b"><a class="styles_anchor__g18qA Menubar_hireMe__zuAig" href="/contact"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>Hire Me</a><div class="DarkmodeSwitch_container__uFGHQ" tabindex="0"><div class="DarkmodeSwitch_wrap__e71_4"></div></div><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou" aria-label="See more Daw-Chih&#x27;s work on GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a></div><div id="page-wrap"><article><div class="Article_container__q__L3"><div class="Article_wrap__LZypL"><h1>Optimize Google Cloud BigQuery and Control Cost</h1><div class="Article_info__bOKys"><div class="Article_author__grS8U"><img alt="Daw-Chih Liou" src="/optimized/raw/portrait-sm.webp" loading="lazy"/><p>Daw-Chih Liou</p></div><p>Apr 14, 2023<!-- --> · 7 min read</p></div><img alt="Optimize Google Cloud BigQuery and Control Cost" src="/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/hero.webp" width="100%" class="rounded centered" loading="lazy"/><div class="article-content"><h2 id="in-this-article"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#in-this-article"><span class="icon icon-link"></span></a>In this article</h2>
<ul>
<li><span role="img" aria-label="see-no-evil monkey">🙈</span> You&#x27;ll learn what contributes to BigQuery&#x27;s costs.</li>
<li><span role="img" aria-label="" aria-hidden="true">🏛️</span> We&#x27;ll dive into BigQuery&#x27;s architecture.</li>
<li><span role="img" aria-label="money bag">💰</span> You&#x27;ll learn 3 easy steps to save 99.97% on your next Google Cloud bill.</li>
</ul>
<p>Let&#x27;s go.</p>
<hr/>
<p>This article is also available on</p>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://medium.com/gitconnected/optimize-google-cloud-bigquery-and-control-cost-2126a3dff0ff">Level Up Coding</a></li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/how-to-optimize-google-cloud-bigquery-and-control-the-cost">Hacker Noon</a></li>
</ul>
<p>Feel free to read it on your favorite platform<span role="img" aria-label="sparkles">✨</span></p>
<hr/>
<h2 id="how-did-it-happen"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#how-did-it-happen"><span class="icon icon-link"></span></a>How Did It Happen?</h2>
<p>I was developing a script to prepare data samples for customers that reached out for consultations. The samples have 100 rows in each file and they are split in 55 locales. My query looks like this</p>
<pre class="language-sql"><code class="language-sql code-highlight"><span class="code-line"><span class="token keyword">SELECT</span> <span class="token operator">*</span>
</span><span class="code-line"><span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>project.dataset.table<span class="token punctuation">`</span></span>
</span><span class="code-line"><span class="token keyword">WHERE</span>
</span><span class="code-line">  ts <span class="token operator">BETWEEN</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token string">&quot;2022-12-01&quot;</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token string">&quot;2023-02-28&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token operator">AND</span> locale <span class="token operator">=</span> <span class="token string">&quot;US&quot;</span>
</span><span class="code-line"><span class="token keyword">LIMIT</span> <span class="token number">100</span><span class="token punctuation">;</span>
</span></code></pre>
<p>The data was stored in &quot;europe-west-4&quot; and the <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/pricing">pricing for querying is $6 per TB</a>. So by running the script, I processed</p>
<ul>
<li>500 TB of data in total</li>
<li>3 TB of data per country on average</li>
<li>$54 per data sample file on average</li>
</ul>
<p>Very expensive.</p>
<h2 id="the-script-that-costed-3000"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#the-script-that-costed-3000"><span class="icon icon-link"></span></a>The Script that Costed $3,000</h2>
<p>The script was written in <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript modules</a>.</p>
<div class="rehype-code-title">bq-samples.mjs</div><pre class="language-js"><code class="language-js code-highlight"><span class="code-line"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">BigQuery</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">&quot;@google-cloud/bigquery&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> <span class="token maybe-class-name">Parser</span> <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">&quot;@json2csv/plainjs&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword module">import</span> <span class="token imports">makeDir</span> <span class="token keyword module">from</span> <span class="token string">&quot;make-dir&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> write <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">&quot;./write.mjs&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> locales <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">&quot;./locales.mjs&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> perf <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">&quot;./performance.mjs&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">const</span> <span class="token function-variable function">q</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">locale<span class="token punctuation">,</span> start<span class="token punctuation">,</span> end<span class="token punctuation">,</span> limit</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">SELECT *
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">  FROM \`project.dataset.table\`
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">  WHERE
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">    ts BETWEEN TIMESTAMP(&quot;2022-12-01&quot;) AND TIMESTAMP(&quot;2023-02-28&quot;)
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">    AND locale = &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>locale<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;
</span></span></span><span class="code-line"><span class="token template-string"><span class="token string">  LIMIT </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>limit<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token keyword">const</span> timer <span class="token operator">=</span> <span class="token function">perf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword">const</span> dir <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">makeDir</span><span class="token punctuation">(</span><span class="token string">&#x27;samples&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token keyword">const</span> bigquery <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BigQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token keyword">const</span> csvParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parser</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">  <span class="token keyword control-flow">try</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token keyword">const</span> jobs <span class="token operator">=</span> locales<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">locale</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token punctuation">{</span>
</span><span class="code-line">      <span class="token comment">// get query result from BigQuery</span>
</span><span class="code-line">      <span class="token keyword">const</span> <span class="token punctuation">[</span>job<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> bigquery<span class="token punctuation">.</span><span class="token method function property-access">createQueryJob</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">        <span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token function">q</span><span class="token punctuation">(</span>locale<span class="token punctuation">,</span> <span class="token string">&quot;2022-12-01&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2023-02-28&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">      <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">      <span class="token keyword">const</span> <span class="token punctuation">[</span>rows<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> job<span class="token punctuation">.</span><span class="token method function property-access">getQueryResults</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// parse rows into csv format</span>
</span><span class="code-line">      <span class="token keyword">const</span> csv <span class="token operator">=</span> <span class="token function">parse</span><span class="token punctuation">(</span>csvParser<span class="token punctuation">,</span> rows<span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment">// write data into csv files and store in the file system</span>
</span><span class="code-line">      <span class="token keyword control-flow">await</span> <span class="token function">write</span><span class="token punctuation">(</span>csv<span class="token punctuation">,</span> dir<span class="token punctuation">,</span> locale<span class="token punctuation">,</span> <span class="token string">&quot;2022-12-01&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;2023-02-28&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
</span><span class="code-line">    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token keyword control-flow">await</span> <span class="token known-class-name class-name">Promise</span><span class="token punctuation">.</span><span class="token method function property-access">all</span><span class="token punctuation">(</span>jobs<span class="token punctuation">.</span><span class="token method function property-access">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">job</span><span class="token punctuation">)</span> <span class="token arrow operator">=&gt;</span> <span class="token function">job</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string"><span role="img" aria-label="sparkles">✨</span> Done in </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timer<span class="token punctuation">.</span><span class="token method function property-access">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> seconds.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">}</span> <span class="token keyword control-flow">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
</span><span class="code-line">    <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">error</span><span class="token punctuation">(</span><span class="token string">&#x27;<span role="img" aria-label="cross mark">❌</span> Failed to create sample file&#x27;</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token punctuation">}</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword control-flow">await</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</span></code></pre>
<p>It generates one sample file in <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Comma-separated_values">CSV</a> format per locale. The process is straightforward:</p>
<ul>
<li>Querying the BigQuery table with a local, start date, end date, and limit.</li>
<li>Transforming the query result into CSV format.</li>
<li>Writing the CSV in the file system.</li>
<li>Repeating the process for all locales.</li>
</ul>
<h2 id="whats-the-problem"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#whats-the-problem"><span class="icon icon-link"></span></a>What&#x27;s The Problem?</h2>
<p>It turns out that I did several things wrong in my query. If you look at the pricing model again, you&#x27;ll notice the cost is only related to how much data you process. So it&#x27;s clear that my query looked up too much data to produce 100 rows. With this insight, let&#x27;s optimize the query step by step.</p>
<h2 id="dont-select-"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#dont-select-"><span class="icon icon-link"></span></a>Don&#x27;t Select *</h2>
<p>It&#x27;s a little counter intuitive. Why does my select statement have anything to do with how much data it processes? Regardless of the columns I select, I should be reading from the same resources and data, right?</p>
<p>It&#x27;s only true for row-oriented databases.</p>
<p>BigQuery is actually a <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Column-oriented_DBMS">columnar database</a>. It&#x27;s column-oriented, meaning the data are structured in columns. BigQuery uses <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="http://www.goldsborough.me/distributed-systems/2019/05/18/21-09-00-a_look_at_dremel/">Dremel</a> as its underlying computing engine. When the data is moved from the cold storage to the active storage in Dremel, it stores the data in a tree structure. Each leaf node is a column-oriented &quot;record&quot; in <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Protocol_Buffers">Protobuf</a> format.</p>
<img src="/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/columnar.webp" alt="image from the template" width="100%" class="rounded centered" loading="lazy"/>
<p>In BigQuery, each node is a VM. A query execution propagates from the root server (node) through intermediate servers to the leaf servers to retrieve the selected columns.</p>
<p>We can modify the query to select individual columns:</p>
<pre class="language-sql"><code class="language-sql code-highlight"><span class="code-line"><span class="token keyword">SELECT</span>
</span><span class="code-line">  session_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  session_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  session_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  user_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  user_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  user_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  query_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  query_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  query_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  impression_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  impression_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  impression_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  ts
</span><span class="code-line"><span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>project.dataset.table<span class="token punctuation">`</span></span>
</span><span class="code-line"><span class="token keyword">WHERE</span>
</span><span class="code-line">  ts <span class="token operator">BETWEEN</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token string">&quot;2022-12-01&quot;</span><span class="token punctuation">)</span> <span class="token operator">AND</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token string">&quot;2023-02-28&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token operator">AND</span> locale <span class="token operator">=</span> <span class="token string">&quot;US&quot;</span>
</span><span class="code-line"><span class="token keyword">LIMIT</span> <span class="token number">100</span><span class="token punctuation">;</span>
</span></code></pre>
<p>Just by selecting all the columns explicitly, I was able to reduce the processed data from 3.08 TB to 2.94TB. That&#x27;s a <strong>100 GB reduction</strong>.</p>
<h2 id="use-partitioned-table-and-query-only-subsets-of-data"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#use-partitioned-table-and-query-only-subsets-of-data"><span class="icon icon-link"></span></a>Use Partitioned Table and Query Only Subsets of Data</h2>
<p>Google Cloud recommends us to <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/creating-partitioned-tables">partition tables by date</a>. It lets us query only a subset of data.</p>
<p>To optimize the query further, we can narrow down the date range in the where statement because the table is partitioned by the &quot;ts&quot; column.</p>
<pre class="language-sql"><code class="language-sql code-highlight"><span class="code-line"><span class="token keyword">SELECT</span>
</span><span class="code-line">  session_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  session_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  session_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  user_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  user_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  user_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  query_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  query_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  query_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  impression_info_1<span class="token punctuation">,</span>
</span><span class="code-line">  impression_info_2<span class="token punctuation">,</span>
</span><span class="code-line">  impression_info_3<span class="token punctuation">,</span>
</span><span class="code-line">  ts
</span><span class="code-line"><span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">`</span>project.dataset.table<span class="token punctuation">`</span></span>
</span><span class="code-line"><span class="token keyword">WHERE</span>
</span><span class="code-line">  ts <span class="token operator">=</span> <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token string">&quot;2022-12-01&quot;</span><span class="token punctuation">)</span>
</span><span class="code-line">  <span class="token operator">AND</span> locale <span class="token operator">=</span> <span class="token string">&quot;US&quot;</span>
</span><span class="code-line"><span class="token keyword">LIMIT</span> <span class="token number">100</span><span class="token punctuation">;</span>
</span></code></pre>
<p>I narrowed down the date range to one day instead of three months. I was able to cut down the processed data to <strong>37.43 GB</strong>. It&#x27;s just a fraction of the original query.</p>
<h2 id="use-materialized-query-results-in-stages"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#use-materialized-query-results-in-stages"><span class="icon icon-link"></span></a>Use Materialized Query Results in Stages</h2>
<p>Another way to reduce costs is to reduce the dataset you&#x27;re querying from. BigQuery offers <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/writing-results#node.js">destination tables</a> to store query results as smaller datasets. Destination tables come with two forms: temporary and permanent. Because temporary tables has a lifetime and it&#x27;s not designed to be shared and queried, I created a permanent destination table to materialize the query result:</p>
<div class="rehype-code-title">bq-samples.mjs</div><pre class="language-js"><code class="language-js code-highlight"><span class="code-line"><span class="token keyword">const</span> dataset <span class="token operator">=</span> bigquery<span class="token punctuation">.</span><span class="token method function property-access">dataset</span><span class="token punctuation">(</span><span class="token string">&#x27;materialized_dataset&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token keyword">const</span> materialzedTable <span class="token operator">=</span> dataset<span class="token punctuation">.</span><span class="token method function property-access">table</span><span class="token punctuation">(</span><span class="token string">&#x27;materialized_table&#x27;</span><span class="token punctuation">)</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">// ...</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">const</span> <span class="token punctuation">[</span>job<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> bigquery<span class="token punctuation">.</span><span class="token method function property-access">createQueryJob</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token literal-property property">query</span><span class="token operator">:</span> <span class="token function">q</span><span class="token punctuation">(</span>locale<span class="token punctuation">,</span> <span class="token string">&#x27;2022-12-01&#x27;</span><span class="token punctuation">,</span> <span class="token string">&#x27;2023-02-28&#x27;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token literal-property property">destination</span><span class="token operator">:</span> materialzedTable<span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></code></pre>
<p>The query results will be stored in the destination table. It&#x27;ll serve as a reference for future queries. Whenever it&#x27;s possible to query from the destination table, BigQuery will process the data from the table. It&#x27;ll greatly reduce the data size we look up.</p>
<h2 id="final-thoughts"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#final-thoughts"><span class="icon icon-link"></span></a>Final Thoughts</h2>
<p>It&#x27;s a very interesting study to reduce the cost in BigQuery. With only three easy steps:</p>
<ul>
<li>Don&#x27;t use *</li>
<li>Use Partitioned Table and Query Only Subsets of Data</li>
<li>Use Materialized Query Results in Stages</li>
</ul>
<p>I was able to reduce the processed data size <strong>from 3 TB to 37.5 GB</strong>. It reduces the total cost significantly from $3,000 to $30.</p>
<p>If you&#x27;re interested in learning more about the BigQuery architecture, here&#x27;re the references that helped me:</p>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/blog/products/data-analytics/new-blog-series-bigquery-explained-overview">BigQuery explained: An overview of BigQuery&#x27;s architecture</a></li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="http://www.goldsborough.me/distributed-systems/2019/05/18/21-09-00-a_look_at_dremel/">A Look at Dremel</a></li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/blog/products/storage-data-transfer/a-peek-behind-colossus-googles-file-system">Colossus under the hood: a peek into Google’s scalable storage system</a></li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/blog/topics/systems/the-evolution-of-googles-jupiter-data-center-network">Jupiter evolving: Reflecting on Google’s data center network transformation</a></li>
</ul>
<p>You can read more about <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/best-practices-costs">BigQuery cost optimizations</a> in the Google Cloud documentation.</p>
<blockquote>
<p>Special thanks to <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/abunashir/">Abu Nashir</a> for collaborating with me on the case study and providing valuable insights that helped me understand BigQuery&#x27;s architecture.</p>
</blockquote>
<h2 id="references"><a class="styles_anchor__g18qA anchor" href="/articles/optimize-google-cloud-bigquery-and-control-cost#references"><span class="icon icon-link"></span></a>References</h2>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/abunashir/">Abu Nashir</a> - LinkedIn</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="http://www.goldsborough.me/distributed-systems/2019/05/18/21-09-00-a_look_at_dremel/">A Look at Dremel</a> - Peter Goldsborough</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery">BigQuery</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/blog/products/data-analytics/new-blog-series-bigquery-explained-overview">BigQuery explained: An overview of BigQuery&#x27;s architecture</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/blog/products/storage-data-transfer/a-peek-behind-colossus-googles-file-system">Colossus under the hood: a peek into Google’s scalable storage system</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Column-oriented_DBMS">Column-oriented DBMS</a> - Wikipedia</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Comma-separated_values">Comma-separated values</a> - Wikipedia</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/creating-partitioned-tables">Creating partitioned tables</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules">JavaScript modules</a> - MDN</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/blog/topics/systems/the-evolution-of-googles-jupiter-data-center-network">Jupiter evolving: Reflecting on Google’s data center network transformation</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs/query#QueryRequest">Method: jobs.query</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Protocol_Buffers">Protocol_Buffers</a> - Wikipedia</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/running-queries#permanent-table">Run interactive and batch query jobs</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/cached-results#bq">Using cached query results</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/bigquery/docs/writing-results#node.js">Writing query results</a> - Google Cloud</li>
</ul>
<hr/>
<p>Here you have it! Thanks for reading through <span role="img" aria-label="raising hands">🙌</span>
If you find this article useful, please share it to help more people in their engineering journey.</p>
<p><span role="img" aria-label="bird">🐦</span> Feel free to connect with me on <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou">twitter</a>!</p>
<p><span role="img" aria-label="" aria-hidden="true">⏭️</span> Ready for the next article? <span role="img" aria-label="backhand index pointing right">👉</span> <a class="styles_anchor__g18qA undefined" href="/articles/how-to-run-a-tech-community-in-your-company">How to Run A Tech Community in Your Company: An Ex-Principal Engineer’s Guide</a></p>
<p>Happy coding!</p></div><article class="Author_wrap__s8DeE"><img src="/optimized/raw/portrait-sm.webp" alt="Daw-Chih Liou" class="Author_avatar__j6KIn" loading="lazy"/><div><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://dawchihliou.github.io">Daw-Chih Liou</a><p>Daw-Chih is a software engineer, UX advocate, and creator who is dedicated to Web engineering. His background in Human Centered Computing has led him to work with startups and public companies across North America, Asia, and Europe. He is passionate about meeting business trajectory with user journey and utilizing engineering architecture and performance monitoring to provide optimal user experience.</p></div></article></div></div></article><footer class="Footer_footer__1IwEk"><div class="Footer_wrap__FVCTX"><div class="Footer_resources__fG_vu"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">💚</span>This site is built with</p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://nextjs.org">Next.js</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://react-icons.github.io/react-icons">React Icons</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://mdxjs.com">MDX</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://unifiedjs.com">unified</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/contentlayerdev/contentlayer">Contentlayer</a></div><div class="Footer_contact__9GJn6"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">🦄</span>Where to find me</p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou">Linkedin</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou">GitHub</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou">Twitter</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://medium.com/@dawchihliou">Medium</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/u/dawchihliou">Hacker Noon</a><a class="styles_anchor__g18qA undefined" href="/rss.xml">RSS Feed <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div><div class="Footer_sitemap__92ono"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">🗺</span>Sitemap</p><a class="styles_anchor__g18qA undefined" href="/">Home</a><a class="styles_anchor__g18qA undefined" href="/articles">Articles</a><a class="styles_anchor__g18qA undefined" href="/work">Work</a><a class="styles_anchor__g18qA undefined" href="/now">Now</a><a class="styles_anchor__g18qA undefined" href="/expertise">Expertise</a><a class="styles_anchor__g18qA undefined" href="/contact">Contact</a></div></div><div class="Footer_copyright__vZZRL">© <!-- -->2023<!-- --> <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou">Daw-Chih Liou</a></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Optimize Google Cloud BigQuery and Control Cost","publishedAt":"Apr 14, 2023","description":"I unknowingly blew $3,000 in 6 hours on one query in Google Cloud BigQuery. Here's why and 3 easy steps to optimize the cost.","cover":"/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/hero.webp","category":"Cloud","coverWidth":"1400","coverHeight":"700","body":{"raw":"\n## In this article\n\n- 🙈 You'll learn what contributes to BigQuery's costs.\n- 🏛️ We'll dive into BigQuery's architecture.\n- 💰 You'll learn 3 easy steps to save 99.97% on your next Google Cloud bill.\n\nLet's go.\n\n---\n\nThis article is also available on\n\n- [Level Up Coding](https://medium.com/gitconnected/optimize-google-cloud-bigquery-and-control-cost-2126a3dff0ff)\n- [Hacker Noon](https://hackernoon.com/how-to-optimize-google-cloud-bigquery-and-control-the-cost)\n\nFeel free to read it on your favorite platform✨\n\n---\n\n## How Did It Happen?\n\nI was developing a script to prepare data samples for customers that reached out for consultations. The samples have 100 rows in each file and they are split in 55 locales. My query looks like this\n\n```sql\nSELECT *\nFROM `project.dataset.table`\nWHERE\n  ts BETWEEN TIMESTAMP(\"2022-12-01\") AND TIMESTAMP(\"2023-02-28\")\n  AND locale = \"US\"\nLIMIT 100;\n```\n\nThe data was stored in \"europe-west-4\" and the [pricing for querying is $6 per TB][2]. So by running the script, I processed\n\n- 500 TB of data in total\n- 3 TB of data per country on average\n- $54 per data sample file on average\n\nVery expensive.\n\n## The Script that Costed $3,000\n\nThe script was written in [JavaScript modules][3].\n\n```js:bq-samples.mjs\nimport { BigQuery } from \"@google-cloud/bigquery\";\nimport { Parser } from \"@json2csv/plainjs\";\nimport makeDir from \"make-dir\";\nimport { write } from \"./write.mjs\";\nimport { locales } from \"./locales.mjs\";\nimport { perf } from \"./performance.mjs\";\n\nconst q = (locale, start, end, limit) =\u003e `SELECT *\n  FROM \\`project.dataset.table\\`\n  WHERE\n    ts BETWEEN TIMESTAMP(\"2022-12-01\") AND TIMESTAMP(\"2023-02-28\")\n    AND locale = \"${locale}\"\n  LIMIT ${limit}`\n\nasync function main() {\n  const timer = perf()\n\n  const dir = await makeDir('samples')\n  const bigquery = new BigQuery()\n  const csvParser = new Parser({})\n\n  try {\n    const jobs = locales.map((locale) =\u003e async () =\u003e {\n      // get query result from BigQuery\n      const [job] = await bigquery.createQueryJob({\n        query: q(locale, \"2022-12-01\", \"2023-02-28\", 100),\n      })\n      const [rows] = await job.getQueryResults()\n\n      // parse rows into csv format\n      const csv = parse(csvParser, rows)\n\n      // write data into csv files and store in the file system\n      await write(csv, dir, locale, \"2022-12-01\", \"2023-02-28\", 100)\n    })\n\n    await Promise.all(jobs.map((job) =\u003e job()))\n\n    console.log(`✨ Done in ${timer.stop()} seconds.`)\n  } catch (error) {\n    console.error('❌ Failed to create sample file', error)\n  }\n}\n\nawait main()\n```\n\nIt generates one sample file in [CSV][4] format per locale. The process is straightforward:\n\n- Querying the BigQuery table with a local, start date, end date, and limit.\n- Transforming the query result into CSV format.\n- Writing the CSV in the file system.\n- Repeating the process for all locales.\n\n## What's The Problem?\n\nIt turns out that I did several things wrong in my query. If you look at the pricing model again, you'll notice the cost is only related to how much data you process. So it's clear that my query looked up too much data to produce 100 rows. With this insight, let's optimize the query step by step.\n\n## Don't Select \\*\n\nIt's a little counter intuitive. Why does my select statement have anything to do with how much data it processes? Regardless of the columns I select, I should be reading from the same resources and data, right?\n\nIt's only true for row-oriented databases.\n\nBigQuery is actually a [columnar database][6]. It's column-oriented, meaning the data are structured in columns. BigQuery uses [Dremel][10] as its underlying computing engine. When the data is moved from the cold storage to the active storage in Dremel, it stores the data in a tree structure. Each leaf node is a column-oriented \"record\" in [Protobuf][14] format.\n\n\u003cimg\n  src=\"/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/columnar.webp\"\n  alt=\"image from the template\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\nIn BigQuery, each node is a VM. A query execution propagates from the root server (node) through intermediate servers to the leaf servers to retrieve the selected columns.\n\nWe can modify the query to select individual columns:\n\n```sql\nSELECT\n  session_info_1,\n  session_info_2,\n  session_info_3,\n  user_info_1,\n  user_info_2,\n  user_info_3,\n  query_info_1,\n  query_info_2,\n  query_info_3,\n  impression_info_1,\n  impression_info_2,\n  impression_info_3,\n  ts\nFROM `project.dataset.table`\nWHERE\n  ts BETWEEN TIMESTAMP(\"2022-12-01\") AND TIMESTAMP(\"2023-02-28\")\n  AND locale = \"US\"\nLIMIT 100;\n```\n\nJust by selecting all the columns explicitly, I was able to reduce the processed data from 3.08 TB to 2.94TB. That's a **100 GB reduction**.\n\n## Use Partitioned Table and Query Only Subsets of Data\n\nGoogle Cloud recommends us to [partition tables by date][15]. It lets us query only a subset of data.\n\nTo optimize the query further, we can narrow down the date range in the where statement because the table is partitioned by the \"ts\" column.\n\n```sql\nSELECT\n  session_info_1,\n  session_info_2,\n  session_info_3,\n  user_info_1,\n  user_info_2,\n  user_info_3,\n  query_info_1,\n  query_info_2,\n  query_info_3,\n  impression_info_1,\n  impression_info_2,\n  impression_info_3,\n  ts\nFROM `project.dataset.table`\nWHERE\n  ts = TIMESTAMP(\"2022-12-01\")\n  AND locale = \"US\"\nLIMIT 100;\n```\n\nI narrowed down the date range to one day instead of three months. I was able to cut down the processed data to **37.43 GB**. It's just a fraction of the original query.\n\n## Use Materialized Query Results in Stages\n\nAnother way to reduce costs is to reduce the dataset you're querying from. BigQuery offers [destination tables][11] to store query results as smaller datasets. Destination tables come with two forms: temporary and permanent. Because temporary tables has a lifetime and it's not designed to be shared and queried, I created a permanent destination table to materialize the query result:\n\n```js:bq-samples.mjs\nconst dataset = bigquery.dataset('materialized_dataset')\nconst materialzedTable = dataset.table('materialized_table')\n\n// ...\n\nconst [job] = await bigquery.createQueryJob({\n  query: q(locale, '2022-12-01', '2023-02-28', 100),\n  destination: materialzedTable,\n})\n```\n\nThe query results will be stored in the destination table. It'll serve as a reference for future queries. Whenever it's possible to query from the destination table, BigQuery will process the data from the table. It'll greatly reduce the data size we look up.\n\n## Final Thoughts\n\nIt's a very interesting study to reduce the cost in BigQuery. With only three easy steps:\n\n- Don't use \\*\n- Use Partitioned Table and Query Only Subsets of Data\n- Use Materialized Query Results in Stages\n\nI was able to reduce the processed data size **from 3 TB to 37.5 GB**. It reduces the total cost significantly from $3,000 to $30.\n\nIf you're interested in learning more about the BigQuery architecture, here're the references that helped me:\n\n- [BigQuery explained: An overview of BigQuery's architecture][9]\n- [A Look at Dremel][10]\n- [Colossus under the hood: a peek into Google’s scalable storage system][7]\n- [Jupiter evolving: Reflecting on Google’s data center network transformation][8]\n\nYou can read more about [BigQuery cost optimizations][17] in the Google Cloud documentation.\n\n\u003e Special thanks to [Abu Nashir][16] for collaborating with me on the case study and providing valuable insights that helped me understand BigQuery's architecture.\n\n## References\n\n- [Abu Nashir][16] - LinkedIn\n- [A Look at Dremel][10] - Peter Goldsborough\n- [BigQuery][1] - Google Cloud\n- [BigQuery explained: An overview of BigQuery's architecture][9] - Google Cloud\n- [Colossus under the hood: a peek into Google’s scalable storage system][7] - Google Cloud\n- [Column-oriented DBMS][6] - Wikipedia\n- [Comma-separated values][4] - Wikipedia\n- [Creating partitioned tables][15] - Google Cloud\n- [JavaScript modules][3] - MDN\n- [Jupiter evolving: Reflecting on Google’s data center network transformation][8] - Google Cloud\n- [Method: jobs.query][13] - Google Cloud\n- [Protocol_Buffers][14] - Wikipedia\n- [Run interactive and batch query jobs][12] - Google Cloud\n- [Using cached query results][5] - Google Cloud\n- [Writing query results][11] - Google Cloud\n\n[1]: https://cloud.google.com/bigquery\n[2]: https://cloud.google.com/bigquery/pricing\n[3]: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules\n[4]: https://en.wikipedia.org/wiki/Comma-separated_values\n[5]: https://cloud.google.com/bigquery/docs/cached-results#bq\n[6]: https://en.wikipedia.org/wiki/Column-oriented_DBMS\n[7]: https://cloud.google.com/blog/products/storage-data-transfer/a-peek-behind-colossus-googles-file-system\n[8]: https://cloud.google.com/blog/topics/systems/the-evolution-of-googles-jupiter-data-center-network\n[9]: https://cloud.google.com/blog/products/data-analytics/new-blog-series-bigquery-explained-overview\n[10]: http://www.goldsborough.me/distributed-systems/2019/05/18/21-09-00-a_look_at_dremel/\n[11]: https://cloud.google.com/bigquery/docs/writing-results#node.js\n[12]: https://cloud.google.com/bigquery/docs/running-queries#permanent-table\n[13]: https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs/query#QueryRequest\n[14]: https://en.wikipedia.org/wiki/Protocol_Buffers\n[15]: https://cloud.google.com/bigquery/docs/creating-partitioned-tables\n[16]: https://www.linkedin.com/in/abunashir/\n[17]: https://cloud.google.com/bigquery/docs/best-practices-costs\n\n---\n\nHere you have it! Thanks for reading through 🙌\nIf you find this article useful, please share it to help more people in their engineering journey.\n\n🐦 Feel free to connect with me on [twitter](https://twitter.com/dawchihliou)!\n\n⏭️ Ready for the next article? 👉 [How to Run A Tech Community in Your Company: An Ex-Principal Engineer’s Guide](/articles/how-to-run-a-tech-community-in-your-company)\n\nHappy coding!\n","code":"var Component=(()=\u003e{var p=Object.create;var l=Object.defineProperty;var h=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty;var k=(a,e)=\u003e()=\u003e(e||a((e={exports:{}}).exports,e),e.exports),g=(a,e)=\u003e{for(var s in e)l(a,s,{get:e[s],enumerable:!0})},o=(a,e,s,t)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let c of m(e))!N.call(a,c)\u0026\u0026c!==s\u0026\u0026l(a,c,{get:()=\u003ee[c],enumerable:!(t=h(e,c))||t.enumerable});return a};var y=(a,e,s)=\u003e(s=a!=null?p(u(a)):{},o(e||!a||!a.__esModule?l(s,\"default\",{value:a,enumerable:!0}):s,a)),f=a=\u003eo(l({},\"__esModule\",{value:!0}),a);var r=k((T,i)=\u003e{i.exports=_jsx_runtime});var _={};g(_,{default:()=\u003eq,frontmatter:()=\u003ew});var n=y(r()),w={title:\"Optimize Google Cloud BigQuery and Control Cost\",publishedAt:\"Apr 14, 2023\",description:\"I unknowingly blew $3,000 in 6 hours on one query in Google Cloud BigQuery. Here's why and 3 easy steps to optimize the cost.\",cover:\"/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/hero.webp\",category:\"Cloud\",coverWidth:\"1400\",coverHeight:\"700\"};function d(a){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",ul:\"ul\",li:\"li\",p:\"p\",hr:\"hr\",pre:\"pre\",code:\"code\",div:\"div\",strong:\"strong\",blockquote:\"blockquote\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h2,{id:\"in-this-article\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#in-this-article\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"In this article\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"see-no-evil monkey\",children:\"\\u{1F648}\"}),\" You'll learn what contributes to BigQuery's costs.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"\",\"aria-hidden\":!0,children:\"\\u{1F3DB}\\uFE0F\"}),\" We'll dive into BigQuery's architecture.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"money bag\",children:\"\\u{1F4B0}\"}),\" You'll learn 3 easy steps to save 99.97% on your next Google Cloud bill.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"Let's go.\"}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsx)(e.p,{children:\"This article is also available on\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://medium.com/gitconnected/optimize-google-cloud-bigquery-and-control-cost-2126a3dff0ff\",children:\"Level Up Coding\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://hackernoon.com/how-to-optimize-google-cloud-bigquery-and-control-the-cost\",children:\"Hacker Noon\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Feel free to read it on your favorite platform\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"})]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsxs)(e.h2,{id:\"how-did-it-happen\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#how-did-it-happen\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"How Did It Happen?\"]}),`\n`,(0,n.jsx)(e.p,{children:\"I was developing a script to prepare data samples for customers that reached out for consultations. The samples have 100 rows in each file and they are split in 55 locales. My query looks like this\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-sql\",children:(0,n.jsxs)(e.code,{className:\"language-sql code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"SELECT\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"*\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" \",(0,n.jsxs)(e.span,{className:\"token identifier\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"`\"}),\"project.dataset.table\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"`\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WHERE\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  ts \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"BETWEEN\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"TIMESTAMP\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"2022-12-01\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"AND\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"TIMESTAMP\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"2023-02-28\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"AND\"}),\" locale \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"US\"'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"LIMIT\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:['The data was stored in \"europe-west-4\" and the ',(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/pricing\",children:\"pricing for querying is $6 per TB\"}),\". So by running the script, I processed\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"500 TB of data in total\"}),`\n`,(0,n.jsx)(e.li,{children:\"3 TB of data per country on average\"}),`\n`,(0,n.jsx)(e.li,{children:\"$54 per data sample file on average\"}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"Very expensive.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"the-script-that-costed-3000\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-script-that-costed-3000\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Script that Costed $3,000\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The script was written in \",(0,n.jsx)(e.a,{href:\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules\",children:\"JavaScript modules\"}),\".\"]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"bq-samples.mjs\"}),(0,n.jsx)(e.pre,{className:\"language-js\",children:(0,n.jsxs)(e.code,{className:\"language-js code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,n.jsxs)(e.span,{className:\"token imports\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token maybe-class-name\",children:\"BigQuery\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"})]}),\" \",(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"@google-cloud/bigquery\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,n.jsxs)(e.span,{className:\"token imports\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" \",(0,n.jsx)(e.span,{className:\"token maybe-class-name\",children:\"Parser\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"})]}),\" \",(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"@json2csv/plainjs\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,n.jsx)(e.span,{className:\"token imports\",children:\"makeDir\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"make-dir\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,n.jsxs)(e.span,{className:\"token imports\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" write \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"})]}),\" \",(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"./write.mjs\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,n.jsxs)(e.span,{className:\"token imports\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" locales \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"})]}),\" \",(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"./locales.mjs\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,n.jsxs)(e.span,{className:\"token imports\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" perf \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"})]}),\" \",(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"./performance.mjs\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token function-variable function\",children:\"q\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsxs)(e.span,{className:\"token parameter\",children:[\"locale\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" start\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" end\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" limit\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token arrow operator\",children:\"=\u003e\"}),\" \",(0,n.jsxs)(e.span,{className:\"token template-string\",children:[(0,n.jsx)(e.span,{className:\"token template-punctuation string\",children:\"`\"}),(0,n.jsx)(e.span,{className:\"token string\",children:`SELECT *\n`})]})]}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token template-string\",children:(0,n.jsx)(e.span,{className:\"token string\",children:\"  FROM \\\\`project.dataset.table\\\\`\\n\"})})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token template-string\",children:(0,n.jsx)(e.span,{className:\"token string\",children:`  WHERE\n`})})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsx)(e.span,{className:\"token template-string\",children:(0,n.jsx)(e.span,{className:\"token string\",children:`    ts BETWEEN TIMESTAMP(\"2022-12-01\") AND TIMESTAMP(\"2023-02-28\")\n`})})}),(0,n.jsx)(e.span,{className:\"code-line\",children:(0,n.jsxs)(e.span,{className:\"token template-string\",children:[(0,n.jsx)(e.span,{className:\"token string\",children:'    AND locale = \"'}),(0,n.jsxs)(e.span,{className:\"token interpolation\",children:[(0,n.jsx)(e.span,{className:\"token interpolation-punctuation punctuation\",children:\"${\"}),\"locale\",(0,n.jsx)(e.span,{className:\"token interpolation-punctuation punctuation\",children:\"}\"})]}),(0,n.jsx)(e.span,{className:\"token string\",children:`\"\n`})]})}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token template-string\",children:[(0,n.jsx)(e.span,{className:\"token string\",children:\"  LIMIT \"}),(0,n.jsxs)(e.span,{className:\"token interpolation\",children:[(0,n.jsx)(e.span,{className:\"token interpolation-punctuation punctuation\",children:\"${\"}),\"limit\",(0,n.jsx)(e.span,{className:\"token interpolation-punctuation punctuation\",children:\"}\"})]}),(0,n.jsx)(e.span,{className:\"token template-punctuation string\",children:\"`\"})]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"async\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"function\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"main\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" timer \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"perf\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" dir \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"makeDir\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'samples'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" bigquery \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"BigQuery\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" csvParser \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"new\"}),\" \",(0,n.jsx)(e.span,{className:\"token class-name\",children:\"Parser\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"try\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" jobs \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" locales\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"map\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token parameter\",children:\"locale\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token arrow operator\",children:\"=\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"async\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token arrow operator\",children:\"=\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// get query result from BigQuery\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"job\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" bigquery\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"createQueryJob\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token literal-property property\",children:\"query\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"q\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"locale\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2022-12-01\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2023-02-28\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"rows\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" job\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"getQueryResults\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// parse rows into csv format\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" csv \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"parse\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"csvParser\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" rows\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"// write data into csv files and store in the file system\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"write\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"csv\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" dir\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" locale\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2022-12-01\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"2023-02-28\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" \",(0,n.jsx)(e.span,{className:\"token known-class-name class-name\",children:\"Promise\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"all\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"jobs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"map\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token parameter\",children:\"job\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token arrow operator\",children:\"=\u003e\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"job\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token console class-name\",children:\"console\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"log\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsxs)(e.span,{className:\"token template-string\",children:[(0,n.jsx)(e.span,{className:\"token template-punctuation string\",children:\"`\"}),(0,n.jsxs)(e.span,{className:\"token string\",children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"}),\" Done in \"]}),(0,n.jsxs)(e.span,{className:\"token interpolation\",children:[(0,n.jsx)(e.span,{className:\"token interpolation-punctuation punctuation\",children:\"${\"}),\"timer\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"stop\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token interpolation-punctuation punctuation\",children:\"}\"})]}),(0,n.jsx)(e.span,{className:\"token string\",children:\" seconds.\"}),(0,n.jsx)(e.span,{className:\"token template-punctuation string\",children:\"`\"})]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"catch\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"error\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token console class-name\",children:\"console\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"error\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsxs)(e.span,{className:\"token string\",children:[\"'\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"cross mark\",children:\"\\u274C\"}),\" Failed to create sample file'\"]}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" error\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"main\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"It generates one sample file in \",(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Comma-separated_values\",children:\"CSV\"}),\" format per locale. The process is straightforward:\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"Querying the BigQuery table with a local, start date, end date, and limit.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Transforming the query result into CSV format.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Writing the CSV in the file system.\"}),`\n`,(0,n.jsx)(e.li,{children:\"Repeating the process for all locales.\"}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"whats-the-problem\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#whats-the-problem\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"What's The Problem?\"]}),`\n`,(0,n.jsx)(e.p,{children:\"It turns out that I did several things wrong in my query. If you look at the pricing model again, you'll notice the cost is only related to how much data you process. So it's clear that my query looked up too much data to produce 100 rows. With this insight, let's optimize the query step by step.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"dont-select-\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#dont-select-\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Don't Select *\"]}),`\n`,(0,n.jsx)(e.p,{children:\"It's a little counter intuitive. Why does my select statement have anything to do with how much data it processes? Regardless of the columns I select, I should be reading from the same resources and data, right?\"}),`\n`,(0,n.jsx)(e.p,{children:\"It's only true for row-oriented databases.\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"BigQuery is actually a \",(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Column-oriented_DBMS\",children:\"columnar database\"}),\". It's column-oriented, meaning the data are structured in columns. BigQuery uses \",(0,n.jsx)(e.a,{href:\"http://www.goldsborough.me/distributed-systems/2019/05/18/21-09-00-a_look_at_dremel/\",children:\"Dremel\"}),' as its underlying computing engine. When the data is moved from the cold storage to the active storage in Dremel, it stores the data in a tree structure. Each leaf node is a column-oriented \"record\" in ',(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Protocol_Buffers\",children:\"Protobuf\"}),\" format.\"]}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/optimize-google-cloud-bigquery-and-control-cost/columnar.webp\",alt:\"image from the template\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsx)(e.p,{children:\"In BigQuery, each node is a VM. A query execution propagates from the root server (node) through intermediate servers to the leaf servers to retrieve the selected columns.\"}),`\n`,(0,n.jsx)(e.p,{children:\"We can modify the query to select individual columns:\"}),`\n`,(0,n.jsx)(e.pre,{className:\"language-sql\",children:(0,n.jsxs)(e.code,{className:\"language-sql code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"SELECT\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  session_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  session_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  session_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  user_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  user_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  user_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  query_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  query_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  query_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  impression_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  impression_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  impression_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  ts\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" \",(0,n.jsxs)(e.span,{className:\"token identifier\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"`\"}),\"project.dataset.table\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"`\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WHERE\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  ts \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"BETWEEN\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"TIMESTAMP\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"2022-12-01\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"AND\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"TIMESTAMP\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"2023-02-28\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"AND\"}),\" locale \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"US\"'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"LIMIT\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"Just by selecting all the columns explicitly, I was able to reduce the processed data from 3.08 TB to 2.94TB. That's a \",(0,n.jsx)(e.strong,{children:\"100 GB reduction\"}),\".\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"use-partitioned-table-and-query-only-subsets-of-data\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#use-partitioned-table-and-query-only-subsets-of-data\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Use Partitioned Table and Query Only Subsets of Data\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Google Cloud recommends us to \",(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/creating-partitioned-tables\",children:\"partition tables by date\"}),\". It lets us query only a subset of data.\"]}),`\n`,(0,n.jsx)(e.p,{children:'To optimize the query further, we can narrow down the date range in the where statement because the table is partitioned by the \"ts\" column.'}),`\n`,(0,n.jsx)(e.pre,{className:\"language-sql\",children:(0,n.jsxs)(e.code,{className:\"language-sql code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"SELECT\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  session_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  session_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  session_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  user_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  user_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  user_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  query_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  query_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  query_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  impression_info_1\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  impression_info_2\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  impression_info_3\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`  ts\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" \",(0,n.jsxs)(e.span,{className:\"token identifier\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"`\"}),\"project.dataset.table\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"`\"})]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WHERE\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  ts \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"TIMESTAMP\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:'\"2022-12-01\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"AND\"}),\" locale \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"US\"'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"LIMIT\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"I narrowed down the date range to one day instead of three months. I was able to cut down the processed data to \",(0,n.jsx)(e.strong,{children:\"37.43 GB\"}),\". It's just a fraction of the original query.\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"use-materialized-query-results-in-stages\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#use-materialized-query-results-in-stages\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Use Materialized Query Results in Stages\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Another way to reduce costs is to reduce the dataset you're querying from. BigQuery offers \",(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/writing-results#node.js\",children:\"destination tables\"}),\" to store query results as smaller datasets. Destination tables come with two forms: temporary and permanent. Because temporary tables has a lifetime and it's not designed to be shared and queried, I created a permanent destination table to materialize the query result:\"]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"bq-samples.mjs\"}),(0,n.jsx)(e.pre,{className:\"language-js\",children:(0,n.jsxs)(e.code,{className:\"language-js code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" dataset \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" bigquery\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"dataset\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'materialized_dataset'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" materialzedTable \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" dataset\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"table\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"'materialized_table'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"// ...\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),\"job\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" bigquery\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"createQueryJob\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token literal-property property\",children:\"query\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"q\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"locale\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'2022-12-01'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'2023-02-28'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),\" \",(0,n.jsx)(e.span,{className:\"token number\",children:\"100\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token literal-property property\",children:\"destination\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" materialzedTable\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"The query results will be stored in the destination table. It'll serve as a reference for future queries. Whenever it's possible to query from the destination table, BigQuery will process the data from the table. It'll greatly reduce the data size we look up.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"final-thoughts\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#final-thoughts\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Final Thoughts\"]}),`\n`,(0,n.jsx)(e.p,{children:\"It's a very interesting study to reduce the cost in BigQuery. With only three easy steps:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"Don't use *\"}),`\n`,(0,n.jsx)(e.li,{children:\"Use Partitioned Table and Query Only Subsets of Data\"}),`\n`,(0,n.jsx)(e.li,{children:\"Use Materialized Query Results in Stages\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"I was able to reduce the processed data size \",(0,n.jsx)(e.strong,{children:\"from 3 TB to 37.5 GB\"}),\". It reduces the total cost significantly from $3,000 to $30.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"If you're interested in learning more about the BigQuery architecture, here're the references that helped me:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://cloud.google.com/blog/products/data-analytics/new-blog-series-bigquery-explained-overview\",children:\"BigQuery explained: An overview of BigQuery's architecture\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"http://www.goldsborough.me/distributed-systems/2019/05/18/21-09-00-a_look_at_dremel/\",children:\"A Look at Dremel\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://cloud.google.com/blog/products/storage-data-transfer/a-peek-behind-colossus-googles-file-system\",children:\"Colossus under the hood: a peek into Google\\u2019s scalable storage system\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://cloud.google.com/blog/topics/systems/the-evolution-of-googles-jupiter-data-center-network\",children:\"Jupiter evolving: Reflecting on Google\\u2019s data center network transformation\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"You can read more about \",(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/best-practices-costs\",children:\"BigQuery cost optimizations\"}),\" in the Google Cloud documentation.\"]}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsxs)(e.p,{children:[\"Special thanks to \",(0,n.jsx)(e.a,{href:\"https://www.linkedin.com/in/abunashir/\",children:\"Abu Nashir\"}),\" for collaborating with me on the case study and providing valuable insights that helped me understand BigQuery's architecture.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"references\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#references\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"References\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://www.linkedin.com/in/abunashir/\",children:\"Abu Nashir\"}),\" - LinkedIn\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"http://www.goldsborough.me/distributed-systems/2019/05/18/21-09-00-a_look_at_dremel/\",children:\"A Look at Dremel\"}),\" - Peter Goldsborough\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery\",children:\"BigQuery\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/blog/products/data-analytics/new-blog-series-bigquery-explained-overview\",children:\"BigQuery explained: An overview of BigQuery's architecture\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/blog/products/storage-data-transfer/a-peek-behind-colossus-googles-file-system\",children:\"Colossus under the hood: a peek into Google\\u2019s scalable storage system\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Column-oriented_DBMS\",children:\"Column-oriented DBMS\"}),\" - Wikipedia\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Comma-separated_values\",children:\"Comma-separated values\"}),\" - Wikipedia\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/creating-partitioned-tables\",children:\"Creating partitioned tables\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Modules\",children:\"JavaScript modules\"}),\" - MDN\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/blog/topics/systems/the-evolution-of-googles-jupiter-data-center-network\",children:\"Jupiter evolving: Reflecting on Google\\u2019s data center network transformation\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/reference/rest/v2/jobs/query#QueryRequest\",children:\"Method: jobs.query\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Protocol_Buffers\",children:\"Protocol_Buffers\"}),\" - Wikipedia\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/running-queries#permanent-table\",children:\"Run interactive and batch query jobs\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/cached-results#bq\",children:\"Using cached query results\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/bigquery/docs/writing-results#node.js\",children:\"Writing query results\"}),\" - Google Cloud\"]}),`\n`]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsxs)(e.p,{children:[\"Here you have it! Thanks for reading through \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"raising hands\",children:\"\\u{1F64C}\"}),`\nIf you find this article useful, please share it to help more people in their engineering journey.`]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"bird\",children:\"\\u{1F426}\"}),\" Feel free to connect with me on \",(0,n.jsx)(e.a,{href:\"https://twitter.com/dawchihliou\",children:\"twitter\"}),\"!\"]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"\",\"aria-hidden\":!0,children:\"\\u23ED\\uFE0F\"}),\" Ready for the next article? \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"backhand index pointing right\",children:\"\\u{1F449}\"}),\" \",(0,n.jsx)(e.a,{href:\"/articles/how-to-run-a-tech-community-in-your-company\",children:\"How to Run A Tech Community in Your Company: An Ex-Principal Engineer\\u2019s Guide\"})]}),`\n`,(0,n.jsx)(e.p,{children:\"Happy coding!\"})]})}function b(a={}){let{wrapper:e}=a.components||{};return e?(0,n.jsx)(e,Object.assign({},a,{children:(0,n.jsx)(d,a)})):d(a)}var q=b;return f(_);})();\n;return Component;"},"_id":"articles/optimize-google-cloud-bigquery-and-control-cost.mdx","_raw":{"sourceFilePath":"articles/optimize-google-cloud-bigquery-and-control-cost.mdx","sourceFileName":"optimize-google-cloud-bigquery-and-control-cost.mdx","sourceFileDir":"articles","contentType":"mdx","flattenedPath":"articles/optimize-google-cloud-bigquery-and-control-cost"},"type":"Article","readingTime":{"text":"7 min read","minutes":6.41,"time":384600,"words":1282},"wordCount":1284,"slug":"optimize-google-cloud-bigquery-and-control-cost"}},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"optimize-google-cloud-bigquery-and-control-cost"},"buildId":"GGkAJYd5lItu4-AZArGVU","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>