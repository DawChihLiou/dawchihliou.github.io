<!DOCTYPE html><html lang="en"><head><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/svg" sizes="32x32" href="/favicon.svg"/><link rel="icon" type="image/svg" sizes="16x16" href="/favicon.svg"/><link rel="mask-icon" href="/favicon.svg" color="#ffffff"/><link rel="manifest" href="/site.webmanifest"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="msapplication-TileColor" content="#007cf0"/><meta name="theme-color" content="#ffff"/><title>The Last Dockerfile You Need for NestJS</title><meta name="description" content="The ultimate NestJS Dockfile for optimized production image and local development."/><meta name="robots" content="follow, index"/><link rel="canonical" href="https://dawchihliou.github.io/articles/the-last-dockerfile-you-need-for-nestjs"/><meta itemProp="name" content="The Last Dockerfile You Need for NestJS"/><meta itemProp="description" content="The ultimate NestJS Dockfile for optimized production image and local development."/><meta itemProp="image" content="https://dawchihliou.github.io/optimized/articles/the-last-dockerfile-you-need-for-nestjs/hero.png"/><meta property="og:title" content="The Last Dockerfile You Need for NestJS"/><meta property="og:type" content="website"/><meta property="og:url" content="https://dawchihliou.github.io/articles/the-last-dockerfile-you-need-for-nestjs"/><meta property="og:description" content="The ultimate NestJS Dockfile for optimized production image and local development."/><meta property="og:image" content="https://dawchihliou.github.io/optimized/articles/the-last-dockerfile-you-need-for-nestjs/hero.png"/><meta property="og:image:type" content="image/png"/><meta property="og:image:width" content="1400"/><meta property="og:image:height" content="700"/><meta property="og:image:alt" content="The ultimate NestJS Dockfile for optimized production image and local development."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@dawchihliou"/><meta name="twitter:creator" content="@dawchihliou"/><meta name="twitter:title" content="The Last Dockerfile You Need for NestJS"/><meta name="twitter:description" content="The ultimate NestJS Dockfile for optimized production image and local development."/><meta name="twitter:image" content="https://dawchihliou.github.io/optimized/articles/the-last-dockerfile-you-need-for-nestjs/hero.webp"/><meta property="article:published_time" content="2023-04-27T00:00:00.000Z"/><meta property="article:section" content="Article Section"/><meta property="article:tag" content="Article Tag"/><meta name="next-head-count" content="34"/><link rel="preload" href="/_next/static/css/f4214c3b71874d65.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f4214c3b71874d65.css" data-n-g=""/><link rel="preload" href="/_next/static/css/54ba867c7255694d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/54ba867c7255694d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-59c5c889f52620d6.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-010ff0b6bbe5ac8f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5784eb5f9f6cd23e.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bslug%5D-9a8f919cad4c24e6.js" defer=""></script><script src="/_next/static/XEy_h5b5NJ4hT_RxqMTKh/_buildManifest.js" defer=""></script><script src="/_next/static/XEy_h5b5NJ4hT_RxqMTKh/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div id="outer-container"><header><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div><div class="bm-burger-button" style="z-index:1000"><button id="react-burger-menu-btn" style="position:absolute;left:0;top:0;z-index:1;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-icon" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s" aria-hidden="true"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/"><button class="Nav_button__YJwKE" tabindex="-1">Home</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/articles"><button class="Nav_button__YJwKE" tabindex="-1">Articles</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/work"><button class="Nav_button__YJwKE" tabindex="-1">Work</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/now"><button class="Nav_button__YJwKE" tabindex="-1">Now</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/expertise"><button class="Nav_button__YJwKE" tabindex="-1">Expertise</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/contact"><button class="Nav_button__YJwKE" tabindex="-1">Contact</button></a><span class="bm-item Nav_pusher__93Gc6" style="display:block" tabindex="-1"></span><span class="bm-item Nav_divider__QD8Pt" style="display:block" tabindex="-1"></span><div class="bm-item Nav_profile__Kf2nU" style="display:block" tabindex="-1"><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Linkedin profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M20.45175,20.45025 L16.89225,20.45025 L16.89225,14.88075 C16.89225,13.5525 16.86975,11.844 15.04275,11.844 C13.191,11.844 12.90825,13.2915 12.90825,14.7855 L12.90825,20.45025 L9.3525,20.45025 L9.3525,8.997 L12.765,8.997 L12.765,10.563 L12.81375,10.563 C13.2885,9.66225 14.4495,8.71275 16.18125,8.71275 C19.78575,8.71275 20.45175,11.08425 20.45175,14.169 L20.45175,20.45025 Z M5.33925,7.4325 C4.1955,7.4325 3.27375,6.50775 3.27375,5.36775 C3.27375,4.2285 4.1955,3.30375 5.33925,3.30375 C6.47775,3.30375 7.4025,4.2285 7.4025,5.36775 C7.4025,6.50775 6.47775,7.4325 5.33925,7.4325 L5.33925,7.4325 Z M7.11975,20.45025 L3.5565,20.45025 L3.5565,8.997 L7.11975,8.997 L7.11975,20.45025 Z M23.00025,0 L1.0005,0 C0.44775,0 0,0.44775 0,0.99975 L0,22.9995 C0,23.55225 0.44775,24 1.0005,24 L23.00025,24 C23.55225,24 24,23.55225 24,22.9995 L24,0.99975 C24,0.44775 23.55225,0 23.00025,0 L23.00025,0 Z"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou" aria-label="Link to Daw-Chih&#x27;s GitHub profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://medium.com/@dawchihliou" aria-label="Link to Daw-Chih&#x27;s Medium profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.84593838,5.88685595 C2.87575654,5.59224254 2.76340763,5.30104995 2.54341737,5.10276397 L0.302521008,2.4032473 L0.302521008,2 L7.2605042,2 L12.6386555,13.7949836 L17.3669469,2 L24,2 L24,2.4032473 L22.0840336,4.2402628 C21.9188563,4.36617057 21.8369199,4.57310892 21.8711485,4.77792587 L21.8711485,18.2755093 C21.8369199,18.4803262 21.9188563,18.6872645 22.0840336,18.8131723 L23.9551821,20.6501878 L23.9551821,21.0534351 L14.5434174,21.0534351 L14.5434174,20.6501878 L16.4817928,18.7683671 C16.6722689,18.5779447 16.6722689,18.5219382 16.6722689,18.2307041 L16.6722689,7.32062416 L11.2829132,21.0086299 L10.5546219,21.0086299 L4.28011204,7.32062416 L4.28011204,16.4945003 C4.22779746,16.8801958 4.35589372,17.2685069 4.62745097,17.5474239 L7.14845938,20.6053826 L7.14845938,21.0086299 L0,21.0086299 L0,20.6053826 L2.5210084,17.5474239 C2.79058848,17.2680445 2.91121535,16.8771576 2.84593838,16.4945003 L2.84593838,5.88685595 Z"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/u/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Hackernoon profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M5.701 0v6.223H8.85V4.654h1.576v7.842H12V4.654h1.574v1.569h3.15V0zm11.024 6.223v3.136h1.574V6.223zm1.574 3.136v4.705h1.576v-1.568h1.574v-1.568h-1.574V9.359zm0 4.705h-1.574v3.137h1.574zm-1.574 3.137h-3.15v1.569H8.85V17.2H5.7V24h11.024zm-11.024 0v-3.137H4.125v3.137zm-1.576-3.137V9.36H2.551v4.705zm0-4.705h1.576V6.223H4.125Z"></path></svg><span hidden="">Link to Daw-Chih&#x27;s Hacker Noon profile</span></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Twitter profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M24,4.3086 C23.117,4.7006 22.168,4.9646 21.172,5.0836 C22.188,4.4746 22.969,3.5096 23.337,2.3596 C22.386,2.9246 21.332,3.3336 20.21,3.5556 C19.312,2.5976 18.032,1.9996 16.616,1.9996 C13.897,1.9996 11.692,4.2046 11.692,6.9236 C11.692,7.3096 11.736,7.6856 11.82,8.0456 C7.728,7.8406 4.099,5.8806 1.671,2.9006 C1.247,3.6286 1.004,4.4736 1.004,5.3766 C1.004,7.0846 1.873,8.5926 3.195,9.4756 C2.388,9.4486 1.628,9.2276 0.964,8.8596 L0.964,8.9206 C0.964,11.3066 2.661,13.2966 4.914,13.7486 C4.501,13.8626 4.065,13.9216 3.617,13.9216 C3.299,13.9216 2.991,13.8906 2.69,13.8336 C3.317,15.7896 5.135,17.2136 7.29,17.2536 C5.604,18.5736 3.481,19.3606 1.175,19.3606 C0.777,19.3606 0.385,19.3376 0,19.2926 C2.179,20.6886 4.767,21.5046 7.548,21.5046 C16.605,21.5046 21.557,14.0016 21.557,7.4946 C21.557,7.2816 21.552,7.0696 21.543,6.8586 C22.505,6.1636 23.34,5.2966 24,4.3086"></path></svg></a></div><div class="DarkmodeSwitch_container__uFGHQ" tabindex="-1"><div class="DarkmodeSwitch_wrap__e71_4"></div></div></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><button id="react-burger-cross-btn" style="position:absolute;left:0;top:0;z-index:1;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-cross" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div></div></div></header><div class="Menubar_menubar__gvU4b"><a class="styles_anchor__g18qA Menubar_hireMe__zuAig" href="/contact"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>Hire Me</a><div class="DarkmodeSwitch_container__uFGHQ" tabindex="0"><div class="DarkmodeSwitch_wrap__e71_4"></div></div><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou" aria-label="See more Daw-Chih&#x27;s work on GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a></div><div id="page-wrap"><article><div class="Article_container__q__L3"><div class="Article_wrap__LZypL"><h1>The Last Dockerfile You Need for NestJS</h1><div class="Article_info__bOKys"><div class="Article_author__grS8U"><img alt="Daw-Chih Liou" src="/optimized/raw/portrait-sm.webp" loading="lazy"/><p>Daw-Chih Liou</p></div><p>Apr 27, 2023<!-- --> ¬∑ 7 min read</p></div><img alt="The Last Dockerfile You Need for NestJS" src="/optimized/articles/the-last-dockerfile-you-need-for-nestjs/hero.webp" width="100%" class="rounded centered" loading="lazy"/><div class="article-content"><h2 id="in-this-article"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#in-this-article"><span class="icon icon-link"></span></a>In this article</h2>
<ul>
<li><span role="img" aria-label="ship">üö¢</span> We&#x27;ll write a docker multi-stage build together.</li>
<li><span role="img" aria-label="party popper">üéâ</span> We&#x27;ll discover how to use the docker file in development and production.</li>
<li><span role="img" aria-label="sparkles">‚ú®</span> We&#x27;ll apply some of the best practices recommended by the Docker team.</li>
</ul>
<p>Let&#x27;s go.</p>
<hr/>
<p>This article is also available on</p>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://medium.com/gitconnected/the-last-dockerfile-you-need-for-nestjs-76cbfe1edf48">Level Up Coding</a></li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/the-ultimate-nestjs-dockfile-for-optimized-production-image-and-local-development">Hacker Noon</a></li>
</ul>
<p>Feel free to read it on your favorite platform<span role="img" aria-label="sparkles">‚ú®</span></p>
<hr/>
<p>First, let&#x27;s think about the use cases to design the docker build:</p>
<ul>
<li>To install all the dependencies to support the local dev server.</li>
<li>To run a production server with an optimized bundle.</li>
</ul>
<p>In order to cover both of the use cases, we&#x27;ll use Docker&#x27;s <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/build/building/multi-stage/">multi-stage builds</a> and split the build into 3 stages:</p>
<img src="/optimized/articles/the-last-dockerfile-you-need-for-nestjs/stages.webp" alt="Docker multi-stage build overview" width="100%" class="rounded centered" loading="lazy"/>
<ul>
<li><strong>dev</strong>: to simply install all the dependencies.</li>
<li><strong>build</strong>: to compile a production build with optimized bundle size.</li>
<li><strong>prod</strong>: to serve the production build.</li>
</ul>
<h2 id="the-docker-multi-stage-build"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#the-docker-multi-stage-build"><span class="icon icon-link"></span></a>The Docker Multi-stage Build</h2>
<h3 id="the-dev-stage"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#the-dev-stage"><span class="icon icon-link"></span></a>The &quot;dev&quot; Stage</h3>
<p>It&#x27;s fairly straightforward. All we need to do is to install npm dependencies and apply some of the <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/develop/">best practices</a>:</p>
<ul>
<li>We&#x27;ll use &quot;<a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hub.docker.com/_/node">node:alpine</a>&quot; as the based image to produce minimal image size.</li>
<li>We&#x27;ll install <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/nodejs/docker-node#nodealpine">missing shared libraries</a> from node:alpine.</li>
<li>We&#x27;ll assign a <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/reference/builder/#user">non-root user</a> to Docker to limit its privileges</li>
<li>We&#x27;ll set the environment to &quot;development&quot;.</li>
<li>We&#x27;ll install the dependencies based on <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://classic.yarnpkg.com/lang/en/docs/yarn-lock/">yarn lock file</a> to achieve consistent installation across machines.</li>
</ul>
<div class="rehype-code-title">Dockerfile</div><pre class="language-dockerfile"><code class="language-dockerfile code-highlight"><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token comment"># <span role="img" aria-label="" aria-hidden="true">üßë</span>‚Äç<span role="img" aria-label="laptop computer">üíª</span> Development</span>
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">as</span> dev</span>
</span><span class="code-line"><span class="token comment"># add the missing shared libraries from alpine base image</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line"><span class="token comment"># Create app folder</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set to dev environment</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV development</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Create non-root user for Docker</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 node</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Copy source code into app folder</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> . .</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Install dependencies</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn --frozen-lockfile</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set Docker as a non-root user</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span></code></pre>
<h3 id="the-build-stage"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#the-build-stage"><span class="icon icon-link"></span></a>The &quot;build&quot; Stage</h3>
<p>The build stage is the most interesting stage. The purpose is to compile the source code and generate the least amount of assets.</p>
<ul>
<li>We&#x27;ll use the same base image and best practices <a class="styles_anchor__g18qA undefined" href="/articles/the-last-dockerfile-you-need-for-nestjs#the-dev-stage">as the dev stage</a>.</li>
<li>We&#x27;ll set the environment to &quot;production&quot;.</li>
<li>We&#x27;ll copy the dependencies we installed in the dev stage to run the <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.nestjs.com/cli/scripts">Nest CLI build script</a>.</li>
<li>Once the build is completed, we&#x27;ll install the production-only dependencies and clean the <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://classic.yarnpkg.com/lang/en/docs/cli/cache/">yarn cache</a>. This will minimize the bundle size.</li>
</ul>
<div class="rehype-code-title">Dockerfile</div><pre class="language-dockerfile"><code class="language-dockerfile code-highlight"><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token comment"># <span role="img" aria-label="house with garden">üè°</span> Production Build</span>
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">as</span> build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set to production environment</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Re-create non-root user for Docker</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 node</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># In order to run `yarn build` we need access to the Nest CLI.</span>
</span><span class="code-line"><span class="token comment"># Nest CLI is a dev dependency.</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">dev</span></span> /app/node_modules ./node_modules</span>
</span><span class="code-line"><span class="token comment"># Copy source code</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> . .</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Generate the production build. The build script runs &quot;nest build&quot; to compile the application.</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Install only the production dependencies and clean cache to optimize image size.</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn --frozen-lockfile --production &amp;&amp; yarn cache clean</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set Docker as a non-root user</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span></code></pre>
<h3 id="the-prod-stage"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#the-prod-stage"><span class="icon icon-link"></span></a>The &quot;prod&quot; Stage</h3>
<p>Now that we have the optimized production build, we can complete the docker build by serving the NestJS server.</p>
<ul>
<li>We&#x27;ll use the same base image and best practices as <a class="styles_anchor__g18qA undefined" href="/articles/the-last-dockerfile-you-need-for-nestjs#the-build-stage">the build stage</a>.</li>
<li>We&#x27;ll copy the compiled output and the production-only node_modules from the build stage. These are the necessary files we need to run the server.</li>
<li>Finally, start the server with Node. &quot;nest start&quot; command is not available at this stage because the Nest CLI is a dev dependency.</li>
</ul>
<div class="rehype-code-title">Dockerfile</div><pre class="language-dockerfile"><code class="language-dockerfile code-highlight"><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token comment"># <span role="img" aria-label="rocket">üöÄ</span> Production Server</span>
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">as</span> prod</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set to production environment</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Re-create non-root user for Docker</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 node</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Copy only the necessary files</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/dist dist</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/node_modules node_modules</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set Docker as non-root user</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;node&quot;</span>, <span class="token string">&quot;dist/main.js&quot;</span>]</span>
</span></code></pre>
<h3 id="the-complete-multi-stage-dockerfile"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#the-complete-multi-stage-dockerfile"><span class="icon icon-link"></span></a>The Complete Multi-stage Dockerfile</h3>
<div class="rehype-code-title">Dockerfile</div><pre class="language-dockerfile"><code class="language-dockerfile code-highlight"><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token comment"># <span role="img" aria-label="" aria-hidden="true">üßë</span>‚Äç<span role="img" aria-label="laptop computer">üíª</span> Development</span>
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">as</span> dev</span>
</span><span class="code-line"><span class="token comment"># add the missing shared libraries from alpine base image</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line"><span class="token comment"># Create app folder</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set to dev environment</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV dev</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Create non-root user for Docker</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 node</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Copy source code into app folder</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> . .</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Install dependencies</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn --frozen-lockfile</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set Docker as a non-root user</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token comment"># <span role="img" aria-label="house with garden">üè°</span> Production Build</span>
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">as</span> build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set to production environment</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Re-create non-root user for Docker</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 node</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># In order to run `yarn build` we need access to the Nest CLI.</span>
</span><span class="code-line"><span class="token comment"># Nest CLI is a dev dependency.</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">dev</span></span> /app/node_modules ./node_modules</span>
</span><span class="code-line"><span class="token comment"># Copy source code</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span></span> . .</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Generate the production build. The build script runs &quot;nest build&quot; to compile the application.</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Install only the production dependencies and clean cache to optimize image size.</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn --frozen-lockfile --production &amp;&amp; yarn cache clean</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set Docker as a non-root user</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token comment"># <span role="img" aria-label="rocket">üöÄ</span> Production Server</span>
</span><span class="code-line"><span class="token comment">#</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine <span class="token keyword">as</span> prod</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set to production environment</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Re-create non-root user for Docker</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 node</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Copy only the necessary files</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/dist dist</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">node:node</span> <span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">build</span></span> /app/node_modules node_modules</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Set Docker as non-root user</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> node</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;node&quot;</span>, <span class="token string">&quot;dist/main.js&quot;</span>]</span>
</span></code></pre>
<h2 id="how-to-use-it-in-local-development"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#how-to-use-it-in-local-development"><span class="icon icon-link"></span></a>How to Use It in Local Development</h2>
<p>We are done with the hard part!</p>
<p>To use the docker file for local development, all we need to do is to <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/compose/compose-file/compose-file-v3/">build the docker image with the dev stage</a>. For example, we can build and run the NestJS server with watch mode in a docker compose file:</p>
<div class="rehype-code-title">docker-compose.yml</div><pre class="language-yaml"><code class="language-yaml code-highlight"><span class="code-line"><span class="token key atrule">services</span><span class="token punctuation">:</span>
</span><span class="code-line">  <span class="token key atrule">api</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nestjs
</span><span class="code-line">    <span class="token key atrule">image</span><span class="token punctuation">:</span> nestjs<span class="token punctuation">-</span>dev
</span><span class="code-line">    <span class="token key atrule">restart</span><span class="token punctuation">:</span> unless<span class="token punctuation">-</span>stopped
</span><span class="code-line">    <span class="token key atrule">build</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token key atrule">context</span><span class="token punctuation">:</span> .
</span><span class="code-line">      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile
</span><span class="code-line">      <span class="token comment"># <span role="img" aria-label="sparkles">‚ú®</span> Target the dev stage</span>
</span><span class="code-line">      <span class="token key atrule">target</span><span class="token punctuation">:</span> dev
</span><span class="code-line">    <span class="token comment"># Mount host directory to docker container to support watch mode</span>
</span><span class="code-line">    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/app
</span><span class="code-line">      <span class="token comment"># This ensures that the NestJS container manages the node_modules folder</span>
</span><span class="code-line">      <span class="token comment"># rather than synchronizes it with the host machine</span>
</span><span class="code-line">      <span class="token punctuation">-</span> /app/node_modules
</span><span class="code-line">    <span class="token key atrule">env_file</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> docker.env
</span><span class="code-line">    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> 8082<span class="token punctuation">:</span><span class="token number">8082</span>
</span><span class="code-line">    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> nest
</span><span class="code-line">    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> postgres
</span><span class="code-line">    <span class="token key atrule">command</span><span class="token punctuation">:</span> npx nest start <span class="token punctuation">-</span><span class="token punctuation">-</span>watch
</span><span class="code-line">
</span><span class="code-line">  <span class="token comment"># ...other services</span>
</span></code></pre>
<h2 id="how-to-use-it-in-production"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#how-to-use-it-in-production"><span class="icon icon-link"></span></a>How to Use It in Production</h2>
<p>You can simply build the production image by building all 3 stages. For example, we can run &quot;docker build&quot; in GitHub Actions as part of the deployment workflow.</p>
<div class="rehype-code-title">.github/workflows/ci.yml</div><pre class="language-yaml"><code class="language-yaml code-highlight"><span class="code-line">jobs
</span><span class="code-line">  <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
</span><span class="code-line">    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3
</span><span class="code-line">
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>node@v3
</span><span class="code-line">        <span class="token key atrule">with</span><span class="token punctuation">:</span>
</span><span class="code-line">          <span class="token key atrule">node-version</span><span class="token punctuation">:</span> <span class="token string">&#x27;18.x&#x27;</span>
</span><span class="code-line">
</span><span class="code-line">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build NestJS image
</span><span class="code-line">        <span class="token key atrule">env</span><span class="token punctuation">:</span>
</span><span class="code-line">          <span class="token key atrule">REGISTRY</span><span class="token punctuation">:</span> nestjs<span class="token punctuation">-</span>regiestry
</span><span class="code-line">          <span class="token key atrule">REPOSITORY</span><span class="token punctuation">:</span> nestjs<span class="token punctuation">-</span>example
</span><span class="code-line">          <span class="token key atrule">IMAGE_TAG</span><span class="token punctuation">:</span> example
</span><span class="code-line">        <span class="token comment"># <span role="img" aria-label="sparkles">‚ú®</span> target the production stage</span>
</span><span class="code-line">        <span class="token key atrule">run</span><span class="token punctuation">:</span> docker build . <span class="token punctuation">-</span>t $REGISTRY/$REPOSITORY<span class="token punctuation">:</span>$IMAGE_TAG <span class="token punctuation">-</span><span class="token punctuation">-</span>target prod
</span><span class="code-line">
</span><span class="code-line">      <span class="token comment"># ...rest of the steps</span>
</span></code></pre>
<p>Since the &quot;prod&quot; is the last stage, we don&#x27;t need to specify the target for the build command. Running</p>
<pre class="language-bash"><code class="language-bash code-highlight"><span class="code-line"><span class="token function">docker</span> build <span class="token builtin class-name">.</span> <span class="token parameter variable">-t</span> <span class="token variable">$REGISTRY</span>/<span class="token variable">$REPOSITORY</span><span class="token builtin class-name">:</span><span class="token variable">$IMAGE_TAG</span>
</span></code></pre>
<p>will build the same image.</p>
<h2 id="references"><a class="styles_anchor__g18qA anchor" href="/articles/the-last-dockerfile-you-need-for-nestjs#references"><span class="icon icon-link"></span></a>References</h2>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/compose/compose-file/compose-file-v3/">Compose file version 3 reference</a> - Docker Docs</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/develop/">Develop with Docker</a> - Docker docs</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/build/building/multi-stage/">Multi-stage builds</a> - Docker docs</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hub.docker.com/_/node">Node</a> - Docker Hub</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/nodejs/docker-node#nodealpine">node:alpine</a> - GitHub</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.nestjs.com/cli/scripts">NestCLI and scripts</a> - NestJS</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/reference/builder/#user">USER</a> - Docker Docs</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://classic.yarnpkg.com/lang/en/docs/yarn-lock/">yarn.lock</a> - Yarn</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://classic.yarnpkg.com/lang/en/docs/cli/cache/">yarn cache</a> - Yarn</li>
</ul>
<hr/>
<p><span role="img" aria-label="speech balloon">üí¨</span> Comments on Reddit <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.reddit.com/r/Nestjs_framework/comments/130kvyg/the_last_dockerfile_you_need_for_nestjs/">r/Nestjs_framework</a> and <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.reddit.com/r/javascript/comments/130kx7k/comment/jhx7m9x/?context=3">r/javascript</a>.</p>
<hr/>
<p>Here you have it! Thanks for reading through <span role="img" aria-label="raising hands">üôå</span>
If you find this article useful, please share it to help more people in their engineering journey.</p>
<p><span role="img" aria-label="bird">üê¶</span> Feel free to connect with me on <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou">twitter</a>!</p>
<p><span role="img" aria-label="" aria-hidden="true">‚è≠Ô∏è</span> Ready for the next article? <span role="img" aria-label="backhand index pointing right">üëâ</span> <a class="styles_anchor__g18qA undefined" href="/articles/optimize-google-cloud-bigquery-and-control-cost">Optimize Google Cloud BigQuery and Control Cost</a></p>
<p>Happy coding!</p></div><article class="Author_wrap__s8DeE"><img src="/optimized/raw/portrait-sm.webp" alt="Daw-Chih Liou" class="Author_avatar__j6KIn" loading="lazy"/><div><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://dawchihliou.github.io">Daw-Chih Liou</a><p>Daw-Chih is a software engineer, UX advocate, and creator who is dedicated to Web engineering. His background in Human Centered Computing has led him to work with startups and public companies across North America, Asia, and Europe. He is passionate about meeting business trajectory with user journey and utilizing engineering architecture and performance monitoring to provide optimal user experience.</p></div></article></div></div></article><footer class="Footer_footer__1IwEk"><div class="Footer_wrap__FVCTX"><div class="Footer_resources__fG_vu"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">üíö</span>This site is built with</p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://nextjs.org">Next.js</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://react-icons.github.io/react-icons">React Icons</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://mdxjs.com">MDX</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://unifiedjs.com">unified</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/contentlayerdev/contentlayer">Contentlayer</a></div><div class="Footer_contact__9GJn6"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">ü¶Ñ</span>Where to find me</p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou">Linkedin</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou">GitHub</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou">Twitter</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://medium.com/@dawchihliou">Medium</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/u/dawchihliou">Hacker Noon</a><a class="styles_anchor__g18qA undefined" href="/rss.xml">RSS Feed <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div><div class="Footer_sitemap__92ono"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">üó∫</span>Sitemap</p><a class="styles_anchor__g18qA undefined" href="/">Home</a><a class="styles_anchor__g18qA undefined" href="/articles">Articles</a><a class="styles_anchor__g18qA undefined" href="/work">Work</a><a class="styles_anchor__g18qA undefined" href="/now">Now</a><a class="styles_anchor__g18qA undefined" href="/expertise">Expertise</a><a class="styles_anchor__g18qA undefined" href="/contact">Contact</a></div></div><div class="Footer_copyright__vZZRL">¬© <!-- -->2023<!-- --> <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou">Daw-Chih Liou</a></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"The Last Dockerfile You Need for NestJS","publishedAt":"Apr 27, 2023","description":"The ultimate NestJS Dockfile for optimized production image and local development.","cover":"/optimized/articles/the-last-dockerfile-you-need-for-nestjs/hero.webp","category":"Cloud","coverWidth":"1400","coverHeight":"700","body":{"raw":"\n## In this article\n\n- üö¢ We'll write a docker multi-stage build together.\n- üéâ We'll discover how to use the docker file in development and production.\n- ‚ú® We'll apply some of the best practices recommended by the Docker team.\n\nLet's go.\n\n---\n\nThis article is also available on\n\n- [Level Up Coding](https://medium.com/gitconnected/the-last-dockerfile-you-need-for-nestjs-76cbfe1edf48)\n- [Hacker Noon](https://hackernoon.com/the-ultimate-nestjs-dockfile-for-optimized-production-image-and-local-development)\n\nFeel free to read it on your favorite platform‚ú®\n\n---\n\nFirst, let's think about the use cases to design the docker build:\n\n- To install all the dependencies to support the local dev server.\n- To run a production server with an optimized bundle.\n\nIn order to cover both of the use cases, we'll use Docker's [multi-stage builds][1] and split the build into 3 stages:\n\n\u003cimg\n  src=\"/optimized/articles/the-last-dockerfile-you-need-for-nestjs/stages.webp\"\n  alt=\"Docker multi-stage build overview\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\n- **dev**: to simply install all the dependencies.\n- **build**: to compile a production build with optimized bundle size.\n- **prod**: to serve the production build.\n\n## The Docker Multi-stage Build\n\n### The \"dev\" Stage\n\nIt's fairly straightforward. All we need to do is to install npm dependencies and apply some of the [best practices][2]:\n\n- We'll use \"[node:alpine][3]\" as the based image to produce minimal image size.\n- We'll install [missing shared libraries][4] from node:alpine.\n- We'll assign a [non-root user][5] to Docker to limit its privileges\n- We'll set the environment to \"development\".\n- We'll install the dependencies based on [yarn lock file][6] to achieve consistent installation across machines.\n\n```dockerfile:Dockerfile\n#\n# üßë‚Äçüíª Development\n#\nFROM node:18-alpine as dev\n# add the missing shared libraries from alpine base image\nRUN apk add --no-cache libc6-compat\n# Create app folder\nWORKDIR /app\n\n# Set to dev environment\nENV NODE_ENV development\n\n# Create non-root user for Docker\nRUN addgroup --system --gid 1001 node\nRUN adduser --system --uid 1001 node\n\n# Copy source code into app folder\nCOPY --chown=node:node . .\n\n# Install dependencies\nRUN yarn --frozen-lockfile\n\n# Set Docker as a non-root user\nUSER node\n```\n\n### The \"build\" Stage\n\nThe build stage is the most interesting stage. The purpose is to compile the source code and generate the least amount of assets.\n\n- We'll use the same base image and best practices [as the dev stage](#the-dev-stage).\n- We'll set the environment to \"production\".\n- We'll copy the dependencies we installed in the dev stage to run the [Nest CLI build script][7].\n- Once the build is completed, we'll install the production-only dependencies and clean the [yarn cache][8]. This will minimize the bundle size.\n\n```dockerfile:Dockerfile\n#\n# üè° Production Build\n#\nFROM node:18-alpine as build\n\nWORKDIR /app\nRUN apk add --no-cache libc6-compat\n\n# Set to production environment\nENV NODE_ENV production\n\n# Re-create non-root user for Docker\nRUN addgroup --system --gid 1001 node\nRUN adduser --system --uid 1001 node\n\n# In order to run `yarn build` we need access to the Nest CLI.\n# Nest CLI is a dev dependency.\nCOPY --chown=node:node --from=dev /app/node_modules ./node_modules\n# Copy source code\nCOPY --chown=node:node . .\n\n# Generate the production build. The build script runs \"nest build\" to compile the application.\nRUN yarn build\n\n# Install only the production dependencies and clean cache to optimize image size.\nRUN yarn --frozen-lockfile --production \u0026\u0026 yarn cache clean\n\n# Set Docker as a non-root user\nUSER node\n```\n\n### The \"prod\" Stage\n\nNow that we have the optimized production build, we can complete the docker build by serving the NestJS server.\n\n- We'll use the same base image and best practices as [the build stage](#the-build-stage).\n- We'll copy the compiled output and the production-only node_modules from the build stage. These are the necessary files we need to run the server.\n- Finally, start the server with Node. \"nest start\" command is not available at this stage because the Nest CLI is a dev dependency.\n\n```dockerfile:Dockerfile\n#\n# üöÄ Production Server\n#\nFROM node:18-alpine as prod\n\nWORKDIR /app\nRUN apk add --no-cache libc6-compat\n\n# Set to production environment\nENV NODE_ENV production\n\n# Re-create non-root user for Docker\nRUN addgroup --system --gid 1001 node\nRUN adduser --system --uid 1001 node\n\n# Copy only the necessary files\nCOPY --chown=node:node --from=build /app/dist dist\nCOPY --chown=node:node --from=build /app/node_modules node_modules\n\n# Set Docker as non-root user\nUSER node\n\nCMD [\"node\", \"dist/main.js\"]\n```\n\n### The Complete Multi-stage Dockerfile\n\n```dockerfile:Dockerfile\n#\n# üßë‚Äçüíª Development\n#\nFROM node:18-alpine as dev\n# add the missing shared libraries from alpine base image\nRUN apk add --no-cache libc6-compat\n# Create app folder\nWORKDIR /app\n\n# Set to dev environment\nENV NODE_ENV dev\n\n# Create non-root user for Docker\nRUN addgroup --system --gid 1001 node\nRUN adduser --system --uid 1001 node\n\n# Copy source code into app folder\nCOPY --chown=node:node . .\n\n# Install dependencies\nRUN yarn --frozen-lockfile\n\n# Set Docker as a non-root user\nUSER node\n\n#\n# üè° Production Build\n#\nFROM node:18-alpine as build\n\nWORKDIR /app\nRUN apk add --no-cache libc6-compat\n\n# Set to production environment\nENV NODE_ENV production\n\n# Re-create non-root user for Docker\nRUN addgroup --system --gid 1001 node\nRUN adduser --system --uid 1001 node\n\n# In order to run `yarn build` we need access to the Nest CLI.\n# Nest CLI is a dev dependency.\nCOPY --chown=node:node --from=dev /app/node_modules ./node_modules\n# Copy source code\nCOPY --chown=node:node . .\n\n# Generate the production build. The build script runs \"nest build\" to compile the application.\nRUN yarn build\n\n# Install only the production dependencies and clean cache to optimize image size.\nRUN yarn --frozen-lockfile --production \u0026\u0026 yarn cache clean\n\n# Set Docker as a non-root user\nUSER node\n\n#\n# üöÄ Production Server\n#\nFROM node:18-alpine as prod\n\nWORKDIR /app\nRUN apk add --no-cache libc6-compat\n\n# Set to production environment\nENV NODE_ENV production\n\n# Re-create non-root user for Docker\nRUN addgroup --system --gid 1001 node\nRUN adduser --system --uid 1001 node\n\n# Copy only the necessary files\nCOPY --chown=node:node --from=build /app/dist dist\nCOPY --chown=node:node --from=build /app/node_modules node_modules\n\n# Set Docker as non-root user\nUSER node\n\nCMD [\"node\", \"dist/main.js\"]\n```\n\n## How to Use It in Local Development\n\nWe are done with the hard part!\n\nTo use the docker file for local development, all we need to do is to [build the docker image with the dev stage][9]. For example, we can build and run the NestJS server with watch mode in a docker compose file:\n\n```yaml:docker-compose.yml\nservices:\n  api:\n    container_name: nestjs\n    image: nestjs-dev\n    restart: unless-stopped\n    build:\n      context: .\n      dockerfile: Dockerfile\n      # ‚ú® Target the dev stage\n      target: dev\n    # Mount host directory to docker container to support watch mode\n    volumes:\n      - .:/app\n      # This ensures that the NestJS container manages the node_modules folder\n      # rather than synchronizes it with the host machine\n      - /app/node_modules\n    env_file:\n      - docker.env\n    ports:\n      - 8082:8082\n    networks:\n      - nest\n    depends_on:\n      - postgres\n    command: npx nest start --watch\n\n  # ...other services\n```\n\n## How to Use It in Production\n\nYou can simply build the production image by building all 3 stages. For example, we can run \"docker build\" in GitHub Actions as part of the deployment workflow.\n\n```yaml:.github/workflows/ci.yml\njobs\n  deploy:\n    steps:\n      - uses: actions/checkout@v3\n\n      - uses: actions/setup-node@v3\n        with:\n          node-version: '18.x'\n\n      - name: Build NestJS image\n        env:\n          REGISTRY: nestjs-regiestry\n          REPOSITORY: nestjs-example\n          IMAGE_TAG: example\n        # ‚ú® target the production stage\n        run: docker build . -t $REGISTRY/$REPOSITORY:$IMAGE_TAG --target prod\n\n      # ...rest of the steps\n```\n\nSince the \"prod\" is the last stage, we don't need to specify the target for the build command. Running\n\n```bash\ndocker build . -t $REGISTRY/$REPOSITORY:$IMAGE_TAG\n```\n\nwill build the same image.\n\n## References\n\n- [Compose file version 3 reference][9] - Docker Docs\n- [Develop with Docker][2] - Docker docs\n- [Multi-stage builds][1] - Docker docs\n- [Node][3] - Docker Hub\n- [node:alpine][4] - GitHub\n- [NestCLI and scripts][7] - NestJS\n- [USER][5] - Docker Docs\n- [yarn.lock][6] - Yarn\n- [yarn cache][8] - Yarn\n\n[1]: https://docs.docker.com/build/building/multi-stage/\n[2]: https://docs.docker.com/develop/\n[3]: https://hub.docker.com/_/node\n[4]: https://github.com/nodejs/docker-node#nodealpine\n[5]: https://docs.docker.com/engine/reference/builder/#user\n[6]: https://classic.yarnpkg.com/lang/en/docs/yarn-lock/\n[7]: https://docs.nestjs.com/cli/scripts\n[8]: https://classic.yarnpkg.com/lang/en/docs/cli/cache/\n[9]: https://docs.docker.com/compose/compose-file/compose-file-v3/\n\n---\n\nüí¨ Comments on Reddit [r/Nestjs_framework](https://www.reddit.com/r/Nestjs_framework/comments/130kvyg/the_last_dockerfile_you_need_for_nestjs/) and [r/javascript](https://www.reddit.com/r/javascript/comments/130kx7k/comment/jhx7m9x/?context=3).\n\n---\n\nHere you have it! Thanks for reading through üôå\nIf you find this article useful, please share it to help more people in their engineering journey.\n\nüê¶ Feel free to connect with me on [twitter](https://twitter.com/dawchihliou)!\n\n‚è≠Ô∏è Ready for the next article? üëâ [Optimize Google Cloud BigQuery and Control Cost](/articles/optimize-google-cloud-bigquery-and-control-cost)\n\nHappy coding!\n","code":"var Component=(()=\u003e{var h=Object.create;var l=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var N=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var u=(a,e)=\u003e()=\u003e(e||a((e={exports:{}}).exports,e),e.exports),g=(a,e)=\u003e{for(var s in e)l(a,s,{get:e[s],enumerable:!0})},o=(a,e,s,i)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let c of m(e))!k.call(a,c)\u0026\u0026c!==s\u0026\u0026l(a,c,{get:()=\u003ee[c],enumerable:!(i=p(e,c))||i.enumerable});return a};var y=(a,e,s)=\u003e(s=a!=null?h(N(a)):{},o(e||!a||!a.__esModule?l(s,\"default\",{value:a,enumerable:!0}):s,a)),f=a=\u003eo(l({},\"__esModule\",{value:!0}),a);var r=u((_,d)=\u003e{d.exports=_jsx_runtime});var R={};g(R,{default:()=\u003ev,frontmatter:()=\u003ew});var n=y(r()),w={title:\"The Last Dockerfile You Need for NestJS\",publishedAt:\"Apr 27, 2023\",description:\"The ultimate NestJS Dockfile for optimized production image and local development.\",cover:\"/optimized/articles/the-last-dockerfile-you-need-for-nestjs/hero.webp\",category:\"Cloud\",coverWidth:\"1400\",coverHeight:\"700\"};function t(a){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",ul:\"ul\",li:\"li\",p:\"p\",hr:\"hr\",strong:\"strong\",h3:\"h3\",div:\"div\",pre:\"pre\",code:\"code\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h2,{id:\"in-this-article\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#in-this-article\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"In this article\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"ship\",children:\"\\u{1F6A2}\"}),\" We'll write a docker multi-stage build together.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"party popper\",children:\"\\u{1F389}\"}),\" We'll discover how to use the docker file in development and production.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"}),\" We'll apply some of the best practices recommended by the Docker team.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"Let's go.\"}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsx)(e.p,{children:\"This article is also available on\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://medium.com/gitconnected/the-last-dockerfile-you-need-for-nestjs-76cbfe1edf48\",children:\"Level Up Coding\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://hackernoon.com/the-ultimate-nestjs-dockfile-for-optimized-production-image-and-local-development\",children:\"Hacker Noon\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Feel free to read it on your favorite platform\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"})]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsx)(e.p,{children:\"First, let's think about the use cases to design the docker build:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"To install all the dependencies to support the local dev server.\"}),`\n`,(0,n.jsx)(e.li,{children:\"To run a production server with an optimized bundle.\"}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"In order to cover both of the use cases, we'll use Docker's \",(0,n.jsx)(e.a,{href:\"https://docs.docker.com/build/building/multi-stage/\",children:\"multi-stage builds\"}),\" and split the build into 3 stages:\"]}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/the-last-dockerfile-you-need-for-nestjs/stages.webp\",alt:\"Docker multi-stage build overview\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"dev\"}),\": to simply install all the dependencies.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"build\"}),\": to compile a production build with optimized bundle size.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"prod\"}),\": to serve the production build.\"]}),`\n`]}),`\n`,(0,n.jsxs)(e.h2,{id:\"the-docker-multi-stage-build\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-docker-multi-stage-build\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Docker Multi-stage Build\"]}),`\n`,(0,n.jsxs)(e.h3,{id:\"the-dev-stage\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-dev-stage\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),'The \"dev\" Stage']}),`\n`,(0,n.jsxs)(e.p,{children:[\"It's fairly straightforward. All we need to do is to install npm dependencies and apply some of the \",(0,n.jsx)(e.a,{href:\"https://docs.docker.com/develop/\",children:\"best practices\"}),\":\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[`We'll use \"`,(0,n.jsx)(e.a,{href:\"https://hub.docker.com/_/node\",children:\"node:alpine\"}),'\" as the based image to produce minimal image size.']}),`\n`,(0,n.jsxs)(e.li,{children:[\"We'll install \",(0,n.jsx)(e.a,{href:\"https://github.com/nodejs/docker-node#nodealpine\",children:\"missing shared libraries\"}),\" from node:alpine.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"We'll assign a \",(0,n.jsx)(e.a,{href:\"https://docs.docker.com/engine/reference/builder/#user\",children:\"non-root user\"}),\" to Docker to limit its privileges\"]}),`\n`,(0,n.jsx)(e.li,{children:`We'll set the environment to \"development\".`}),`\n`,(0,n.jsxs)(e.li,{children:[\"We'll install the dependencies based on \",(0,n.jsx)(e.a,{href:\"https://classic.yarnpkg.com/lang/en/docs/yarn-lock/\",children:\"yarn lock file\"}),\" to achieve consistent installation across machines.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"Dockerfile\"}),(0,n.jsx)(e.pre,{className:\"language-dockerfile\",children:(0,n.jsxs)(e.code,{className:\"language-dockerfile code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"\",\"aria-hidden\":!0,children:\"\\u{1F9D1}\"}),\"\\u200D\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"laptop computer\",children:\"\\u{1F4BB}\"}),\" Development\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"as\"}),\" dev\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# add the missing shared libraries from alpine base image\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Create app folder\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set to dev environment\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV development\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Create non-root user for Docker\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" addgroup --system --gid 1001 node\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" adduser --system --uid 1001 node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Copy source code into app folder\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"})]}),\" . .\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Install dependencies\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn --frozen-lockfile\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set Docker as a non-root user\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h3,{id:\"the-build-stage\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-build-stage\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),'The \"build\" Stage']}),`\n`,(0,n.jsx)(e.p,{children:\"The build stage is the most interesting stage. The purpose is to compile the source code and generate the least amount of assets.\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"We'll use the same base image and best practices \",(0,n.jsx)(e.a,{href:\"#the-dev-stage\",children:\"as the dev stage\"}),\".\"]}),`\n`,(0,n.jsx)(e.li,{children:`We'll set the environment to \"production\".`}),`\n`,(0,n.jsxs)(e.li,{children:[\"We'll copy the dependencies we installed in the dev stage to run the \",(0,n.jsx)(e.a,{href:\"https://docs.nestjs.com/cli/scripts\",children:\"Nest CLI build script\"}),\".\"]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Once the build is completed, we'll install the production-only dependencies and clean the \",(0,n.jsx)(e.a,{href:\"https://classic.yarnpkg.com/lang/en/docs/cli/cache/\",children:\"yarn cache\"}),\". This will minimize the bundle size.\"]}),`\n`]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"Dockerfile\"}),(0,n.jsx)(e.pre,{className:\"language-dockerfile\",children:(0,n.jsxs)(e.code,{className:\"language-dockerfile code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"house with garden\",children:\"\\u{1F3E1}\"}),\" Production Build\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"as\"}),\" build\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set to production environment\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV production\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Re-create non-root user for Docker\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" addgroup --system --gid 1001 node\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" adduser --system --uid 1001 node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# In order to run `yarn build` we need access to the Nest CLI.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Nest CLI is a dev dependency.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"dev\"})]}),\" /app/node_modules ./node_modules\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Copy source code\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"})]}),\" . .\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:'# Generate the production build. The build script runs \"nest build\" to compile the application.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn build\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Install only the production dependencies and clean cache to optimize image size.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn --frozen-lockfile --production \u0026\u0026 yarn cache clean\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set Docker as a non-root user\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h3,{id:\"the-prod-stage\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-prod-stage\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),'The \"prod\" Stage']}),`\n`,(0,n.jsx)(e.p,{children:\"Now that we have the optimized production build, we can complete the docker build by serving the NestJS server.\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"We'll use the same base image and best practices as \",(0,n.jsx)(e.a,{href:\"#the-build-stage\",children:\"the build stage\"}),\".\"]}),`\n`,(0,n.jsx)(e.li,{children:\"We'll copy the compiled output and the production-only node_modules from the build stage. These are the necessary files we need to run the server.\"}),`\n`,(0,n.jsx)(e.li,{children:'Finally, start the server with Node. \"nest start\" command is not available at this stage because the Nest CLI is a dev dependency.'}),`\n`]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"Dockerfile\"}),(0,n.jsx)(e.pre,{className:\"language-dockerfile\",children:(0,n.jsxs)(e.code,{className:\"language-dockerfile code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"rocket\",children:\"\\u{1F680}\"}),\" Production Server\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"as\"}),\" prod\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set to production environment\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV production\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Re-create non-root user for Docker\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" addgroup --system --gid 1001 node\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" adduser --system --uid 1001 node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Copy only the necessary files\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"build\"})]}),\" /app/dist dist\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"build\"})]}),\" /app/node_modules node_modules\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set Docker as non-root user\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"CMD\"}),\" [\",(0,n.jsx)(e.span,{className:\"token string\",children:'\"node\"'}),\", \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"dist/main.js\"'}),\"]\"]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h3,{id:\"the-complete-multi-stage-dockerfile\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-complete-multi-stage-dockerfile\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Complete Multi-stage Dockerfile\"]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"Dockerfile\"}),(0,n.jsx)(e.pre,{className:\"language-dockerfile\",children:(0,n.jsxs)(e.code,{className:\"language-dockerfile code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"\",\"aria-hidden\":!0,children:\"\\u{1F9D1}\"}),\"\\u200D\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"laptop computer\",children:\"\\u{1F4BB}\"}),\" Development\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"as\"}),\" dev\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# add the missing shared libraries from alpine base image\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Create app folder\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set to dev environment\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV dev\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Create non-root user for Docker\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" addgroup --system --gid 1001 node\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" adduser --system --uid 1001 node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Copy source code into app folder\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"})]}),\" . .\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Install dependencies\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn --frozen-lockfile\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set Docker as a non-root user\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"house with garden\",children:\"\\u{1F3E1}\"}),\" Production Build\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"as\"}),\" build\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set to production environment\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV production\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Re-create non-root user for Docker\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" addgroup --system --gid 1001 node\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" adduser --system --uid 1001 node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# In order to run `yarn build` we need access to the Nest CLI.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Nest CLI is a dev dependency.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"dev\"})]}),\" /app/node_modules ./node_modules\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Copy source code\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"})]}),\" . .\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:'# Generate the production build. The build script runs \"nest build\" to compile the application.'}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn build\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Install only the production dependencies and clean cache to optimize image size.\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn --frozen-lockfile --production \u0026\u0026 yarn cache clean\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set Docker as a non-root user\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"rocket\",children:\"\\u{1F680}\"}),\" Production Server\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"#\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"as\"}),\" prod\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set to production environment\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV production\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Re-create non-root user for Docker\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" addgroup --system --gid 1001 node\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" adduser --system --uid 1001 node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Copy only the necessary files\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"build\"})]}),\" /app/dist dist\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"node:node\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"build\"})]}),\" /app/node_modules node_modules\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Set Docker as non-root user\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"USER\"}),\" node\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"CMD\"}),\" [\",(0,n.jsx)(e.span,{className:\"token string\",children:'\"node\"'}),\", \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"dist/main.js\"'}),\"]\"]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"how-to-use-it-in-local-development\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#how-to-use-it-in-local-development\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"How to Use It in Local Development\"]}),`\n`,(0,n.jsx)(e.p,{children:\"We are done with the hard part!\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"To use the docker file for local development, all we need to do is to \",(0,n.jsx)(e.a,{href:\"https://docs.docker.com/compose/compose-file/compose-file-v3/\",children:\"build the docker image with the dev stage\"}),\". For example, we can build and run the NestJS server with watch mode in a docker compose file:\"]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"docker-compose.yml\"}),(0,n.jsx)(e.pre,{className:\"language-yaml\",children:(0,n.jsxs)(e.code,{className:\"language-yaml code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"services\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"api\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"container_name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` nestjs\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"image\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" nestjs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`dev\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"restart\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" unless\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`stopped\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"build\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"context\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` .\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"dockerfile\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` Dockerfile\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"}),\" Target the dev stage\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"target\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` dev\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Mount host directory to docker container to support watch mode\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"volumes\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" .\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`/app\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# This ensures that the NestJS container manages the node_modules folder\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# rather than synchronizes it with the host machine\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),` /app/node_modules\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"env_file\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),` docker.env\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"ports\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" 8082\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token number\",children:\"8082\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"networks\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),` nest\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"depends_on\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),` postgres\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"command\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" npx nest start \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`watch\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# ...other services\"}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.h2,{id:\"how-to-use-it-in-production\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#how-to-use-it-in-production\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"How to Use It in Production\"]}),`\n`,(0,n.jsx)(e.p,{children:'You can simply build the production image by building all 3 stages. For example, we can run \"docker build\" in GitHub Actions as part of the deployment workflow.'}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\".github/workflows/ci.yml\"}),(0,n.jsx)(e.pre,{className:\"language-yaml\",children:(0,n.jsxs)(e.code,{className:\"language-yaml code-highlight\",children:[(0,n.jsx)(e.span,{className:\"code-line\",children:`jobs\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"deploy\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"    \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"steps\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"uses\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` actions/checkout@v3\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"uses\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" actions/setup\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`node@v3\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"with\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"node-version\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'18.x'\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\" \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"name\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` Build NestJS image\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"env\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"REGISTRY\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" nestjs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`regiestry\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"REPOSITORY\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" nestjs\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`example\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"          \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"IMAGE_TAG\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),` example\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsxs)(e.span,{className:\"token comment\",children:[\"# \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"}),\" target the production stage\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"        \",(0,n.jsx)(e.span,{className:\"token key atrule\",children:\"run\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\" docker build . \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),\"t $REGISTRY/$REPOSITORY\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\":\"}),\"$IMAGE_TAG \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"-\"}),`target prod\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"      \",(0,n.jsx)(e.span,{className:\"token comment\",children:\"# ...rest of the steps\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:`Since the \"prod\" is the last stage, we don't need to specify the target for the build command. Running`}),`\n`,(0,n.jsx)(e.pre,{className:\"language-bash\",children:(0,n.jsx)(e.code,{className:\"language-bash code-highlight\",children:(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token function\",children:\"docker\"}),\" build \",(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\".\"}),\" \",(0,n.jsx)(e.span,{className:\"token parameter variable\",children:\"-t\"}),\" \",(0,n.jsx)(e.span,{className:\"token variable\",children:\"$REGISTRY\"}),\"/\",(0,n.jsx)(e.span,{className:\"token variable\",children:\"$REPOSITORY\"}),(0,n.jsx)(e.span,{className:\"token builtin class-name\",children:\":\"}),(0,n.jsx)(e.span,{className:\"token variable\",children:\"$IMAGE_TAG\"}),`\n`]})})}),`\n`,(0,n.jsx)(e.p,{children:\"will build the same image.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"references\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#references\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"References\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://docs.docker.com/compose/compose-file/compose-file-v3/\",children:\"Compose file version 3 reference\"}),\" - Docker Docs\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://docs.docker.com/develop/\",children:\"Develop with Docker\"}),\" - Docker docs\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://docs.docker.com/build/building/multi-stage/\",children:\"Multi-stage builds\"}),\" - Docker docs\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://hub.docker.com/_/node\",children:\"Node\"}),\" - Docker Hub\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://github.com/nodejs/docker-node#nodealpine\",children:\"node:alpine\"}),\" - GitHub\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://docs.nestjs.com/cli/scripts\",children:\"NestCLI and scripts\"}),\" - NestJS\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://docs.docker.com/engine/reference/builder/#user\",children:\"USER\"}),\" - Docker Docs\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://classic.yarnpkg.com/lang/en/docs/yarn-lock/\",children:\"yarn.lock\"}),\" - Yarn\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://classic.yarnpkg.com/lang/en/docs/cli/cache/\",children:\"yarn cache\"}),\" - Yarn\"]}),`\n`]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"speech balloon\",children:\"\\u{1F4AC}\"}),\" Comments on Reddit \",(0,n.jsx)(e.a,{href:\"https://www.reddit.com/r/Nestjs_framework/comments/130kvyg/the_last_dockerfile_you_need_for_nestjs/\",children:\"r/Nestjs_framework\"}),\" and \",(0,n.jsx)(e.a,{href:\"https://www.reddit.com/r/javascript/comments/130kx7k/comment/jhx7m9x/?context=3\",children:\"r/javascript\"}),\".\"]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsxs)(e.p,{children:[\"Here you have it! Thanks for reading through \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"raising hands\",children:\"\\u{1F64C}\"}),`\nIf you find this article useful, please share it to help more people in their engineering journey.`]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"bird\",children:\"\\u{1F426}\"}),\" Feel free to connect with me on \",(0,n.jsx)(e.a,{href:\"https://twitter.com/dawchihliou\",children:\"twitter\"}),\"!\"]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"\",\"aria-hidden\":!0,children:\"\\u23ED\\uFE0F\"}),\" Ready for the next article? \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"backhand index pointing right\",children:\"\\u{1F449}\"}),\" \",(0,n.jsx)(e.a,{href:\"/articles/optimize-google-cloud-bigquery-and-control-cost\",children:\"Optimize Google Cloud BigQuery and Control Cost\"})]}),`\n`,(0,n.jsx)(e.p,{children:\"Happy coding!\"})]})}function b(a={}){let{wrapper:e}=a.components||{};return e?(0,n.jsx)(e,Object.assign({},a,{children:(0,n.jsx)(t,a)})):t(a)}var v=b;return f(R);})();\n;return Component;"},"_id":"articles/the-last-dockerfile-you-need-for-nestjs.mdx","_raw":{"sourceFilePath":"articles/the-last-dockerfile-you-need-for-nestjs.mdx","sourceFileName":"the-last-dockerfile-you-need-for-nestjs.mdx","sourceFileDir":"articles","contentType":"mdx","flattenedPath":"articles/the-last-dockerfile-you-need-for-nestjs"},"type":"Article","readingTime":{"text":"7 min read","minutes":6.81,"time":408600,"words":1362},"wordCount":1364,"slug":"the-last-dockerfile-you-need-for-nestjs"}},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"the-last-dockerfile-you-need-for-nestjs"},"buildId":"XEy_h5b5NJ4hT_RxqMTKh","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>