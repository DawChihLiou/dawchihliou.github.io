<!DOCTYPE html><html lang="en"><head><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/><link rel="icon" type="image/svg" sizes="32x32" href="/favicon.svg"/><link rel="icon" type="image/svg" sizes="16x16" href="/favicon.svg"/><link rel="mask-icon" href="/favicon.svg" color="#ffffff"/><link rel="manifest" href="/site.webmanifest"/><meta name="viewport" content="width=device-width, initial-scale=1"/><meta charSet="utf-8"/><meta name="msapplication-TileColor" content="#007cf0"/><meta name="theme-color" content="#ffff"/><title>Lean Docker Images for Next.JS</title><meta name="description" content="Using multi-stage builds to optimize production Docker image for faster deployment."/><meta name="robots" content="follow, index"/><link rel="canonical" href="https://dawchihliou.github.io/articles/lean-docker-images-for-nextjs"/><meta itemProp="name" content="Lean Docker Images for Next.JS"/><meta itemProp="description" content="Using multi-stage builds to optimize production Docker image for faster deployment."/><meta itemProp="image" content="https://dawchihliou.github.io/optimized/articles/next-docker-image/hero.png"/><meta property="og:title" content="Lean Docker Images for Next.JS"/><meta property="og:type" content="website"/><meta property="og:url" content="https://dawchihliou.github.io/articles/lean-docker-images-for-nextjs"/><meta property="og:description" content="Using multi-stage builds to optimize production Docker image for faster deployment."/><meta property="og:image" content="https://dawchihliou.github.io/optimized/articles/next-docker-image/hero.png"/><meta property="og:image:type" content="image/png"/><meta property="og:image:width" content="1400"/><meta property="og:image:height" content="700"/><meta property="og:image:alt" content="Using multi-stage builds to optimize production Docker image for faster deployment."/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@dawchihliou"/><meta name="twitter:creator" content="@dawchihliou"/><meta name="twitter:title" content="Lean Docker Images for Next.JS"/><meta name="twitter:description" content="Using multi-stage builds to optimize production Docker image for faster deployment."/><meta name="twitter:image" content="https://dawchihliou.github.io/optimized/articles/next-docker-image/hero.webp"/><meta property="article:published_time" content="2023-02-02T00:00:00.000Z"/><meta property="article:section" content="Article Section"/><meta property="article:tag" content="Article Tag"/><meta name="next-head-count" content="34"/><link rel="preload" href="/_next/static/css/f4214c3b71874d65.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f4214c3b71874d65.css" data-n-g=""/><link rel="preload" href="/_next/static/css/54ba867c7255694d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/54ba867c7255694d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-e30900c064ac663c.js" defer=""></script><script src="/_next/static/chunks/framework-114634acb84f8baa.js" defer=""></script><script src="/_next/static/chunks/main-010ff0b6bbe5ac8f.js" defer=""></script><script src="/_next/static/chunks/pages/_app-571a343ce648ab47.js" defer=""></script><script src="/_next/static/chunks/pages/articles/%5Bslug%5D-6aa06637217e2cb9.js" defer=""></script><script src="/_next/static/uq5WbnlvphKLLDVJnjp9M/_buildManifest.js" defer=""></script><script src="/_next/static/uq5WbnlvphKLLDVJnjp9M/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div id="outer-container"><header><div><div class="bm-overlay" style="position:fixed;z-index:1000;width:100%;height:100%;background:rgba(0, 0, 0, 0.3);opacity:0;-moz-transform:translate3d(100%, 0, 0);-ms-transform:translate3d(100%, 0, 0);-o-transform:translate3d(100%, 0, 0);-webkit-transform:translate3d(100%, 0, 0);transform:translate3d(100%, 0, 0);transition:opacity 0.3s, transform 0s 0.3s"></div><div><div class="bm-burger-button" style="z-index:1000"><button id="react-burger-menu-btn" style="position:absolute;left:0;top:0;z-index:1;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer">Open Menu</button><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-icon" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div></div><div id="" class="bm-menu-wrap" style="position:fixed;right:inherit;z-index:1100;width:300px;height:100%;-moz-transform:translate3d(-100%, 0, 0);-ms-transform:translate3d(-100%, 0, 0);-o-transform:translate3d(-100%, 0, 0);-webkit-transform:translate3d(-100%, 0, 0);transform:translate3d(-100%, 0, 0);transition:all 0.5s" aria-hidden="true"><div class="bm-menu" style="height:100%;box-sizing:border-box;overflow:auto"><nav class="bm-item-list" style="height:100%"><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/"><button class="Nav_button__YJwKE" tabindex="-1">Home</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/articles"><button class="Nav_button__YJwKE" tabindex="-1">Articles</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/work"><button class="Nav_button__YJwKE" tabindex="-1">Work</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/now"><button class="Nav_button__YJwKE" tabindex="-1">Now</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/expertise"><button class="Nav_button__YJwKE" tabindex="-1">Expertise</button></a><a class="styles_anchor__g18qA bm-item Nav_link__ZgDoZ" style="display:block" tabindex="-1" href="/contact"><button class="Nav_button__YJwKE" tabindex="-1">Contact</button></a><span class="bm-item Nav_pusher__93Gc6" style="display:block" tabindex="-1"></span><span class="bm-item Nav_divider__QD8Pt" style="display:block" tabindex="-1"></span><div class="bm-item Nav_profile__Kf2nU" style="display:block" tabindex="-1"><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Linkedin profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M20.45175,20.45025 L16.89225,20.45025 L16.89225,14.88075 C16.89225,13.5525 16.86975,11.844 15.04275,11.844 C13.191,11.844 12.90825,13.2915 12.90825,14.7855 L12.90825,20.45025 L9.3525,20.45025 L9.3525,8.997 L12.765,8.997 L12.765,10.563 L12.81375,10.563 C13.2885,9.66225 14.4495,8.71275 16.18125,8.71275 C19.78575,8.71275 20.45175,11.08425 20.45175,14.169 L20.45175,20.45025 Z M5.33925,7.4325 C4.1955,7.4325 3.27375,6.50775 3.27375,5.36775 C3.27375,4.2285 4.1955,3.30375 5.33925,3.30375 C6.47775,3.30375 7.4025,4.2285 7.4025,5.36775 C7.4025,6.50775 6.47775,7.4325 5.33925,7.4325 L5.33925,7.4325 Z M7.11975,20.45025 L3.5565,20.45025 L3.5565,8.997 L7.11975,8.997 L7.11975,20.45025 Z M23.00025,0 L1.0005,0 C0.44775,0 0,0.44775 0,0.99975 L0,22.9995 C0,23.55225 0.44775,24 1.0005,24 L23.00025,24 C23.55225,24 24,23.55225 24,22.9995 L24,0.99975 C24,0.44775 23.55225,0 23.00025,0 L23.00025,0 Z"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou" aria-label="Link to Daw-Chih&#x27;s GitHub profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://medium.com/@dawchihliou" aria-label="Link to Daw-Chih&#x27;s Medium profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M2.84593838,5.88685595 C2.87575654,5.59224254 2.76340763,5.30104995 2.54341737,5.10276397 L0.302521008,2.4032473 L0.302521008,2 L7.2605042,2 L12.6386555,13.7949836 L17.3669469,2 L24,2 L24,2.4032473 L22.0840336,4.2402628 C21.9188563,4.36617057 21.8369199,4.57310892 21.8711485,4.77792587 L21.8711485,18.2755093 C21.8369199,18.4803262 21.9188563,18.6872645 22.0840336,18.8131723 L23.9551821,20.6501878 L23.9551821,21.0534351 L14.5434174,21.0534351 L14.5434174,20.6501878 L16.4817928,18.7683671 C16.6722689,18.5779447 16.6722689,18.5219382 16.6722689,18.2307041 L16.6722689,7.32062416 L11.2829132,21.0086299 L10.5546219,21.0086299 L4.28011204,7.32062416 L4.28011204,16.4945003 C4.22779746,16.8801958 4.35589372,17.2685069 4.62745097,17.5474239 L7.14845938,20.6053826 L7.14845938,21.0086299 L0,21.0086299 L0,20.6053826 L2.5210084,17.5474239 C2.79058848,17.2680445 2.91121535,16.8771576 2.84593838,16.4945003 L2.84593838,5.88685595 Z"></path></svg></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/u/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Hackernoon profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" role="img" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><title></title><path d="M5.701 0v6.223H8.85V4.654h1.576v7.842H12V4.654h1.574v1.569h3.15V0zm11.024 6.223v3.136h1.574V6.223zm1.574 3.136v4.705h1.576v-1.568h1.574v-1.568h-1.574V9.359zm0 4.705h-1.574v3.137h1.574zm-1.574 3.137h-3.15v1.569H8.85V17.2H5.7V24h11.024zm-11.024 0v-3.137H4.125v3.137zm-1.576-3.137V9.36H2.551v4.705zm0-4.705h1.576V6.223H4.125Z"></path></svg><span hidden="">Link to Daw-Chih&#x27;s Hacker Noon profile</span></a><a class="styles_anchor__g18qA Nav_iconLink__z5y5Q" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou" aria-label="Link to Daw-Chih&#x27;s Twitter profile" tabindex="-1"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M24,4.3086 C23.117,4.7006 22.168,4.9646 21.172,5.0836 C22.188,4.4746 22.969,3.5096 23.337,2.3596 C22.386,2.9246 21.332,3.3336 20.21,3.5556 C19.312,2.5976 18.032,1.9996 16.616,1.9996 C13.897,1.9996 11.692,4.2046 11.692,6.9236 C11.692,7.3096 11.736,7.6856 11.82,8.0456 C7.728,7.8406 4.099,5.8806 1.671,2.9006 C1.247,3.6286 1.004,4.4736 1.004,5.3766 C1.004,7.0846 1.873,8.5926 3.195,9.4756 C2.388,9.4486 1.628,9.2276 0.964,8.8596 L0.964,8.9206 C0.964,11.3066 2.661,13.2966 4.914,13.7486 C4.501,13.8626 4.065,13.9216 3.617,13.9216 C3.299,13.9216 2.991,13.8906 2.69,13.8336 C3.317,15.7896 5.135,17.2136 7.29,17.2536 C5.604,18.5736 3.481,19.3606 1.175,19.3606 C0.777,19.3606 0.385,19.3376 0,19.2926 C2.179,20.6886 4.767,21.5046 7.548,21.5046 C16.605,21.5046 21.557,14.0016 21.557,7.4946 C21.557,7.2816 21.552,7.0696 21.543,6.8586 C22.505,6.1636 23.34,5.2966 24,4.3086"></path></svg></a></div><div class="DarkmodeSwitch_container__uFGHQ" tabindex="-1"><div class="DarkmodeSwitch_wrap__e71_4"></div></div></nav></div><div><div class="bm-cross-button" style="position:absolute;width:24px;height:24px;right:8px;top:8px"><button id="react-burger-cross-btn" style="position:absolute;left:0;top:0;z-index:1;width:100%;height:100%;margin:0;padding:0;border:none;font-size:0;background:transparent;cursor:pointer" tabindex="-1">Close Menu</button><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="bm-cross" style="width:100%;height:100%" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div></div></div></header><div class="Menubar_menubar__gvU4b"><a class="styles_anchor__g18qA Menubar_hireMe__zuAig" href="/contact"><svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>Hire Me</a><div class="DarkmodeSwitch_container__uFGHQ" tabindex="0"><div class="DarkmodeSwitch_wrap__e71_4"></div></div><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou" aria-label="See more Daw-Chih&#x27;s work on GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1.5em" width="1.5em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M11.9989871,1 C5.92550416,1 1,5.92482888 1,12.0003376 C1,16.8603395 4.15153934,20.9829338 8.52263728,22.4374904 C9.0729918,22.5387827 9.27355045,22.199116 9.27355045,21.9073943 C9.27355045,21.6467356 9.2640965,20.954572 9.25869425,20.0368642 C6.19899322,20.7013414 5.55342398,18.5620492 5.55342398,18.5620492 C5.0530403,17.2911692 4.33183953,16.9528531 4.33183953,16.9528531 C3.33309801,16.2708186 4.40747107,16.2843243 4.40747107,16.2843243 C5.51155652,16.3619816 6.09229872,17.4181221 6.09229872,17.4181221 C7.07348292,19.0988981 8.66714755,18.6133706 9.2938089,18.3317781 C9.39375058,17.6213819 9.67804414,17.1365297 9.99205009,16.86169 C7.54955646,16.5841493 4.98146045,15.6401056 4.98146045,11.4249977 C4.98146045,10.224347 5.41026428,9.24181221 6.11390773,8.47334172 C6.00046042,8.19512569 5.62297799,7.07618404 6.22195279,5.56220265 C6.22195279,5.56220265 7.14506277,5.26642929 9.24653918,6.68992296 C10.12373,6.44547101 11.0650726,6.32392032 12.0003376,6.31919335 C12.9349274,6.32392032 13.8755947,6.44547101 14.7541361,6.68992296 C16.8542619,5.26642929 17.7760214,5.56220265 17.7760214,5.56220265 C18.3763467,7.07618404 17.9988643,8.19512569 17.8860923,8.47334172 C18.5910863,9.24181221 19.0165137,10.224347 19.0165137,11.4249977 C19.0165137,15.6509101 16.444366,16.5807729 13.9944443,16.8529114 C14.3888087,17.192578 14.7406305,17.863808 14.7406305,18.890236 C14.7406305,20.3603241 14.7271248,21.5467939 14.7271248,21.9073943 C14.7271248,22.2018171 14.9256576,22.5441849 15.4834403,22.4368151 C19.8511618,20.9788821 23,16.8589889 23,12.0003376 C23,5.92482888 18.0744958,1 11.9989871,1"></path></svg></a></div><div id="page-wrap"><article><div class="Article_container__q__L3"><div class="Article_wrap__LZypL"><h1>Lean Docker Images for Next.JS</h1><div class="Article_info__bOKys"><div class="Article_author__grS8U"><img alt="Daw-Chih Liou" src="/optimized/raw/portrait-sm.webp" loading="lazy"/><p>Daw-Chih Liou</p></div><p>Feb 2, 2023<!-- --> ¬∑ 6 min read</p></div><img alt="Lean Docker Images for Next.JS" src="/optimized/articles/next-docker-image/hero.webp" width="100%" loading="lazy"/><div class="article-content"><h2 id="in-this-article"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#in-this-article"><span class="icon icon-link"></span></a>In this article</h2>
<ul>
<li><span role="img" aria-label="" aria-hidden="true">üßë</span>‚Äç<span role="img" aria-label="microscope">üî¨</span> We&#x27;ll discuss why and where optimizing docker image can be meaningful.</li>
<li><span role="img" aria-label="see-no-evil monkey">üôà</span> We&#x27;ll explore how to dockerize Next.js project with a hidden feature.</li>
<li>ü™Ñ We&#x27;ll dive into the magic behind the docker image optimization.</li>
</ul>
<hr/>
<p>This article is also available on</p>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://medium.com/gitconnected/lean-docker-images-for-next-js-ea6a3215af8e">Level Up Coding</a></li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/docker-image-optimization-lean-docker-images-for-nextjs">Hacker Noon</a></li>
</ul>
<p>Feel free to read it on your favorite platform<span role="img" aria-label="sparkles">‚ú®</span></p>
<hr/>
<h2 id="the-problem"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#the-problem"><span class="icon icon-link"></span></a>The Problem</h2>
<p>At work, I noticed our deployment pipeline was significantly slower than I expected. The simplified pipeline consist of the following jobs:</p>
<img src="/optimized/articles/next-docker-image/workflow.webp" alt="Next with server component performance" width="100%" class="rounded centered" loading="lazy"/>
<p>After some investigation, we were able to identify the performance bottleneck. The task that consistently took the longest to complete was uploading production images to the <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/artifact-registry">Google Cloud Artifact Registry</a>. It was because we were uploading large, un-optimized Docker images to the registry.</p>
<p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://news.ycombinator.com/item?id=10782897">Image size</a> isn&#x27;t an urgent concern like security or throughput in general. The storage and cost on the cloud are usually generous. However, it becomes problematic when it slows down the pipeline. It increases the <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Time_to_market">time to market</a> and affects our ability to <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://dawchihliou.github.io/articles/ex-principal-engineers-guide-to-design-thinking-and-continous-delivery">continuously deliver</a>.</p>
<h2 id="whats-the-impact-of-optimizing-docker-image"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#whats-the-impact-of-optimizing-docker-image"><span class="icon icon-link"></span></a>What&#x27;s The Impact of Optimizing Docker Image?</h2>
<p>We&#x27;ll use the DALL-E demo I built for my <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://dawchihliou.github.io/articles/is-qwik-faster-than-react-server-component">previous article</a> as an example. The demo looks like this:</p>
<img src="/articles/qwik-vs-next/demo.gif" alt="DALL-E web app demo" width="100%" class="rounded centered" loading="lazy"/>
<blockquote>
<p>You can find <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou/qwik-vs-next">the demo on GitHub</a>. Feel free to take a look at the repo and try it out<span role="img" aria-label="sparkles">‚ú®</span></p>
</blockquote>
<p>We&#x27;ll create two docker files</p>
<ul>
<li><strong>Dockerfile.local</strong>: basic image without optimization</li>
<li><strong>Dockerfile</strong>: optimized image</li>
</ul>
<p>Let&#x27;s build the images based on each docker file. The results are:</p>
<img src="/optimized/articles/next-docker-image/sizes.webp" alt="Next with server component performance" width="100%" class="rounded centered" loading="lazy"/>
<ul>
<li>Un-optimized image: <strong>2.85GB</strong></li>
<li>Optimized image: <strong>202MB</strong></li>
</ul>
<p>It&#x27;s a <strong>92%</strong> reduction in size. We can roughly interpret it as a 92% reduction in uploading time because the file transfer over HTTPS is linear. Now let&#x27;s dive into how you can achieve the same result.</p>
<p>Let&#x27;s go.</p>
<h2 id="before-optimizing-the-image"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#before-optimizing-the-image"><span class="icon icon-link"></span></a>Before Optimizing The Image</h2>
<p>We can start off by creating a straightforward Dockerfile like this:</p>
<div class="rehype-code-title">Dockerfile.local</div><pre class="language-dockerfile"><code class="language-Dockerfile code-highlight"><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> node:18-alpine</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> . ./</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Build the app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn --frozen-lockfile</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Serve the app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">CMD</span> [ <span class="token string">&quot;yarn&quot;</span>, <span class="token string">&quot;start&quot;</span> ]</span>
</span></code></pre>
<p>In this image, we use <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine">Alpine Linux Node 18</a> as the base image because of its much smaller size compared to other base images. We also follow the recommendation and add <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://pkgs.alpinelinux.org/package/edge/main/x86/libc6-compat">libc6-compat</a> to support the use of &quot;process.dlopen&quot;. The rest is just like how we build and serve the project locally:</p>
<ul>
<li>First, we install the dependencies based on yarn.lock file,</li>
<li>we generate the production build,</li>
<li>and lastly, we start the server with the &quot;yarn start&quot; script.</li>
</ul>
<p>Let&#x27;s build the image using this docker file and this is generally what you can see in the command line:</p>
<img src="/optimized/articles/next-docker-image/unopt.webp" alt="Next with server component performance" width="100%" class="rounded centered" loading="lazy"/>
<p>The build was completed in <strong>52.9s</strong>.</p>
<h2 id="the-optimized-docker-image"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#the-optimized-docker-image"><span class="icon icon-link"></span></a>The Optimized Docker Image</h2>
<p>The optimization is based on two features from Docker and Next.js:</p>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/build/building/multi-stage/">Docker Multi-stage builds</a></li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://nextjs.org/docs/advanced-features/output-file-tracing">Next.js Output File Tracing</a></li>
</ul>
<p>The idea is to use a multi-stage build to <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/vercel/next.js/tree/canary/examples/with-docker">select only what we need in production, stage by stage</a>. Let&#x27;s take a look at the docker file.</p>
<div class="rehype-code-title">Dockerfile</div><pre class="language-dockerfile"><code class="language-Dockerfile code-highlight"><span class="code-line"><span class="token instruction"><span class="token keyword">ARG</span> NODE=node:18-alpine</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Stage 1: Install dependencies</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${NODE}</span> <span class="token keyword">AS</span> deps</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> apk add --no-cache libc6-compat</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> package.json yarn.lock* ./</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn --frozen-lockfile</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Stage 2: Build the app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${NODE}</span> <span class="token keyword">AS</span> builder</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">deps</span></span> /app/node_modules ./node_modules</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> . .</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> yarn build</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Stage 3: Run the production</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">FROM</span> <span class="token variable">${NODE}</span> <span class="token keyword">AS</span> runner</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> NODE_ENV production</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> addgroup --system --gid 1001 nodejs</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">RUN</span> adduser --system --uid 1001 nextjs</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># copy assets and the generated standalone server</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span></span> /app/public ./public</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">nextjs:nodejs</span></span> /app/.next/standalone ./</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">COPY</span> <span class="token options"><span class="token property">--from</span><span class="token punctuation">=</span><span class="token string">builder</span> <span class="token property">--chown</span><span class="token punctuation">=</span><span class="token string">nextjs:nodejs</span></span> /app/.next/static ./.next/static</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">USER</span> nextjs</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">EXPOSE</span> 3000</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token instruction"><span class="token keyword">ENV</span> PORT 3000</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token comment"># Serve the app</span>
</span><span class="code-line"><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">&quot;node&quot;</span>, <span class="token string">&quot;server.js&quot;</span>]</span>
</span></code></pre>
<p>We used the same &quot;node:18-alpine&quot; as the base image.</p>
<h4 id="stage-1-install-dependencies"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#stage-1-install-dependencies"><span class="icon icon-link"></span></a>Stage 1: Install dependencies</h4>
<p>Instead of copying everything to the image, we were only copying the &quot;package.json&quot; and &quot;yarn.lock&quot; for the installation.</p>
<h4 id="stage-2-build-the-app"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#stage-2-build-the-app"><span class="icon icon-link"></span></a>Stage 2: Build the app</h4>
<p>In order to build the project, we needed the installed dependencies, source code, and all the project configurations in the project root. So we copied the dependencies <strong>from the previous stage</strong> and everything from the project root.</p>
<h4 id="stage-3-run-the-production"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#stage-3-run-the-production"><span class="icon icon-link"></span></a>Stage 3: Run the production</h4>
<p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://nextjs.org/docs/advanced-features/output-file-tracing">Output file tracing</a> is a Next.js feature that is designed to help us reduce deployment size by tracing all the files that are needed for production in build time.</p>
<p>Once we enable the &quot;standalone&quot; output, Next.js will build and output a standalone Node server in &quot;.next/standalone&quot; directory.</p>
<div class="rehype-code-title">next.config.js</div><pre class="language-js"><code class="language-js code-highlight"><span class="code-line">module<span class="token punctuation">.</span><span class="token property-access">exports</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
</span><span class="code-line">  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token string">&#x27;standalone&#x27;</span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">}</span>
</span></code></pre>
<p>The build result looks like this:</p>
<img src="/optimized/articles/next-docker-image/files.webp" alt="Next with server component performance" width="100%" class="rounded centered" loading="lazy"/>
<p>In this stage, all we did was to copy the standalone server, the assets in the &quot;./public&quot; folder, the JavaScript and CSS chunks from the &quot;.next/static&quot; folder to the working directory and start the server with port 3000.</p>
<p>The magic behind the output file tracing is <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/vercel/nft">@vercel/nft</a>. It statically analyzes the dependency graph and outputs the list of modules in the graph. To illustrate, let&#x27;s log the dependencies for our page, API, and the Node server:</p>
<div class="rehype-code-title">file-tracing.mjs</div><pre class="language-js"><code class="language-js code-highlight"><span class="code-line"><span class="token keyword module">import</span> <span class="token imports"><span class="token punctuation">{</span> nodeFileTrace <span class="token punctuation">}</span></span> <span class="token keyword module">from</span> <span class="token string">&quot;@vercel/nft&quot;</span><span class="token punctuation">;</span>
</span><span class="code-line">
</span><span class="code-line"><span class="token keyword">const</span> files <span class="token operator">=</span> <span class="token punctuation">[</span>
</span><span class="code-line">  <span class="token string">&quot;./.next/server/app/sc/page.js&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token string">&quot;./.next/server/pages/api/images.js&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line">  <span class="token string">&quot;node_modules/next/dist/server/next-server.js&quot;</span><span class="token punctuation">,</span>
</span><span class="code-line"><span class="token punctuation">]</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token keyword">const</span> <span class="token punctuation">{</span> fileList <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword control-flow">await</span> <span class="token function">nodeFileTrace</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="code-line"><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>fileList<span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<p>The output looks like this:</p>
<img src="/optimized/articles/next-docker-image/file-tracing.webp" alt="Next with server component performance" width="100%" class="rounded centered" loading="lazy"/>
<h2 id="final-thoughts"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#final-thoughts"><span class="icon icon-link"></span></a>Final Thoughts</h2>
<p>Now that we explored the stages and the standalone server, let&#x27;s build the image and observe the result:</p>
<img src="/optimized/articles/next-docker-image/opt.webp" alt="Next with server component performance" width="100%" class="rounded centered" loading="lazy"/>
<p>The build was completed in 41.3s. Compared to the un-optimized build, we didn&#x27;t compromise the build time. It&#x27;s a big win considering that we significantly reduced the build size by 92%.</p>
<h2 id="references"><a class="styles_anchor__g18qA anchor" href="/articles/lean-docker-images-for-nextjs#references"><span class="icon icon-link"></span></a>References</h2>
<ul>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/build/building/multi-stage/">Multi-stage builds</a> - Docker docs</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://nextjs.org/docs/advanced-features/output-file-tracing">Output File Tracing</a> - Next.js</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine">nodejs/docker-node</a> - Node.js</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://docs.docker.com/engine/reference/run/">Docker run reference</a> - Docker docs</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou/qwik-vs-next">DawChihLiou/qwik-vs-next</a> - Daw-Chih Liou</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://dawchihliou.github.io/articles/is-qwik-faster-than-react-server-component">Is Qwik Faster than React Server Component?</a> - Daw-Chih Liou</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/vercel/next.js/tree/canary/examples/with-docker">With Docker</a> - Next.js</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://nextjs.org/docs/deployment">Deployment</a> - Next.js</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/vercel/nft">vercel/nft</a> - Vercel</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://pkgs.alpinelinux.org/package/edge/main/x86/libc6-compat">libc6-compat</a> - alpine Linux</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://cloud.google.com/artifact-registry">Artifact Registry</a> - Google Cloud</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://news.ycombinator.com/item?id=10782897">Super small Docker image based on Alpine Linux</a> - Hacker News</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://en.wikipedia.org/wiki/Time_to_market">Time to market</a> - Wikipedia</li>
<li><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://dawchihliou.github.io/articles/ex-principal-engineers-guide-to-design-thinking-and-continous-delivery">Ex-Principal Engineer&#x27;s Guide to Design Thinking and Continuous Delivery</a> - Daw-Chih Liou</li>
</ul>
<hr/>
<p>Here you have it! Thanks for reading through<span role="img" aria-label="raising hands">üôå</span>
If you find this article useful, please share it to help more people in their engineering journey.</p>
<p><span role="img" aria-label="bird">üê¶</span> Feel free to connect with me on <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou">twitter</a>!</p>
<p>‚è≠ Ready for the next article? <span role="img" aria-label="backhand index pointing right">üëâ</span> <a class="styles_anchor__g18qA undefined" href="/articles/is-qwik-faster-than-react-server-component"><strong>Is Qwik Faster than React Server Component?</strong></a></p>
<p>Happy coding!</p></div><article class="Author_wrap__s8DeE"><img src="/optimized/raw/portrait-sm.webp" alt="Daw-Chih Liou" class="Author_avatar__j6KIn" loading="lazy"/><div><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://dawchihliou.github.io">Daw-Chih Liou</a><p>Daw-Chih is a software engineer, UX advocate, and creator who is dedicated to Web engineering. His background in Human Centered Computing has led him to work with startups and public companies across North America, Asia, and Europe. He is passionate about meeting business trajectory with user journey and utilizing engineering architecture and performance monitoring to provide optimal user experience.</p></div></article></div></div></article><footer class="Footer_footer__1IwEk"><div class="Footer_wrap__FVCTX"><div class="Footer_resources__fG_vu"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">üíö</span>This site is built with</p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://nextjs.org">Next.js</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://react-icons.github.io/react-icons">React Icons</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://mdxjs.com">MDX</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://unifiedjs.com">unified</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/contentlayerdev/contentlayer">Contentlayer</a></div><div class="Footer_contact__9GJn6"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">ü¶Ñ</span>Where to find me</p><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou">Linkedin</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://github.com/DawChihLiou">GitHub</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://twitter.com/dawchihliou">Twitter</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://medium.com/@dawchihliou">Medium</a><a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://hackernoon.com/u/dawchihliou">Hacker Noon</a><a class="styles_anchor__g18qA undefined" href="/rss.xml">RSS Feed <svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div><div class="Footer_sitemap__92ono"><p><span role="img" aria-label="build with love" class="Footer_emoji__u15jg">üó∫</span>Sitemap</p><a class="styles_anchor__g18qA undefined" href="/">Home</a><a class="styles_anchor__g18qA undefined" href="/articles">Articles</a><a class="styles_anchor__g18qA undefined" href="/work">Work</a><a class="styles_anchor__g18qA undefined" href="/now">Now</a><a class="styles_anchor__g18qA undefined" href="/expertise">Expertise</a><a class="styles_anchor__g18qA undefined" href="/contact">Contact</a></div></div><div class="Footer_copyright__vZZRL">¬© <!-- -->2023<!-- --> <a class="styles_anchor__g18qA undefined" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/in/dawchihliou">Daw-Chih Liou</a></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"title":"Lean Docker Images for Next.JS","publishedAt":"Feb 2, 2023","description":"Using multi-stage builds to optimize production Docker image for faster deployment.","cover":"/optimized/articles/next-docker-image/hero.webp","category":"Cloud","coverWidth":"1400","coverHeight":"700","body":{"raw":"\n## In this article\n\n- üßë‚Äçüî¨ We'll discuss why and where optimizing docker image can be meaningful.\n- üôà We'll explore how to dockerize Next.js project with a hidden feature.\n- ü™Ñ We'll dive into the magic behind the docker image optimization.\n\n---\n\nThis article is also available on\n\n- [Level Up Coding](https://medium.com/gitconnected/lean-docker-images-for-next-js-ea6a3215af8e)\n- [Hacker Noon](https://hackernoon.com/docker-image-optimization-lean-docker-images-for-nextjs)\n\nFeel free to read it on your favorite platform‚ú®\n\n---\n\n## The Problem\n\nAt work, I noticed our deployment pipeline was significantly slower than I expected. The simplified pipeline consist of the following jobs:\n\n\u003cimg\n  src=\"/optimized/articles/next-docker-image/workflow.webp\"\n  alt=\"Next with server component performance\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\nAfter some investigation, we were able to identify the performance bottleneck. The task that consistently took the longest to complete was uploading production images to the [Google Cloud Artifact Registry][11]. It was because we were uploading large, un-optimized Docker images to the registry.\n\n[Image size][12] isn't an urgent concern like security or throughput in general. The storage and cost on the cloud are usually generous. However, it becomes problematic when it slows down the pipeline. It increases the [time to market][13] and affects our ability to [continuously deliver][14].\n\n## What's The Impact of Optimizing Docker Image?\n\nWe'll use the DALL-E demo I built for my [previous article][6] as an example. The demo looks like this:\n\n\u003cimg\n  src=\"/articles/qwik-vs-next/demo.gif\"\n  alt=\"DALL-E web app demo\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\n\u003e You can find [the demo on GitHub][5]. Feel free to take a look at the repo and try it out‚ú®\n\nWe'll create two docker files\n\n- **Dockerfile.local**: basic image without optimization\n- **Dockerfile**: optimized image\n\nLet's build the images based on each docker file. The results are:\n\n\u003cimg\n  src=\"/optimized/articles/next-docker-image/sizes.webp\"\n  alt=\"Next with server component performance\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\n- Un-optimized image: **2.85GB**\n- Optimized image: **202MB**\n\nIt's a **92%** reduction in size. We can roughly interpret it as a 92% reduction in uploading time because the file transfer over HTTPS is linear. Now let's dive into how you can achieve the same result.\n\nLet's go.\n\n## Before Optimizing The Image\n\nWe can start off by creating a straightforward Dockerfile like this:\n\n```Dockerfile:Dockerfile.local\nFROM node:18-alpine\nRUN apk add --no-cache libc6-compat\nWORKDIR /app\n\nCOPY . ./\n\n# Build the app\nRUN yarn --frozen-lockfile\nRUN yarn build\n\n# Serve the app\nCMD [ \"yarn\", \"start\" ]\n```\n\nIn this image, we use [Alpine Linux Node 18][3] as the base image because of its much smaller size compared to other base images. We also follow the recommendation and add [libc6-compat][10] to support the use of \"process.dlopen\". The rest is just like how we build and serve the project locally:\n\n- First, we install the dependencies based on yarn.lock file,\n- we generate the production build,\n- and lastly, we start the server with the \"yarn start\" script.\n\nLet's build the image using this docker file and this is generally what you can see in the command line:\n\n\u003cimg\n  src=\"/optimized/articles/next-docker-image/unopt.webp\"\n  alt=\"Next with server component performance\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\nThe build was completed in **52.9s**.\n\n## The Optimized Docker Image\n\nThe optimization is based on two features from Docker and Next.js:\n\n- [Docker Multi-stage builds][1]\n- [Next.js Output File Tracing][2]\n\nThe idea is to use a multi-stage build to [select only what we need in production, stage by stage][7]. Let's take a look at the docker file.\n\n```Dockerfile:Dockerfile\nARG NODE=node:18-alpine\n\n# Stage 1: Install dependencies\nFROM ${NODE} AS deps\nRUN apk add --no-cache libc6-compat\nWORKDIR /app\n\nCOPY package.json yarn.lock* ./\nRUN yarn --frozen-lockfile\n\n# Stage 2: Build the app\nFROM ${NODE} AS builder\nWORKDIR /app\nCOPY --from=deps /app/node_modules ./node_modules\nCOPY . .\n\nRUN yarn build\n\n# Stage 3: Run the production\nFROM ${NODE} AS runner\nWORKDIR /app\n\nENV NODE_ENV production\n\nRUN addgroup --system --gid 1001 nodejs\nRUN adduser --system --uid 1001 nextjs\n\n# copy assets and the generated standalone server\nCOPY --from=builder /app/public ./public\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./\nCOPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static\n\nUSER nextjs\n\nEXPOSE 3000\n\nENV PORT 3000\n\n# Serve the app\nCMD [\"node\", \"server.js\"]\n```\n\nWe used the same \"node:18-alpine\" as the base image.\n\n#### Stage 1: Install dependencies\n\nInstead of copying everything to the image, we were only copying the \"package.json\" and \"yarn.lock\" for the installation.\n\n#### Stage 2: Build the app\n\nIn order to build the project, we needed the installed dependencies, source code, and all the project configurations in the project root. So we copied the dependencies **from the previous stage** and everything from the project root.\n\n#### Stage 3: Run the production\n\n[Output file tracing][2] is a Next.js feature that is designed to help us reduce deployment size by tracing all the files that are needed for production in build time.\n\nOnce we enable the \"standalone\" output, Next.js will build and output a standalone Node server in \".next/standalone\" directory.\n\n```js:next.config.js\nmodule.exports = {\n  output: 'standalone',\n}\n```\n\nThe build result looks like this:\n\n\u003cimg\n  src=\"/optimized/articles/next-docker-image/files.webp\"\n  alt=\"Next with server component performance\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\nIn this stage, all we did was to copy the standalone server, the assets in the \"./public\" folder, the JavaScript and CSS chunks from the \".next/static\" folder to the working directory and start the server with port 3000.\n\nThe magic behind the output file tracing is [@vercel/nft][9]. It statically analyzes the dependency graph and outputs the list of modules in the graph. To illustrate, let's log the dependencies for our page, API, and the Node server:\n\n```js:file-tracing.mjs\nimport { nodeFileTrace } from \"@vercel/nft\";\n\nconst files = [\n  \"./.next/server/app/sc/page.js\",\n  \"./.next/server/pages/api/images.js\",\n  \"node_modules/next/dist/server/next-server.js\",\n];\nconst { fileList } = await nodeFileTrace(files);\nconsole.log(fileList);\n```\n\nThe output looks like this:\n\n\u003cimg\n  src=\"/optimized/articles/next-docker-image/file-tracing.webp\"\n  alt=\"Next with server component performance\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\n## Final Thoughts\n\nNow that we explored the stages and the standalone server, let's build the image and observe the result:\n\n\u003cimg\n  src=\"/optimized/articles/next-docker-image/opt.webp\"\n  alt=\"Next with server component performance\"\n  width=\"100%\"\n  className=\"rounded centered\"\n  loading=\"lazy\"\n/\u003e\n\nThe build was completed in 41.3s. Compared to the un-optimized build, we didn't compromise the build time. It's a big win considering that we significantly reduced the build size by 92%.\n\n## References\n\n- [Multi-stage builds][1] - Docker docs\n- [Output File Tracing][2] - Next.js\n- [nodejs/docker-node][3] - Node.js\n- [Docker run reference][4] - Docker docs\n- [DawChihLiou/qwik-vs-next][5] - Daw-Chih Liou\n- [Is Qwik Faster than React Server Component?][6] - Daw-Chih Liou\n- [With Docker][7] - Next.js\n- [Deployment][8] - Next.js\n- [vercel/nft][9] - Vercel\n- [libc6-compat][10] - alpine Linux\n- [Artifact Registry][11] - Google Cloud\n- [Super small Docker image based on Alpine Linux][12] - Hacker News\n- [Time to market][13] - Wikipedia\n- [Ex-Principal Engineer's Guide to Design Thinking and Continuous Delivery][14] - Daw-Chih Liou\n\n[1]: https://docs.docker.com/build/building/multi-stage/\n[2]: https://nextjs.org/docs/advanced-features/output-file-tracing\n[3]: https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine\n[4]: https://docs.docker.com/engine/reference/run/\n[5]: https://github.com/DawChihLiou/qwik-vs-next\n[6]: https://dawchihliou.github.io/articles/is-qwik-faster-than-react-server-component\n[7]: https://github.com/vercel/next.js/tree/canary/examples/with-docker\n[8]: https://nextjs.org/docs/deployment\n[9]: https://github.com/vercel/nft\n[10]: https://pkgs.alpinelinux.org/package/edge/main/x86/libc6-compat\n[11]: https://cloud.google.com/artifact-registry\n[12]: https://news.ycombinator.com/item?id=10782897\n[13]: https://en.wikipedia.org/wiki/Time_to_market\n[14]: https://dawchihliou.github.io/articles/ex-principal-engineers-guide-to-design-thinking-and-continous-delivery\n\n---\n\nHere you have it! Thanks for reading throughüôå\nIf you find this article useful, please share it to help more people in their engineering journey.\n\nüê¶ Feel free to connect with me on [twitter](https://twitter.com/dawchihliou)!\n\n‚è≠ Ready for the next article? üëâ [**Is Qwik Faster than React Server Component?**](/articles/is-qwik-faster-than-react-server-component)\n\nHappy coding!\n","code":"var Component=(()=\u003e{var h=Object.create;var c=Object.defineProperty;var p=Object.getOwnPropertyDescriptor;var m=Object.getOwnPropertyNames;var u=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var N=(a,e)=\u003e()=\u003e(e||a((e={exports:{}}).exports,e),e.exports),g=(a,e)=\u003e{for(var i in e)c(a,i,{get:e[i],enumerable:!0})},t=(a,e,i,l)=\u003e{if(e\u0026\u0026typeof e==\"object\"||typeof e==\"function\")for(let s of m(e))!k.call(a,s)\u0026\u0026s!==i\u0026\u0026c(a,s,{get:()=\u003ee[s],enumerable:!(l=p(e,s))||l.enumerable});return a};var f=(a,e,i)=\u003e(i=a!=null?h(u(a)):{},t(e||!a||!a.__esModule?c(i,\"default\",{value:a,enumerable:!0}):i,a)),w=a=\u003et(c({},\"__esModule\",{value:!0}),a);var o=N((z,r)=\u003e{r.exports=_jsx_runtime});var v={};g(v,{default:()=\u003ex,frontmatter:()=\u003ey});var n=f(o()),y={title:\"Lean Docker Images for Next.JS\",publishedAt:\"Feb 2, 2023\",description:\"Using multi-stage builds to optimize production Docker image for faster deployment.\",cover:\"/optimized/articles/next-docker-image/hero.webp\",category:\"Cloud\",coverWidth:\"1400\",coverHeight:\"700\"};function d(a){let e=Object.assign({h2:\"h2\",a:\"a\",span:\"span\",ul:\"ul\",li:\"li\",hr:\"hr\",p:\"p\",blockquote:\"blockquote\",strong:\"strong\",div:\"div\",pre:\"pre\",code:\"code\",h4:\"h4\"},a.components);return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(e.h2,{id:\"in-this-article\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#in-this-article\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"In this article\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"\",\"aria-hidden\":!0,children:\"\\u{1F9D1}\"}),\"\\u200D\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"microscope\",children:\"\\u{1F52C}\"}),\" We'll discuss why and where optimizing docker image can be meaningful.\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"see-no-evil monkey\",children:\"\\u{1F648}\"}),\" We'll explore how to dockerize Next.js project with a hidden feature.\"]}),`\n`,(0,n.jsx)(e.li,{children:\"\\u{1FA84} We'll dive into the magic behind the docker image optimization.\"}),`\n`]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsx)(e.p,{children:\"This article is also available on\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://medium.com/gitconnected/lean-docker-images-for-next-js-ea6a3215af8e\",children:\"Level Up Coding\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://hackernoon.com/docker-image-optimization-lean-docker-images-for-nextjs\",children:\"Hacker Noon\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"Feel free to read it on your favorite platform\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"})]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsxs)(e.h2,{id:\"the-problem\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-problem\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Problem\"]}),`\n`,(0,n.jsx)(e.p,{children:\"At work, I noticed our deployment pipeline was significantly slower than I expected. The simplified pipeline consist of the following jobs:\"}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/next-docker-image/workflow.webp\",alt:\"Next with server component performance\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"After some investigation, we were able to identify the performance bottleneck. The task that consistently took the longest to complete was uploading production images to the \",(0,n.jsx)(e.a,{href:\"https://cloud.google.com/artifact-registry\",children:\"Google Cloud Artifact Registry\"}),\". It was because we were uploading large, un-optimized Docker images to the registry.\"]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.a,{href:\"https://news.ycombinator.com/item?id=10782897\",children:\"Image size\"}),\" isn't an urgent concern like security or throughput in general. The storage and cost on the cloud are usually generous. However, it becomes problematic when it slows down the pipeline. It increases the \",(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Time_to_market\",children:\"time to market\"}),\" and affects our ability to \",(0,n.jsx)(e.a,{href:\"https://dawchihliou.github.io/articles/ex-principal-engineers-guide-to-design-thinking-and-continous-delivery\",children:\"continuously deliver\"}),\".\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"whats-the-impact-of-optimizing-docker-image\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#whats-the-impact-of-optimizing-docker-image\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"What's The Impact of Optimizing Docker Image?\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"We'll use the DALL-E demo I built for my \",(0,n.jsx)(e.a,{href:\"https://dawchihliou.github.io/articles/is-qwik-faster-than-react-server-component\",children:\"previous article\"}),\" as an example. The demo looks like this:\"]}),`\n`,(0,n.jsx)(\"img\",{src:\"/articles/qwik-vs-next/demo.gif\",alt:\"DALL-E web app demo\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsxs)(e.blockquote,{children:[`\n`,(0,n.jsxs)(e.p,{children:[\"You can find \",(0,n.jsx)(e.a,{href:\"https://github.com/DawChihLiou/qwik-vs-next\",children:\"the demo on GitHub\"}),\". Feel free to take a look at the repo and try it out\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"sparkles\",children:\"\\u2728\"})]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"We'll create two docker files\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Dockerfile.local\"}),\": basic image without optimization\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.strong,{children:\"Dockerfile\"}),\": optimized image\"]}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"Let's build the images based on each docker file. The results are:\"}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/next-docker-image/sizes.webp\",alt:\"Next with server component performance\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[\"Un-optimized image: \",(0,n.jsx)(e.strong,{children:\"2.85GB\"})]}),`\n`,(0,n.jsxs)(e.li,{children:[\"Optimized image: \",(0,n.jsx)(e.strong,{children:\"202MB\"})]}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"It's a \",(0,n.jsx)(e.strong,{children:\"92%\"}),\" reduction in size. We can roughly interpret it as a 92% reduction in uploading time because the file transfer over HTTPS is linear. Now let's dive into how you can achieve the same result.\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Let's go.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"before-optimizing-the-image\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#before-optimizing-the-image\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Before Optimizing The Image\"]}),`\n`,(0,n.jsx)(e.p,{children:\"We can start off by creating a straightforward Dockerfile like this:\"}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"Dockerfile.local\"}),(0,n.jsx)(e.pre,{className:\"language-dockerfile\",children:(0,n.jsxs)(e.code,{className:\"language-Dockerfile code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" node:18-alpine\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" . ./\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Build the app\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn --frozen-lockfile\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn build\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Serve the app\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"CMD\"}),\" [ \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"yarn\"'}),\", \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"start\"'}),\" ]\"]}),`\n`]})]})}),`\n`,(0,n.jsxs)(e.p,{children:[\"In this image, we use \",(0,n.jsx)(e.a,{href:\"https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine\",children:\"Alpine Linux Node 18\"}),\" as the base image because of its much smaller size compared to other base images. We also follow the recommendation and add \",(0,n.jsx)(e.a,{href:\"https://pkgs.alpinelinux.org/package/edge/main/x86/libc6-compat\",children:\"libc6-compat\"}),' to support the use of \"process.dlopen\". The rest is just like how we build and serve the project locally:']}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:\"First, we install the dependencies based on yarn.lock file,\"}),`\n`,(0,n.jsx)(e.li,{children:\"we generate the production build,\"}),`\n`,(0,n.jsx)(e.li,{children:'and lastly, we start the server with the \"yarn start\" script.'}),`\n`]}),`\n`,(0,n.jsx)(e.p,{children:\"Let's build the image using this docker file and this is generally what you can see in the command line:\"}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/next-docker-image/unopt.webp\",alt:\"Next with server component performance\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsxs)(e.p,{children:[\"The build was completed in \",(0,n.jsx)(e.strong,{children:\"52.9s\"}),\".\"]}),`\n`,(0,n.jsxs)(e.h2,{id:\"the-optimized-docker-image\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#the-optimized-docker-image\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"The Optimized Docker Image\"]}),`\n`,(0,n.jsx)(e.p,{children:\"The optimization is based on two features from Docker and Next.js:\"}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://docs.docker.com/build/building/multi-stage/\",children:\"Docker Multi-stage builds\"})}),`\n`,(0,n.jsx)(e.li,{children:(0,n.jsx)(e.a,{href:\"https://nextjs.org/docs/advanced-features/output-file-tracing\",children:\"Next.js Output File Tracing\"})}),`\n`]}),`\n`,(0,n.jsxs)(e.p,{children:[\"The idea is to use a multi-stage build to \",(0,n.jsx)(e.a,{href:\"https://github.com/vercel/next.js/tree/canary/examples/with-docker\",children:\"select only what we need in production, stage by stage\"}),\". Let's take a look at the docker file.\"]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"Dockerfile\"}),(0,n.jsx)(e.pre,{className:\"language-dockerfile\",children:(0,n.jsxs)(e.code,{className:\"language-Dockerfile code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ARG\"}),\" NODE=node:18-alpine\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Stage 1: Install dependencies\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" \",(0,n.jsx)(e.span,{className:\"token variable\",children:\"${NODE}\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"AS\"}),\" deps\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" apk add --no-cache libc6-compat\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" package.json yarn.lock* ./\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn --frozen-lockfile\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Stage 2: Build the app\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" \",(0,n.jsx)(e.span,{className:\"token variable\",children:\"${NODE}\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"AS\"}),\" builder\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"deps\"})]}),\" /app/node_modules ./node_modules\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" . .\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" yarn build\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Stage 3: Run the production\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"FROM\"}),\" \",(0,n.jsx)(e.span,{className:\"token variable\",children:\"${NODE}\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword\",children:\"AS\"}),\" runner\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"WORKDIR\"}),\" /app\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" NODE_ENV production\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" addgroup --system --gid 1001 nodejs\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"RUN\"}),\" adduser --system --uid 1001 nextjs\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# copy assets and the generated standalone server\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"builder\"})]}),\" /app/public ./public\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"builder\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"nextjs:nodejs\"})]}),\" /app/.next/standalone ./\"]}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"COPY\"}),\" \",(0,n.jsxs)(e.span,{className:\"token options\",children:[(0,n.jsx)(e.span,{className:\"token property\",children:\"--from\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"builder\"}),\" \",(0,n.jsx)(e.span,{className:\"token property\",children:\"--chown\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"=\"}),(0,n.jsx)(e.span,{className:\"token string\",children:\"nextjs:nodejs\"})]}),\" /app/.next/static ./.next/static\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"USER\"}),\" nextjs\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"EXPOSE\"}),\" 3000\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"ENV\"}),\" PORT 3000\"]}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token comment\",children:\"# Serve the app\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsxs)(e.span,{className:\"token instruction\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"CMD\"}),\" [\",(0,n.jsx)(e.span,{className:\"token string\",children:'\"node\"'}),\", \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"server.js\"'}),\"]\"]}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:'We used the same \"node:18-alpine\" as the base image.'}),`\n`,(0,n.jsxs)(e.h4,{id:\"stage-1-install-dependencies\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#stage-1-install-dependencies\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 1: Install dependencies\"]}),`\n`,(0,n.jsx)(e.p,{children:'Instead of copying everything to the image, we were only copying the \"package.json\" and \"yarn.lock\" for the installation.'}),`\n`,(0,n.jsxs)(e.h4,{id:\"stage-2-build-the-app\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#stage-2-build-the-app\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 2: Build the app\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"In order to build the project, we needed the installed dependencies, source code, and all the project configurations in the project root. So we copied the dependencies \",(0,n.jsx)(e.strong,{children:\"from the previous stage\"}),\" and everything from the project root.\"]}),`\n`,(0,n.jsxs)(e.h4,{id:\"stage-3-run-the-production\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#stage-3-run-the-production\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Stage 3: Run the production\"]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.a,{href:\"https://nextjs.org/docs/advanced-features/output-file-tracing\",children:\"Output file tracing\"}),\" is a Next.js feature that is designed to help us reduce deployment size by tracing all the files that are needed for production in build time.\"]}),`\n`,(0,n.jsx)(e.p,{children:'Once we enable the \"standalone\" output, Next.js will build and output a standalone Node server in \".next/standalone\" directory.'}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"next.config.js\"}),(0,n.jsx)(e.pre,{className:\"language-js\",children:(0,n.jsxs)(e.code,{className:\"language-js code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"module\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token property-access\",children:\"exports\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token literal-property property\",children:\"output\"}),(0,n.jsx)(e.span,{className:\"token operator\",children:\":\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:\"'standalone'\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"The build result looks like this:\"}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/next-docker-image/files.webp\",alt:\"Next with server component performance\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsx)(e.p,{children:'In this stage, all we did was to copy the standalone server, the assets in the \"./public\" folder, the JavaScript and CSS chunks from the \".next/static\" folder to the working directory and start the server with port 3000.'}),`\n`,(0,n.jsxs)(e.p,{children:[\"The magic behind the output file tracing is \",(0,n.jsx)(e.a,{href:\"https://github.com/vercel/nft\",children:\"@vercel/nft\"}),\". It statically analyzes the dependency graph and outputs the list of modules in the graph. To illustrate, let's log the dependencies for our page, API, and the Node server:\"]}),`\n`,(0,n.jsx)(e.div,{className:\"rehype-code-title\",children:\"file-tracing.mjs\"}),(0,n.jsx)(e.pre,{className:\"language-js\",children:(0,n.jsxs)(e.code,{className:\"language-js code-highlight\",children:[(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"import\"}),\" \",(0,n.jsxs)(e.span,{className:\"token imports\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" nodeFileTrace \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"})]}),\" \",(0,n.jsx)(e.span,{className:\"token keyword module\",children:\"from\"}),\" \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"@vercel/nft\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsx)(e.span,{className:\"code-line\",children:`\n`}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" files \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"[\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"./.next/server/app/sc/page.js\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"./.next/server/pages/api/images.js\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[\"  \",(0,n.jsx)(e.span,{className:\"token string\",children:'\"node_modules/next/dist/server/next-server.js\"'}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\",\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"]\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token keyword\",children:\"const\"}),\" \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"{\"}),\" fileList \",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"}\"}),\" \",(0,n.jsx)(e.span,{className:\"token operator\",children:\"=\"}),\" \",(0,n.jsx)(e.span,{className:\"token keyword control-flow\",children:\"await\"}),\" \",(0,n.jsx)(e.span,{className:\"token function\",children:\"nodeFileTrace\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"files\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]}),(0,n.jsxs)(e.span,{className:\"code-line\",children:[(0,n.jsx)(e.span,{className:\"token console class-name\",children:\"console\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\".\"}),(0,n.jsx)(e.span,{className:\"token method function property-access\",children:\"log\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\"(\"}),\"fileList\",(0,n.jsx)(e.span,{className:\"token punctuation\",children:\")\"}),(0,n.jsx)(e.span,{className:\"token punctuation\",children:\";\"}),`\n`]})]})}),`\n`,(0,n.jsx)(e.p,{children:\"The output looks like this:\"}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/next-docker-image/file-tracing.webp\",alt:\"Next with server component performance\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"final-thoughts\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#final-thoughts\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"Final Thoughts\"]}),`\n`,(0,n.jsx)(e.p,{children:\"Now that we explored the stages and the standalone server, let's build the image and observe the result:\"}),`\n`,(0,n.jsx)(\"img\",{src:\"/optimized/articles/next-docker-image/opt.webp\",alt:\"Next with server component performance\",width:\"100%\",className:\"rounded centered\",loading:\"lazy\"}),`\n`,(0,n.jsx)(e.p,{children:\"The build was completed in 41.3s. Compared to the un-optimized build, we didn't compromise the build time. It's a big win considering that we significantly reduced the build size by 92%.\"}),`\n`,(0,n.jsxs)(e.h2,{id:\"references\",children:[(0,n.jsx)(e.a,{className:\"anchor\",href:\"#references\",children:(0,n.jsx)(e.span,{className:\"icon icon-link\"})}),\"References\"]}),`\n`,(0,n.jsxs)(e.ul,{children:[`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://docs.docker.com/build/building/multi-stage/\",children:\"Multi-stage builds\"}),\" - Docker docs\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://nextjs.org/docs/advanced-features/output-file-tracing\",children:\"Output File Tracing\"}),\" - Next.js\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://github.com/nodejs/docker-node/tree/b4117f9333da4138b03a546ec926ef50a31506c3#nodealpine\",children:\"nodejs/docker-node\"}),\" - Node.js\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://docs.docker.com/engine/reference/run/\",children:\"Docker run reference\"}),\" - Docker docs\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://github.com/DawChihLiou/qwik-vs-next\",children:\"DawChihLiou/qwik-vs-next\"}),\" - Daw-Chih Liou\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://dawchihliou.github.io/articles/is-qwik-faster-than-react-server-component\",children:\"Is Qwik Faster than React Server Component?\"}),\" - Daw-Chih Liou\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://github.com/vercel/next.js/tree/canary/examples/with-docker\",children:\"With Docker\"}),\" - Next.js\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://nextjs.org/docs/deployment\",children:\"Deployment\"}),\" - Next.js\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://github.com/vercel/nft\",children:\"vercel/nft\"}),\" - Vercel\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://pkgs.alpinelinux.org/package/edge/main/x86/libc6-compat\",children:\"libc6-compat\"}),\" - alpine Linux\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://cloud.google.com/artifact-registry\",children:\"Artifact Registry\"}),\" - Google Cloud\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://news.ycombinator.com/item?id=10782897\",children:\"Super small Docker image based on Alpine Linux\"}),\" - Hacker News\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://en.wikipedia.org/wiki/Time_to_market\",children:\"Time to market\"}),\" - Wikipedia\"]}),`\n`,(0,n.jsxs)(e.li,{children:[(0,n.jsx)(e.a,{href:\"https://dawchihliou.github.io/articles/ex-principal-engineers-guide-to-design-thinking-and-continous-delivery\",children:\"Ex-Principal Engineer's Guide to Design Thinking and Continuous Delivery\"}),\" - Daw-Chih Liou\"]}),`\n`]}),`\n`,(0,n.jsx)(e.hr,{}),`\n`,(0,n.jsxs)(e.p,{children:[\"Here you have it! Thanks for reading through\",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"raising hands\",children:\"\\u{1F64C}\"}),`\nIf you find this article useful, please share it to help more people in their engineering journey.`]}),`\n`,(0,n.jsxs)(e.p,{children:[(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"bird\",children:\"\\u{1F426}\"}),\" Feel free to connect with me on \",(0,n.jsx)(e.a,{href:\"https://twitter.com/dawchihliou\",children:\"twitter\"}),\"!\"]}),`\n`,(0,n.jsxs)(e.p,{children:[\"\\u23ED Ready for the next article? \",(0,n.jsx)(e.span,{role:\"img\",\"aria-label\":\"backhand index pointing right\",children:\"\\u{1F449}\"}),\" \",(0,n.jsx)(e.a,{href:\"/articles/is-qwik-faster-than-react-server-component\",children:(0,n.jsx)(e.strong,{children:\"Is Qwik Faster than React Server Component?\"})})]}),`\n`,(0,n.jsx)(e.p,{children:\"Happy coding!\"})]})}function b(a={}){let{wrapper:e}=a.components||{};return e?(0,n.jsx)(e,Object.assign({},a,{children:(0,n.jsx)(d,a)})):d(a)}var x=b;return w(v);})();\n;return Component;"},"_id":"articles/lean-docker-images-for-nextjs.mdx","_raw":{"sourceFilePath":"articles/lean-docker-images-for-nextjs.mdx","sourceFileName":"lean-docker-images-for-nextjs.mdx","sourceFileDir":"articles","contentType":"mdx","flattenedPath":"articles/lean-docker-images-for-nextjs"},"type":"Article","readingTime":{"text":"6 min read","minutes":5.875,"time":352500,"words":1175},"wordCount":1177,"slug":"lean-docker-images-for-nextjs"}},"__N_SSG":true},"page":"/articles/[slug]","query":{"slug":"lean-docker-images-for-nextjs"},"buildId":"uq5WbnlvphKLLDVJnjp9M","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>